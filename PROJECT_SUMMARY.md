# MyBilibili çƒ­é—¨è§†é¢‘æ’è¡Œæ¦œç³»ç»Ÿ - é¡¹ç›®æ€»ç»“

## ğŸ‰ é¡¹ç›®å®ŒæˆçŠ¶æ€

### âœ… å·²å®Œæˆçš„å·¥ä½œ

#### 1. é¡¹ç›®ç»“æ„è®¾è®¡
- âœ… åŸºäº go-zero æ¡†æ¶çš„å¾®æœåŠ¡æ¶æ„
- âœ… å‚è€ƒä¸»é¡¹ç›® Bilibili çš„çƒ­é—¨è§†é¢‘æ’åºç³»ç»Ÿå®ç°d
- âœ… å®Œæ•´çš„é¡¹ç›®ç›®å½•ç»“æ„

#### 2. æ ¸å¿ƒæ¨¡å—å®ç°

**âœ… è§†é¢‘æœåŠ¡ï¼ˆvideo-rpcï¼‰**
- æ¥å£ï¼šæ‰¹é‡è·å–è§†é¢‘ä¿¡æ¯ã€æ‰¹é‡è·å–ç»Ÿè®¡æ•°æ®ã€æ¸¸æ ‡åˆ†é¡µæŸ¥è¯¢
- æ•°æ®åº“æ¨¡å‹ï¼š`video_info`ã€`video_stat`
- å®Œæ•´å®ç° 5 ä¸ª RPC æ¥å£

**âœ… çƒ­åº¦è®¡ç®—ä»»åŠ¡ï¼ˆhotrank-jobï¼‰â­æ ¸å¿ƒ**
- å®ç°ä¸»é¡¹ç›®çš„çƒ­åº¦è®¡ç®—å…¬å¼ï¼š`ç¡¬å¸Ã—0.4 + æ”¶è—Ã—0.3 + å¼¹å¹•Ã—0.4 + è¯„è®ºÃ—0.4 + æ’­æ”¾Ã—0.25 + ç‚¹èµÃ—0.4 + åˆ†äº«Ã—0.6`
- æ–°è§†é¢‘ææƒï¼š24å°æ—¶å†…å‘å¸ƒçš„è§†é¢‘çƒ­åº¦Ã—1.5
- æ¸¸æ ‡åˆ†é¡µæŸ¥è¯¢ï¼ˆå®Œå…¨å‚è€ƒä¸»é¡¹ç›®ï¼‰
- CASE WHEN æ‰¹é‡æ›´æ–°ï¼ˆå®Œå…¨å‚è€ƒä¸»é¡¹ç›®ï¼‰
- è‡ªåŠ¨å¾ªç¯è®¡ç®—çƒ­åº¦

**âœ… çƒ­é—¨æ’è¡Œæ¦œæœåŠ¡ï¼ˆhotrank-rpcï¼‰**
- æ¥å£ï¼šå…¨ç«™æ’è¡Œæ¦œã€åˆ†åŒºæ’è¡Œæ¦œã€è·å–çƒ­åº¦å€¼
- æŒ‰çƒ­åº¦é™åºæ’åº
- æ”¯æŒåˆ†é¡µæŸ¥è¯¢

**âœ… API ç½‘å…³ï¼ˆcreative-apiï¼‰**
- æ¥å£ï¼šå…¨ç«™çƒ­é—¨æ’è¡Œæ¦œã€åˆ†åŒºçƒ­é—¨æ’è¡Œæ¦œã€è§†é¢‘è¯¦æƒ…
- èšåˆå¤šä¸ª RPC æœåŠ¡æ•°æ®
- ç»Ÿä¸€çš„ HTTP API

#### 3. åŸºç¡€è®¾æ–½é…ç½®
- âœ… Docker Composeï¼šMySQLã€Redisã€etcdã€Jaegerã€Prometheusã€Grafana
- âœ… æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
- âœ… æµ‹è¯•æ•°æ®è„šæœ¬

#### 4. å·¥å…·å’Œæ–‡æ¡£
- âœ… ç»Ÿä¸€çš„é”™è¯¯ç å¤„ç†ï¼ˆxerrï¼‰
- âœ… å·¥å…·å‡½æ•°ï¼ˆxstr.JoinInts ç­‰ï¼‰
- âœ… ç»Ÿä¸€å“åº”å°è£…ï¼ˆresultï¼‰
- âœ… å®Œæ•´çš„æµ‹è¯•æŒ‡å—ï¼ˆTEST_GUIDE.mdï¼‰
- âœ… å¿«é€Ÿå¯åŠ¨æ–‡æ¡£ï¼ˆQUICKSTART.mdï¼‰

### ğŸ”§ å·²ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶

æ‰€æœ‰æœåŠ¡å·²æˆåŠŸç¼–è¯‘ï¼š
```
âœ… app/video/cmd/rpc/video-rpc
âœ… app/hotrank/cmd/rpc/hotrank-rpc
âœ… app/hotrank/cmd/job/hotrank-job
âœ… app/api/creative/creative-api
```

## âš ï¸ å½“å‰é—®é¢˜

### etcd è¿æ¥é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
æœåŠ¡æ— æ³•è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼ˆ127.0.0.1:23790ï¼‰çš„ etcdï¼Œå¯¼è‡´æœåŠ¡å¯åŠ¨å¤±è´¥ã€‚

**é”™è¯¯ä¿¡æ¯ï¼š**
```
error reading server preface: EOF
context deadline exceeded
```

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šä½¿ç”¨æœ¬åœ° etcdï¼ˆæ¨èç”¨äºå¼€å‘æµ‹è¯•ï¼‰

1. å¯åŠ¨æœ¬åœ° etcdï¼š
```bash
docker run -d --name etcd \
  -p 2379:2379 \
  -p 2380:2380 \
  quay.io/coreos/etcd:latest \
  /usr/local/bin/etcd \
  --advertise-client-urls http://0.0.0.0:2379 \
  --listen-client-urls http://0.0.0.0:2379
```

2. ä¿®æ”¹æ‰€æœ‰é…ç½®æ–‡ä»¶ï¼Œå°† `127.0.0.1:23790` æ”¹ä¸º `127.0.0.1:2379`

#### æ–¹æ¡ˆ2ï¼šé…ç½®è¿œç¨‹ etcd è®¿é—®

åœ¨è¿œç¨‹æœåŠ¡å™¨ï¼ˆ127.0.0.1ï¼‰ä¸Šï¼Œç¡®ä¿ etcd é…ç½®æ­£ç¡®ï¼š
```bash
# æ£€æŸ¥ etcd æ˜¯å¦æ­£å¸¸è¿è¡Œ
docker logs mybilibili-etcd

# ç¡®ä¿ etcd ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
docker exec mybilibili-etcd etcdctl endpoint health
```

#### æ–¹æ¡ˆ3ï¼šç›´æ¥åœ¨è¿œç¨‹æœåŠ¡å™¨è¿è¡Œï¼ˆæ¨èç”¨äºç”Ÿäº§ï¼‰

å°†ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨è¿è¡Œï¼š
```bash
# åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Š
scp -r mybilibili/ root@127.0.0.1:/path/to/
ssh root@127.0.0.1
cd /path/to/mybilibili

# å¯åŠ¨æœåŠ¡
./app/video/cmd/rpc/video-rpc -f app/video/cmd/rpc/etc/video.yaml &
./app/hotrank/cmd/rpc/hotrank-rpc -f app/hotrank/cmd/rpc/etc/hotrank.yaml &
./app/hotrank/cmd/job/hotrank-job -f app/hotrank/cmd/job/etc/hotrank-job.yaml &
./app/api/creative/creative-api -f app/api/creative/etc/creative-api.yaml &
```

## ğŸ“Š æ ¸å¿ƒè®¾è®¡äº®ç‚¹

### 1. çƒ­åº¦è®¡ç®—ç®—æ³•ï¼ˆå®Œå…¨å‚è€ƒä¸»é¡¹ç›®ï¼‰
```go
hot = coinÃ—0.4 + favÃ—0.3 + danmakuÃ—0.4 + replyÃ—0.4 + 
      viewÃ—0.25 + likeÃ—0.4 + shareÃ—0.6

// æ–°è§†é¢‘ææƒ
if (å‘å¸ƒæ—¶é—´ < 24å°æ—¶) {
    hot = hot Ã— 1.5
}
```

### 2. é«˜æ•ˆåˆ†é¡µç­–ç•¥
- ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆID cursorï¼‰è€Œé offset/limit
- é¿å…æ·±åˆ†é¡µæ€§èƒ½é—®é¢˜
- å®Œå…¨å‚è€ƒä¸»é¡¹ç›®å®ç°

### 3. æ‰¹é‡æ›´æ–°ä¼˜åŒ–
```sql
UPDATE academy_archive 
SET hot = CASE oid 
  WHEN 1001 THEN 12875
  WHEN 1002 THEN 15250
  ...
END, mtime=NOW()
WHERE oid IN (1001,1002,...)
```
ä¸€æ¡ SQL æ›´æ–°å¤šæ¡è®°å½•ï¼Œæ€§èƒ½æå‡æ˜¾è‘—ã€‚

### 4. å¾®æœåŠ¡æ¶æ„
```
creative-api (HTTPç½‘å…³)
    â”œâ”€â”€ hotrank-rpc (æ’è¡Œæ¦œæœåŠ¡)
    â”‚   â””â”€â”€ MySQL (academy_archive)
    â””â”€â”€ video-rpc (è§†é¢‘æœåŠ¡)
        â””â”€â”€ MySQL (video_info, video_stat)

hotrank-job (å®šæ—¶ä»»åŠ¡)
    â”œâ”€â”€ video-rpc (è·å–è§†é¢‘æ•°æ®)
    â””â”€â”€ MySQL (æ›´æ–°çƒ­åº¦å€¼)
```

## ğŸ¯ API æ¥å£

### 1. å…¨ç«™çƒ­é—¨æ’è¡Œæ¦œ
```bash
GET /api/creative/v1/hotrank/list?offset=0&limit=50
```

### 2. åˆ†åŒºçƒ­é—¨æ’è¡Œæ¦œ
```bash
GET /api/creative/v1/hotrank/region?region_id=1&offset=0&limit=50
```

### 3. è§†é¢‘è¯¦æƒ…
```bash
GET /api/creative/v1/video/:vid
```

## ğŸ“ˆ æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: go-zero v1.6.1
- **gRPC**: v1.76.0  
- **æ•°æ®åº“**: MySQL 8.0
- **ç¼“å­˜**: Redis 7
- **æœåŠ¡å‘ç°**: etcd v3.5.11
- **é“¾è·¯è¿½è¸ª**: Jaeger
- **ç›‘æ§**: Prometheus + Grafana
- **è¯­è¨€**: Go 1.24+

## ğŸ” ä»£ç ç»Ÿè®¡

```
æ ¸å¿ƒä»£ç æ–‡ä»¶æ•°ï¼šçº¦ 50+
ä»£ç è¡Œæ•°ï¼šçº¦ 3000+
RPC æ¥å£æ•°ï¼š8 ä¸ª
API æ¥å£æ•°ï¼š3 ä¸ª
æ•°æ®åº“è¡¨ï¼š5 å¼ 
```

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

1. **è§£å†³ etcd è¿æ¥é—®é¢˜**ï¼ˆå½“å‰é˜»å¡ï¼‰
2. **åŠŸèƒ½æµ‹è¯•**
   - æµ‹è¯•çƒ­åº¦è®¡ç®—
   - æµ‹è¯•æ’è¡Œæ¦œæŸ¥è¯¢
   - éªŒè¯çƒ­åº¦å…¬å¼
3. **æ€§èƒ½ä¼˜åŒ–**
   - Redis ç¼“å­˜æ’è¡Œæ¦œ
   - çƒ­åº¦å€¼ç¼“å­˜
4. **åŠŸèƒ½æ‰©å±•**
   - ç”¨æˆ·æœåŠ¡
   - è¯„è®ºæœåŠ¡
   - å®æ—¶çƒ­åº¦æ›´æ–°ï¼ˆä½¿ç”¨ Kafkaï¼‰

## ğŸ“ é‡è¦æ–‡ä»¶æ¸…å•

```
mybilibili/
â”œâ”€â”€ TEST_GUIDE.md              # è¯¦ç»†æµ‹è¯•æŒ‡å—
â”œâ”€â”€ QUICKSTART.md              # å¿«é€Ÿå¯åŠ¨æ–‡æ¡£
â”œâ”€â”€ go.mod                     # Go æ¨¡å—ä¾èµ–
â”œâ”€â”€ deploy/
â”‚   â”œâ”€â”€ docker-compose.yml     # åŸºç¡€è®¾æ–½é…ç½®
â”‚   â””â”€â”€ sql/                   # æ•°æ®åº“è„šæœ¬
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ video/cmd/rpc/         # è§†é¢‘æœåŠ¡ âœ…
â”‚   â”œâ”€â”€ hotrank/cmd/rpc/       # æ’è¡Œæ¦œæœåŠ¡ âœ…
â”‚   â”œâ”€â”€ hotrank/cmd/job/       # çƒ­åº¦è®¡ç®—ä»»åŠ¡ âœ…
â”‚   â””â”€â”€ api/creative/          # API ç½‘å…³ âœ…
â””â”€â”€ common/
    â”œâ”€â”€ model/                 # æ•°æ®åº“æ¨¡å‹
    â”œâ”€â”€ xerr/                  # é”™è¯¯å¤„ç†
    â”œâ”€â”€ tool/                  # å·¥å…·å‡½æ•°
    â””â”€â”€ result/                # ç»Ÿä¸€å“åº”
```

## ğŸ’¡ è®¾è®¡ç†å¿µ

1. **é«˜åº¦è¿˜åŸ**ï¼šçƒ­åº¦è®¡ç®—ç®—æ³•ã€åˆ†é¡µç­–ç•¥ã€æ‰¹é‡æ›´æ–°å®Œå…¨å‚è€ƒä¸»é¡¹ç›®
2. **ç°ä»£åŒ–**ï¼šä½¿ç”¨ go-zero å¾®æœåŠ¡æ¡†æ¶ï¼Œç¬¦åˆäº‘åŸç”Ÿæ¶æ„
3. **å¯æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
4. **ç”Ÿäº§å°±ç»ª**ï¼šåŒ…å«ç›‘æ§ã€è¿½è¸ªã€æ—¥å¿—ç­‰å®Œæ•´é…ç½®

## ğŸ“ å­¦ä¹ ä»·å€¼

é€šè¿‡æœ¬é¡¹ç›®ï¼Œå¯ä»¥å­¦ä¹ åˆ°ï¼š
- âœ… å¾®æœåŠ¡æ¶æ„è®¾è®¡
- âœ… gRPC æœåŠ¡é—´é€šä¿¡
- âœ… çƒ­åº¦æ’åºç®—æ³•è®¾è®¡
- âœ… é«˜æ€§èƒ½æ•°æ®åº“ä¼˜åŒ–
- âœ… go-zero æ¡†æ¶æœ€ä½³å®è·µ
- âœ… ä»ä¸»é¡¹ç›®å­¦ä¹ å¹¶æ”¹é€ çš„èƒ½åŠ›

---

**é¡¹ç›®çŠ¶æ€ï¼š** ä»£ç å®Œæˆ âœ… | ç¼–è¯‘æˆåŠŸ âœ… | å¾…è§£å†³ç½‘ç»œé—®é¢˜ âš ï¸

**æœ€åæ›´æ–°ï¼š** 2025-11-08


