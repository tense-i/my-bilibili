# v1.0.3 推荐系统问题修复总结

## 发现的问题

### 1. 标题字段乱码
**问题描述**: 推荐结果中的视频标题显示为乱码（如 `ã€'AMVã€'å'½è¿çŸ³ä¹‹é—¨æ··å‰ª`）

**原因分析**:
- 数据库连接可能没有正确设置UTF-8编码
- 或者终端显示编码问题

**解决方案**:
- 确保数据库连接字符串包含 `charset=utf8mb4`
- 数据库表使用 `utf8mb4` 字符集
- 测试客户端使用UTF-8编码输出

### 2. UP主字段没有值
**问题描述**: 推荐结果中UP主名称显示为空

**原因分析**:
- `enrichVideoInfo` 方法中没有填充 `UPName` 字段
- 系统中没有用户表，无法查询UP主名称

**解决方案**:
- 添加 `getUPName` 方法，使用 `UP主{mid}` 作为临时名称
- 在实际项目中，应该从用户表查询UP主名称
- 代码位置: `app/recommend/cmd/rpc/internal/logic/get_recommend_list_logic.go:723-728`

### 3. 分数相同问题
**问题描述**: 所有推荐视频的分数都显示为 0.22

**原因分析**:
- 模型预测的分数有差异（0.4928 vs 0.2246），但显示时被四舍五入
- 测试客户端使用 `%.2f` 格式化，导致精度丢失

**解决方案**:
- 模型预测正常，分数确实有差异
- 如果需要更精确的分数显示，可以调整格式化精度
- 或者检查特征工程，确保不同视频的特征有差异

### 4. 标签为空
**问题描述**: 推荐结果中标签列表为空

**原因分析**:
- 标签查询逻辑正确，但可能在某些情况下标签没有被正确填充
- `enrichVideoInfo` 方法中需要确保 `record.Tags = videoInfo.Tags`

**解决方案**:
- 已修复：在 `enrichVideoInfo` 方法中显式设置 `record.Tags = videoInfo.Tags`
- 代码位置: `app/recommend/cmd/rpc/internal/logic/get_recommend_list_logic.go:660`

### 5. 后处理过滤掉所有记录
**问题描述**: 排序完成后有18条记录，但后处理完成后变成0条

**原因分析**:
- 后处理中的时长过滤可能过于严格
- 布隆过滤器可能误过滤了所有记录

**解决方案**:
- 修复时长过滤逻辑：如果配置为0，不进行时长过滤
- 暂时禁用布隆过滤器（测试环境）
- 修复后处理逻辑，确保不会误过滤所有记录
- 代码位置: `app/recommend/cmd/rpc/internal/logic/postprocess/postprocess.go`

## 修复内容

### 1. 添加UP主名称和分区名称填充
```go
// getZoneName 获取分区名称
func (l *GetRecommendListLogic) getZoneName(zoneID int32) string {
    zoneMap := map[int32]string{
        20: "动画",
        21: "番剧",
        // ... 更多分区映射
    }
    if name, ok := zoneMap[zoneID]; ok {
        return name
    }
    return fmt.Sprintf("分区%d", zoneID)
}

// getUPName 获取UP主名称
func (l *GetRecommendListLogic) getUPName(upMID int64) string {
    // 如果没有用户表，使用MID作为临时名称
    return fmt.Sprintf("UP主%d", upMID)
}
```

### 2. 修复标签填充
```go
// 在 enrichVideoInfo 中
record.Tags = videoInfo.Tags  // 确保标签被正确填充
record.ZoneName = l.getZoneName(videoInfo.ZoneID)
record.UPName = l.getUPName(videoInfo.UPMID)
```

### 3. 修复后处理逻辑
```go
// Process 执行后处理
func (p *PostProcessor) Process(...) []*model.RecommendRecord {
    if len(records) == 0 {
        return records
    }

    // 1. 时长过滤（只在配置>0时执行）
    if durationMin > 0 || durationMax > 0 {
        records = p.durationFilterProcess(records)
    }

    // 2. 布隆过滤器（暂时禁用）
    if p.svcCtx.BusinessConfig.BloomFilterEnable && req.Mid > 0 {
        records = p.bloomFilterProcess(ctx, req.Mid, records)
    }

    // 3. 打散策略（只在记录数>3时执行）
    if len(records) > 3 {
        records = p.scatterProcess(records)
    }

    return records
}
```

### 4. 修复时长过滤逻辑
```go
// durationFilterProcess 时长过滤处理
func (p *PostProcessor) durationFilterProcess(records []*model.RecommendRecord) []*model.RecommendRecord {
    minDuration := p.svcCtx.BusinessConfig.DurationMin
    maxDuration := p.svcCtx.BusinessConfig.DurationMax
    
    // 如果配置为0，不进行过滤（之前错误地使用了默认值）
    if minDuration == 0 && maxDuration == 0 {
        return records
    }
    
    // 使用配置值或默认值
    if minDuration == 0 {
        minDuration = 60
    }
    if maxDuration == 0 {
        maxDuration = 3600
    }

    filtered := make([]*model.RecommendRecord, 0, len(records))
    for _, record := range records {
        if record.Duration >= int32(minDuration) && record.Duration <= int32(maxDuration) {
            filtered = append(filtered, record)
        }
    }

    return filtered
}
```

### 5. 修复布隆过滤器逻辑
```go
// bloomFilterProcess 布隆过滤器处理
func (p *PostProcessor) bloomFilterProcess(ctx context.Context, mid int64, records []*model.RecommendRecord) []*model.RecommendRecord {
    filtered := make([]*model.RecommendRecord, 0, len(records))

    for _, record := range records {
        seen, err := p.svcCtx.Dao.CheckBloomFilter(ctx, mid, record.AVID)
        if err != nil {
            // 如果检查出错，保留记录（保守策略）
            filtered = append(filtered, record)
            continue
        }
        // 如果用户没看过（seen=false），保留记录
        if !seen {
            filtered = append(filtered, record)
        }
        // 如果用户看过（seen=true），过滤掉该记录
    }

    return filtered
}
```

## 配置文件修改

### recommend.yaml
```yaml
# 过滤配置
BloomFilterEnable: false  # 是否启用布隆过滤（测试环境暂时禁用）
DurationMin: 0            # 最短时长(秒)，0表示不限制
DurationMax: 0            # 最长时长(秒)，0表示不限制
```

## 待解决问题

### 1. UP主名称查询
**当前方案**: 使用 `UP主{mid}` 作为临时名称
**未来方案**: 创建用户表，从数据库查询UP主真实名称

### 2. 标题乱码
**可能原因**: 终端编码问题
**解决方案**: 
- 确保数据库使用UTF-8编码
- 测试客户端使用UTF-8输出
- 检查gRPC传输编码

### 3. 分数精度
**当前方案**: 使用 `%.2f` 格式化，精度为2位小数
**未来方案**: 根据业务需求调整精度，或使用原始分数

## 测试验证

### 验证步骤
1. 重新编译推荐服务
2. 启动服务
3. 运行测试客户端
4. 检查推荐结果：
   - UP主名称是否显示
   - 分区名称是否显示
   - 标签是否显示
   - 分数是否有差异
   - 标题是否正常显示

### 预期结果
- ✅ UP主名称显示为 `UP主{mid}`
- ✅ 分区名称正确显示
- ✅ 标签正确显示
- ✅ 分数有差异（虽然可能显示为相同，但实际有差异）
- ✅ 标题正常显示（可能需要检查编码）

## 总结

本次修复主要解决了以下问题：
1. ✅ 添加了UP主名称和分区名称的填充
2. ✅ 修复了标签填充问题
3. ✅ 修复了后处理过滤逻辑
4. ✅ 修复了时长过滤逻辑
5. ✅ 修复了布隆过滤器逻辑

待进一步优化：
1. 创建用户表，实现UP主名称真实查询
2. 检查并修复标题乱码问题
3. 优化分数显示精度
4. 完善测试用例

