# Coupon 优惠券服务重构方案

## 一、概述与架构

### 1.1 项目目标

将 openbilibili 的 coupon（优惠券服务）模块使用 go-zero 框架重构，保持业务逻辑完全一致。

### 1.2 核心功能分析

根据主项目代码分析，coupon 模块包含以下核心功能：

| **维度**       | **功能模块**       | **英文名称**            | **功能说明**                                                 |
| -------------- | ------------------ | ----------------------- | ------------------------------------------------------------ |
| **管理后台**   | **优惠券批次管理** | Coupon Batch Management | 负责批次的创建、状态维护（开启/禁用）以及发放总量的上限控制。 |
| **资产类型**   | **观影券**         | Video Coupon            | **单张形态：** 专门用于视频付费内容的抵扣或兑换。            |
|                | **漫画券**         | Cartoon Coupon          | **余额形态：** 账户余额制，按需扣减，用于漫画内容的消费。    |
|                | **代金券**         | Allowance Coupon        | **满减形态：** 设置消费门槛（如满100减20），主要用于VIP会员购买。 |
| **分发与安全** | **兑换码**         | Coupon Code             | 外部触达手段，用户通过输入特定代码兑换上述代金券。           |
|                | **验证码服务**     | Captcha Service         | 安全校验机制，在兑换码使用环节进行人机验证，防止恶意刷取。   |

### 1.3 微服务架构

```
┌─────────────────────────────────────────────────────────────┐
│                      API Gateway                             │
│                   (coupon-api:8080)                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      RPC Service                             │
│                   (coupon-rpc:9080)                         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Coupon Logic│  │ Allowance   │  │ Code Logic          │  │
│  │ (观影/漫画) │  │ Logic       │  │ (兑换码)            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
        ┌──────────┐   ┌──────────┐   ┌──────────┐
        │  MySQL   │   │  Redis   │   │ Memcache │
        │ (分表)   │   │ (分布式锁)│   │ (缓存)   │
        └──────────┘   └──────────┘   └──────────┘
```

### 1.4 目录结构

```
mybilibili/app/coupon/
├── cmd/
│   ├── api/                          # HTTP API 服务
│   │   ├── desc/coupon.api           # API 定义
│   │   ├── etc/coupon.yaml           # 配置文件
│   │   └── internal/
│   │       ├── config/
│   │       ├── handler/
│   │       ├── logic/
│   │       ├── svc/
│   │       └── types/
│   └── rpc/                          # gRPC 服务
│       ├── coupon.proto              # Protobuf 定义
│       ├── etc/coupon.yaml           # 配置文件
│       └── internal/
│           ├── config/
│           ├── logic/
│           │   ├── coupon_logic.go           # 观影券逻辑
│           │   ├── allowance_logic.go        # 代金券逻辑
│           │   ├── code_logic.go             # 兑换码逻辑
│           │   └── batch_logic.go            # 批次管理逻辑
│           ├── server/
│           └── svc/
└── model/                            # 数据模型
    ├── coupon_info_model.go          # 观影券表 (分100表)
    ├── coupon_allowance_info_model.go # 代金券表 (分10表)
    ├── coupon_balance_info_model.go  # 漫画券余额表 (分10表)
    ├── coupon_batch_info_model.go    # 批次信息表
    ├── coupon_order_model.go         # 订单表
    ├── coupon_code_model.go          # 兑换码表
    └── vars.go                       # 常量定义
```

### 1.5 核心设计

#### 1.5.1 分表策略（完全参照主项目）

| **业务领域**        | **逻辑表名**                  | **分表数量** | **分表键 (ShardingKey)** | **分表算法 (Hash)** | **备注**                       |
| ------------------- | ----------------------------- | ------------ | ------------------------ | ------------------- | ------------------------------ |
| **基础信息**        | `coupon_info`                 | 100          | $mid$                    | $mid \pmod{100}$    | 存放券的基本实例信息           |
|                     | `coupon_change_log`           | 100          | $mid$                    | $mid \pmod{100}$    | 核心变动流水，量大，故分表数多 |
| **漫画券 (余额型)** | `coupon_balance_info`         | 10           | $mid$                    | $mid \pmod{10}$     | 漫画余额账户信息               |
|                     | `coupon_balance_change_log`   | 10           | $mid$                    | $mid \pmod{10}$     | 余额变动明细                   |
| **代金券 (满减型)** | `coupon_allowance_info`       | 10           | $mid$                    | $mid \pmod{10}$     | 代金券持有详情                 |
|                     | `coupon_allowance_change_log` | 10           | $mid$                    | $mid \pmod{10}$     | 代金券使用/失效记录            |

#### 1.5.2 分布式锁设计

```go
// 使用场景
1. 优惠券使用锁：防止同一订单重复使用券
   Key: coupon:use:lock:{orderNo}:{couponType}
   
2. 优惠券发放锁：防止同一批次对同一用户重复发放
   Key: coupon:grant:lock:{batchToken}:{mid}
   
3. 兑换码使用锁：防止重复兑换
   Key: coupon:code:lock:{uniqueNo}
   
4. 领取锁：防止重复领取
   Key: coupon:receive:lock:{appkey}:{orderNo}:{couponType}
```

#### 1.5.3 缓存策略

```go
// Memcache 缓存
1. 用户优惠券列表缓存
   Key: coupon:list:{mid}:{couponType}
   
2. 用户代金券列表缓存
   Key: coupon:allowance:{mid}:{state}
   
3. 批次当前发放数量缓存
   Key: coupon:batch:count:{batchToken}
```

------

## 二、接口定义

### 2.1 Protobuf 定义 (coupon.proto)

```protobuf
syntax = "proto3";

package coupon;
option go_package = "./coupon";

// ==================== 服务定义 ====================
service Coupon {
  // ========== 验证码相关 ==========
  // 获取验证码Token
  rpc CaptchaToken(CaptchaTokenReq) returns(CaptchaTokenResp);
  
  // ========== 兑换码相关 ==========
  // 使用兑换码
  rpc UseCouponCode(UseCouponCodeReq) returns(UseCouponCodeResp);
  
  // ========== 代金券相关 ==========
  // 获取可用代金券V2
  rpc UsableAllowanceCouponV2(UsableAllowanceCouponV2Req) returns(UsableAllowanceCouponV2Resp);
  // 使用代金券
  rpc UseAllowanceCoupon(UseAllowanceCouponReq) returns(UseAllowanceCouponResp);
  // 取消使用代金券
  rpc CancelAllowanceCoupon(CancelAllowanceCouponReq) returns(CancelAllowanceCouponResp);
  // 代金券使用通知（支付结果回调）
  rpc AllowanceCouponNotify(AllowanceCouponNotifyReq) returns(AllowanceCouponNotifyResp);
  // 代金券列表
  rpc AllowanceList(AllowanceListReq) returns(AllowanceListResp);
  // 代金券详情
  rpc AllowanceInfo(AllowanceInfoReq) returns(AllowanceInfoResp);
  // 领取代金券
  rpc ReceiveAllowance(ReceiveAllowanceReq) returns(ReceiveAllowanceResp);
  // 同步检查代金券是否可用
  rpc UseNotify(UseNotifyReq) returns(UseNotifyResp);
  
  // ========== 观影券相关 ==========
  // 用户观影券列表
  rpc UserCoupon(UserCouponReq) returns(UserCouponResp);
  // 使用观影券
  rpc UseCoupon(UseCouponReq) returns(UseCouponResp);
  // 观影券详情
  rpc CouponInfo(CouponInfoReq) returns(CouponInfoResp);
  // 观影券分页列表
  rpc CouponPage(CouponPageReq) returns(CouponPageResp);
  // 观影券数量
  rpc VideoCouponCount(VideoCouponCountReq) returns(VideoCouponCountResp);
  
  // ========== 发放相关 ==========
  // 发放优惠券
  rpc SalaryCoupon(SalaryCouponReq) returns(SalaryCouponResp);
  // 第三方发放优惠券
  rpc SalaryCouponForThird(SalaryCouponForThirdReq) returns(SalaryCouponForThirdResp);
  
  // ========== 批次相关 ==========
  // 批次信息
  rpc BatchInfo(BatchInfoReq) returns(BatchInfoResp);
}

// ==================== 通用消息 ====================
message PriceInfo {
  double price = 1;
  int64 plat = 2;
  int32 prod_lim_month = 3;
  int32 prod_lim_renewal = 4;
}

message CouponAllowancePanelInfo {
  string coupon_token = 1;
  double coupon_amount = 2;
  int32 state = 3;
  string full_limit_explain = 4;
  string scope_explain = 5;
  double full_amount = 6;
  double coupon_discount_price = 7;
  int64 start_time = 8;
  int64 expire_time = 9;
  int32 selected = 10;
  string disables_explains = 11;
  string order_no = 12;
  string name = 13;
  int32 usable = 14;
}

message CouponInfo {
  int64 id = 1;
  string coupon_token = 2;
  int64 mid = 3;
  int32 state = 4;
  int64 start_time = 5;
  int64 expire_time = 6;
  int64 origin = 7;
  int64 coupon_type = 8;
  string order_no = 9;
  int64 oid = 10;
  string remark = 11;
}

// ==================== 验证码 ====================
message CaptchaTokenReq {
  string ip = 1;
}

message CaptchaTokenResp {
  string token = 1;
  string url = 2;
}

// ==================== 兑换码 ====================
message UseCouponCodeReq {
  string token = 1;
  string code = 2;
  string verify = 3;
  string ip = 4;
  int64 mid = 5;
}

message UseCouponCodeResp {
  string coupon_token = 1;
  double coupon_amount = 2;
  double full_amount = 3;
  string platform_limit_explain = 4;
  int32 product_limit_month = 5;
  int32 product_limit_renewal = 6;
}

// ==================== 代金券 ====================
message UsableAllowanceCouponV2Req {
  int64 mid = 1;
  repeated PriceInfo price_info = 2;
}

message UsableAllowanceCouponV2Resp {
  string coupon_tip = 1;
  CouponAllowancePanelInfo coupon_info = 2;
}

message UseAllowanceCouponReq {
  int64 mid = 1;
  string coupon_token = 2;
  string remark = 3;
  string order_no = 4;
  double price = 5;
  string platform = 6;
  int32 prod_lim_month = 7;
  int32 prod_lim_renewal = 8;
}

message UseAllowanceCouponResp {}

message CancelAllowanceCouponReq {
  int64 mid = 1;
  string coupon_token = 2;
}

message CancelAllowanceCouponResp {}

message AllowanceCouponNotifyReq {
  int64 mid = 1;
  string order_no = 2;
  int32 pay_state = 3;  // 0:失败 1:成功
}

message AllowanceCouponNotifyResp {}

message AllowanceListReq {
  int64 mid = 1;
  int32 state = 2;  // 0:未使用 2:已使用 3:已过期
}

message AllowanceListResp {
  repeated CouponAllowancePanelInfo list = 1;
}

message AllowanceInfoReq {
  int64 mid = 1;
  string coupon_token = 2;
}

message AllowanceInfoResp {
  int64 id = 1;
  string coupon_token = 2;
  int64 mid = 3;
  int32 state = 4;
  int64 start_time = 5;
  int64 expire_time = 6;
  double amount = 7;
  double full_amount = 8;
  string batch_token = 9;
}

message ReceiveAllowanceReq {
  int64 mid = 1;
  string batch_token = 2;
  string order_no = 3;
  string appkey = 4;
}

message ReceiveAllowanceResp {
  string coupon_token = 1;
}

message UseNotifyReq {
  int64 mid = 1;
  string order_no = 2;
}

message UseNotifyResp {
  string coupon_token = 1;
  double amount = 2;
  double full_amount = 3;
}

// ==================== 观影券 ====================
message UserCouponReq {
  int64 mid = 1;
  int32 coupon_type = 2;
}

message UserCouponResp {
  repeated CouponInfo list = 1;
}

message UseCouponReq {
  int64 mid = 1;
  int64 oid = 2;
  string remark = 3;
  string order_no = 4;
  int32 coupon_type = 5;
  int64 use_ver = 6;
}

message UseCouponResp {
  int32 ret = 1;  // 0:失败 1:成功
  string coupon_token = 2;
}

message CouponInfoReq {
  int64 mid = 1;
  string coupon_token = 2;
}

message CouponInfoResp {
  CouponInfo info = 1;
}

message CouponPageReq {
  int64 mid = 1;
  int32 state = 2;
  int32 pn = 3;
  int32 ps = 4;
}

message CouponPageResp {
  int64 count = 1;
  repeated CouponPageItem list = 2;
}

message CouponPageItem {
  int64 id = 1;
  string title = 2;
  int64 time = 3;
  int64 ref_id = 4;
  string tips = 5;
  int64 count = 6;
}

message VideoCouponCountReq {
  int64 mid = 1;
  int32 coupon_type = 2;
}

message VideoCouponCountResp {
  int32 count = 1;
}

// ==================== 发放 ====================
message SalaryCouponReq {
  int64 mid = 1;
  int64 coupon_type = 2;
  int32 count = 3;
  string batch_token = 4;
  int64 app_id = 5;
  int64 origin = 6;
}

message SalaryCouponResp {}

message SalaryCouponForThirdReq {
  int64 mid = 1;
  int64 coupon_type = 2;
  int32 count = 3;
  string batch_token = 4;
  int64 app_id = 5;
  string unique_no = 6;
}

message SalaryCouponForThirdResp {
  double amount = 1;
  double full_amount = 2;
  string description = 3;
}

// ==================== 批次 ====================
message BatchInfoReq {
  string batch_token = 1;
}

message BatchInfoResp {
  int64 id = 1;
  int64 app_id = 2;
  string name = 3;
  string batch_token = 4;
  int64 max_count = 5;
  int64 current_count = 6;
  int64 start_time = 7;
  int64 expire_time = 8;
  int64 expire_day = 9;
  int64 limit_count = 10;
  double full_amount = 11;
  double amount = 12;
  int32 state = 13;
  int32 coupon_type = 14;
}
```

### 2.2 API 定义 (coupon.api)

```go
syntax = "v1"

info (
    title:   "Coupon API"
    desc:    "优惠券服务 API"
    author:  "mybilibili"
    version: "v1.0.0"
)

// ==================== 数据结构 ====================
type PriceInfo {
    Price          float64 `json:"price"`
    Plat           int64   `json:"plat"`
    ProdLimMonth   int32   `json:"prod_lim_month"`
    ProdLimRenewal int32   `json:"prod_lim_renewal"`
}

type CouponAllowancePanelInfo {
    CouponToken         string  `json:"coupon_token"`
    CouponAmount        float64 `json:"coupon_amount"`
    State               int32   `json:"state"`
    FullLimitExplain    string  `json:"full_limit_explain"`
    ScopeExplain        string  `json:"scope_explain"`
    FullAmount          float64 `json:"full_amount"`
    CouponDiscountPrice float64 `json:"coupon_discount_price"`
    StartTime           int64   `json:"start_time"`
    ExpireTime          int64   `json:"expire_time"`
    Selected            int32   `json:"selected"`
    DisablesExplains    string  `json:"disables_explains"`
    OrderNo             string  `json:"order_no"`
    Name                string  `json:"name"`
    Usable              int32   `json:"usable"`
}

// ========== 验证码 ==========
type CaptchaTokenReq {}

type CaptchaTokenResp {
    Token string `json:"token"`
    Url   string `json:"url"`
}

// ========== 兑换码 ==========
type UseCouponCodeReq {
    Token  string `json:"token"`
    Code   string `json:"code"`
    Verify string `json:"verify"`
}

type UseCouponCodeResp {
    CouponToken          string  `json:"coupon_token"`
    CouponAmount         float64 `json:"coupon_amount"`
    FullAmount           float64 `json:"full_amount"`
    PlatformLimitExplain string  `json:"platform_limit_explain"`
    ProductLimitMonth    int32   `json:"product_limit_month"`
    ProductLimitRenewal  int32   `json:"product_limit_renewal"`
}

// ========== 代金券 ==========
type UsableAllowanceCouponV2Req {
    PriceInfo []PriceInfo `json:"price_info"`
}

type UsableAllowanceCouponV2Resp {
    CouponTip  string                    `json:"coupon_tip"`
    CouponInfo *CouponAllowancePanelInfo `json:"coupon_info"`
}

type UseAllowanceCouponReq {
    CouponToken    string  `json:"coupon_token"`
    Remark         string  `json:"remark"`
    OrderNo        string  `json:"order_no"`
    Price          float64 `json:"price"`
    Platform       string  `json:"platform,default=pc"`
    ProdLimMonth   int32   `json:"prod_lim_month,optional"`
    ProdLimRenewal int32   `json:"prod_lim_renewal,optional"`
}

type AllowanceListReq {
    State int32 `form:"state"`
}

type AllowanceListResp {
    List []*CouponAllowancePanelInfo `json:"list"`
}

type CancelAllowanceCouponReq {
    CouponToken string `json:"coupon_token"`
}

type ReceiveAllowanceReq {
    BatchToken string `json:"batch_token"`
    OrderNo    string `json:"order_no"`
    Appkey     string `json:"appkey"`
}

type ReceiveAllowanceResp {
    CouponToken string `json:"coupon_token"`
}

// ========== 观影券 ==========
type UserCouponReq {
    CouponType int32 `form:"coupon_type"`
}

type CouponInfoItem {
    Id         int64  `json:"id"`
    CouponToken string `json:"coupon_token"`
    State      int32  `json:"state"`
    StartTime  int64  `json:"start_time"`
    ExpireTime int64  `json:"expire_time"`
}

type UserCouponResp {
    List []*CouponInfoItem `json:"list"`
}

type CouponPageReq {
    State int32 `form:"state"`
    Pn    int32 `form:"pn,default=1"`
    Ps    int32 `form:"ps,default=20"`
}

type CouponPageItem {
    Id    int64  `json:"id"`
    Title string `json:"title"`
    Time  int64  `json:"time"`
    RefId int64  `json:"ref_id"`
}

type CouponPageResp {
    Count int64            `json:"count"`
    List  []*CouponPageItem `json:"list"`
}

type VideoCouponCountReq {
    CouponType int32 `form:"coupon_type"`
}

type VideoCouponCountResp {
    Count int32 `json:"count"`
}

// ==================== 路由定义 ====================
@server (
    prefix: /api/coupon/v1
    group:  captcha
)
service coupon {
    @doc "获取验证码Token"
    @handler CaptchaToken
    get /captcha/token (CaptchaTokenReq) returns (CaptchaTokenResp)
}

@server (
    prefix: /api/coupon/v1
    group:  code
    middleware: AuthMiddleware
)
service coupon {
    @doc "使用兑换码"
    @handler UseCouponCode
    post /code/use (UseCouponCodeReq) returns (UseCouponCodeResp)
}

@server (
    prefix: /api/coupon/v1
    group:  allowance
    middleware: AuthMiddleware
)
service coupon {
    @doc "获取可用代金券V2"
    @handler UsableAllowanceCouponV2
    post /allowance/usable (UsableAllowanceCouponV2Req) returns (UsableAllowanceCouponV2Resp)
    
    @doc "使用代金券"
    @handler UseAllowanceCoupon
    post /allowance/use (UseAllowanceCouponReq) returns ()
    
    @doc "取消使用代金券"
    @handler CancelAllowanceCoupon
    post /allowance/cancel (CancelAllowanceCouponReq) returns ()
    
    @doc "代金券列表"
    @handler AllowanceList
    get /allowance/list (AllowanceListReq) returns (AllowanceListResp)
    
    @doc "领取代金券"
    @handler ReceiveAllowance
    post /allowance/receive (ReceiveAllowanceReq) returns (ReceiveAllowanceResp)
}

@server (
    prefix: /api/coupon/v1
    group:  coupon
    middleware: AuthMiddleware
)
service coupon {
    @doc "用户观影券列表"
    @handler UserCoupon
    get /user/list (UserCouponReq) returns (UserCouponResp)
    
    @doc "观影券分页列表"
    @handler CouponPage
    get /page (CouponPageReq) returns (CouponPageResp)
    
    @doc "观影券数量"
    @handler VideoCouponCount
    get /video/count (VideoCouponCountReq) returns (VideoCouponCountResp)
}
```

------

## 三、数据库设计

### 3.1 表结构（完全参照主项目）

```sql
-- deploy/sql/020_coupon_schema.sql

-- ==================== 批次信息表 ====================
CREATE TABLE IF NOT EXISTS `coupon_batch_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `app_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '应用ID',
  `name` varchar(64) NOT NULL DEFAULT '' COMMENT '批次名称',
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `max_count` bigint(20) NOT NULL DEFAULT '-1' COMMENT '最大发放数量,-1不限制',
  `current_count` bigint(20) NOT NULL DEFAULT '0' COMMENT '当前发放数量',
  `start_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '开始时间',
  `expire_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '过期时间',
  `expire_day` bigint(20) NOT NULL DEFAULT '-1' COMMENT '有效天数,-1使用expire_time',
  `limit_count` bigint(20) NOT NULL DEFAULT '-1' COMMENT '每人限领数量,-1不限制',
  `full_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '满额条件',
  `amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '优惠金额',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态:0正常,1冻结',
  `coupon_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '券类型:1观影券,2漫画券,3代金券',
  `platform_limit` varchar(64) NOT NULL DEFAULT '' COMMENT '平台限制,逗号分隔',
  `product_limit_month` tinyint(4) NOT NULL DEFAULT '0' COMMENT '商品月份限制:0不限,1月度,3季度,12年度',
  `product_limit_renewal` tinyint(4) NOT NULL DEFAULT '0' COMMENT '续费限制:0不限,1自动续期,2非自动续期',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_batch_token` (`batch_token`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券批次信息表';

-- ==================== 观影券信息表（分100表）====================
-- 示例：coupon_info_00 ~ coupon_info_99
CREATE TABLE IF NOT EXISTS `coupon_info_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态:0未使用,1使用中,2已使用,3已过期,4已冻结',
  `start_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '开始时间',
  `expire_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '过期时间',
  `origin` bigint(20) NOT NULL DEFAULT '0' COMMENT '来源',
  `coupon_type` bigint(20) NOT NULL DEFAULT '0' COMMENT '券类型',
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `oid` bigint(20) NOT NULL DEFAULT '0' COMMENT '关联ID',
  `remark` varchar(128) NOT NULL DEFAULT '' COMMENT '备注',
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `use_ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '使用版本',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_coupon_token` (`coupon_token`),
  KEY `ix_mid_state_type` (`mid`,`state`,`coupon_type`),
  KEY `ix_order_no` (`order_no`),
  KEY `ix_mtime` (`mtime`)
) ENGINE
```

------

```sql
-- 继续 coupon_info_00 表定义
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='观影券信息表';

-- 需要创建 coupon_info_00 ~ coupon_info_99 共100张表

-- ==================== 观影券变更日志表（分100表）====================
CREATE TABLE IF NOT EXISTS `coupon_change_log_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  KEY `ix_coupon_token` (`coupon_token`),
  KEY `ix_mid` (`mid`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='观影券变更日志表';

-- ==================== 代金券信息表（分10表）====================
CREATE TABLE IF NOT EXISTS `coupon_allowance_info_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态:0未使用,1使用中,2已使用',
  `start_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '开始时间',
  `expire_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '过期时间',
  `origin` tinyint(4) NOT NULL DEFAULT '0' COMMENT '来源:1系统发放,2业务领取,3新年活动,4兑换码',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '优惠金额',
  `full_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '满额条件',
  `app_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '应用ID',
  `remark` varchar(128) NOT NULL DEFAULT '' COMMENT '备注',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_coupon_token` (`coupon_token`),
  KEY `ix_mid_state` (`mid`,`state`),
  KEY `ix_order_no` (`order_no`),
  KEY `ix_mid_batch` (`mid`,`batch_token`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='代金券信息表';

-- 需要创建 coupon_allowance_info_00 ~ coupon_allowance_info_09 共10张表

-- ==================== 代金券变更日志表（分10表）====================
CREATE TABLE IF NOT EXISTS `coupon_allowance_change_log_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态',
  `change_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '变更类型:1发放,2消费,3取消,4消费成功,5消费失败,6领取',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  KEY `ix_coupon_token` (`coupon_token`),
  KEY `ix_mid` (`mid`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='代金券变更日志表';

-- ==================== 漫画券余额表（分10表）====================
CREATE TABLE IF NOT EXISTS `coupon_balance_info_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `balance` bigint(20) NOT NULL DEFAULT '0' COMMENT '余额',
  `start_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '开始时间',
  `expire_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '过期时间',
  `origin` tinyint(4) NOT NULL DEFAULT '0' COMMENT '来源',
  `coupon_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '券类型',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_mid_batch` (`mid`,`batch_token`),
  KEY `ix_mid_type` (`mid`,`coupon_type`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='漫画券余额表';

-- ==================== 漫画券余额变更日志表（分10表）====================
CREATE TABLE IF NOT EXISTS `coupon_balance_change_log_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `balance` bigint(20) NOT NULL DEFAULT '0' COMMENT '变更后余额',
  `change_balance` bigint(20) NOT NULL DEFAULT '0' COMMENT '变更数量',
  `change_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '变更类型:1VIP发放,2系统发放,3消费,4消费失败退回',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  KEY `ix_mid_batch` (`mid`,`batch_token`),
  KEY `ix_order_no` (`order_no`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='漫画券余额变更日志表';

-- ==================== 优惠券订单表 ====================
CREATE TABLE IF NOT EXISTS `coupon_order` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `count` bigint(20) NOT NULL DEFAULT '0' COMMENT '使用数量',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态:0待支付,1支付中,2支付成功,3支付失败',
  `coupon_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '券类型',
  `third_trade_no` varchar(64) NOT NULL DEFAULT '' COMMENT '第三方交易号',
  `remark` varchar(128) NOT NULL DEFAULT '' COMMENT '备注',
  `tips` varchar(128) NOT NULL DEFAULT '' COMMENT '提示',
  `use_ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '使用版本',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `ix_mid_state_type` (`mid`,`state`,`coupon_type`),
  KEY `ix_third_trade_no` (`third_trade_no`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券订单表';

-- ==================== 优惠券订单日志表 ====================
CREATE TABLE IF NOT EXISTS `coupon_order_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  KEY `ix_order_no` (`order_no`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券订单日志表';

-- ==================== 兑换码表 ====================
CREATE TABLE IF NOT EXISTS `coupon_code` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `code` varchar(32) NOT NULL DEFAULT '' COMMENT '兑换码',
  `state` tinyint(4) NOT NULL DEFAULT '1' COMMENT '状态:1未使用,2已使用,3已冻结',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '使用者ID',
  `coupon_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '券类型',
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '兑换后的券Token',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`),
  KEY `ix_batch_token` (`batch_token`),
  KEY `ix_mid` (`mid`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='兑换码表';

-- ==================== 领取日志表 ====================
CREATE TABLE IF NOT EXISTS `coupon_receive_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `appkey` varchar(32) NOT NULL DEFAULT '' COMMENT '应用Key',
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `coupon_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '券类型',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_appkey_order_type` (`appkey`,`order_no`,`coupon_type`),
  KEY `ix_mid` (`mid`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='领取日志表';

-- ==================== 用户卡片表（新年活动）====================
CREATE TABLE IF NOT EXISTS `coupon_user_card` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `card_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '卡片类型:0月度,1季度,2年度',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态:0未开,1已开,2已使用',
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `act_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '活动ID',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_mid_act_card` (`mid`,`act_id`,`card_type`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户卡片表';
```

------

## 四、核心 Logic 实现

### 4.1 常量定义 (model/vars.go)

```go
package model

// 优惠券使用状态
const (
    UseFaild   int8 = 0
    UseSuccess int8 = 1
)

// 优惠券状态
const (
    NotUsed int32 = 0 // 未使用
    InUse   int32 = 1 // 使用中
    Used    int32 = 2 // 已使用
    Expire  int32 = 3 // 已过期
    Block   int32 = 4 // 已冻结
)

// 支付状态
const (
    WaitPay    int8 = 0
    InPay      int8 = 1
    PaySuccess int8 = 2
    PayFaild   int8 = 3
)

// 最大发放数量
const MaxSalaryCount = 100

// 余额变更类型
const (
    VipSalary         int8 = 1 // VIP发放
    SystemAdminSalary int8 = 2 // 系统发放
    Consume           int8 = 3 // 消费
    ConsumeFaildBack  int8 = 4 // 消费失败退回
)

// 优惠券类型
const (
    CouponVideo     int8 = 1 // 观影券
    CouponCartoon   int8 = 2 // 漫画券
    CouponAllowance int8 = 3 // 代金券
)

// 代金券来源
const (
    AllowanceNone            int8 = 0
    AllowanceSystemAdmin     int8 = 1 // 系统发放
    AllowanceBusinessReceive int8 = 2 // 业务领取
    AllowanceBusinessNewYear int8 = 3 // 新年活动
    AllowanceCodeOpen        int8 = 4 // 兑换码
)

// 批次状态
const (
    BatchStateNormal int8 = 0 // 正常
    BatchStateBlock  int8 = 1 // 冻结
)

// 代金券不可用原因
const (
    CouponHadBlock             = "代金券已被冻结"
    CouponFullAmountDissatisfy = "未达到满额条件"
    CouponNotInUsableTime      = "当前不在有效期内"
    CouponInUse                = "已绑定在其他未支付订单,点击解锁"
    CouponPlatformExplain      = "当前平台不可使用"
    CouponProductExplain       = "当前商品不可使用"
)

// 代金券提示
const (
    CouponTipNotUse      = "不使用代金券"
    CouponTipChooseOther = "选中其他商品有惊喜"
    CouponTipUse         = "抵扣%.2f元"
    CouponTipInUse       = "有代金券被锁定"
)

// 代金券可用状态
const (
    AllowanceDisables int8 = 0
    AllowanceUsable   int8 = 1
)

// 代金券变更类型
const (
    AllowanceSalary         int8 = 1 // 发放
    AllowanceConsume        int8 = 2 // 消费
    AllowanceCancel         int8 = 3 // 取消
    AllowanceConsumeSuccess int8 = 4 // 消费成功
    AllowanceConsumeFaild   int8 = 5 // 消费失败
    AllowanceReceive        int8 = 6 // 领取
)

// 支付通知状态
const (
    AllowanceUseFaild   int8 = 0
    AllowanceUseSuccess int8 = 1
)

// 兑换码状态
const (
    CodeStateNotUse int32 = 1 // 未使用
    CodeStateUsed   int32 = 2 // 已使用
    CodeStateBlock  int32 = 3 // 已冻结
)

// 设备类型
const (
    DeviceIOS         int = 1
    DeviceIPAD        int = 2
    DevicePC          int = 3
    DeviceANDROID     int = 4
    DeviceIPADHD      int = 5
    DeviceIOSBLUE     int = 6
    DeviceANDROIDBLUE int = 7
    DevicePUBLIC      int = 8
)

// 平台名称映射
var PlatformByName = map[string]int{
    "ios":       DeviceIOS,
    "ios_b":     DeviceIOS,
    "ipad":      DeviceIPAD,
    "ipadhd":    DeviceIPAD,
    "pc":        DevicePC,
    "public":    DevicePC,
    "android":   DeviceANDROID,
    "android_b": DeviceANDROID,
}

// 商品月份限制
const (
    ProdLimMonthNone int8 = 0
    ProdLimMonth1    int8 = 1
    ProdLimMonth3    int8 = 3
    ProdLimMonth12   int8 = 12
)

// 续费限制
const (
    ProdLimRenewalAll     int8 = 0 // 不限
    ProdLimRenewalAuto    int8 = 1 // 自动续期
    ProdLimRenewalNotAuto int8 = 2 // 非自动续期
)
```

### 4.2 代金券核心逻辑 (allowance_logic.go 示例)

```go
package logic

import (
    "context"
    "fmt"
    "sort"
    "strings"
    "time"

    "mybilibili/app/coupon/cmd/rpc/coupon"
    "mybilibili/app/coupon/cmd/rpc/internal/svc"
    "mybilibili/app/coupon/model"
    "mybilibili/common/xerr"

    "github.com/zeromicro/go-zero/core/logx"
    "github.com/zeromicro/go-zero/core/stores/sqlx"
)

type UsableAllowanceCouponV2Logic struct {
    ctx    context.Context
    svcCtx *svc.ServiceContext
    logx.Logger
}

func NewUsableAllowanceCouponV2Logic(ctx context.Context, svcCtx *svc.ServiceContext) *UsableAllowanceCouponV2Logic {
    return &UsableAllowanceCouponV2Logic{
        ctx:    ctx,
        svcCtx: svcCtx,
        Logger: logx.WithContext(ctx),
    }
}

// UsableAllowanceCouponV2 获取可用代金券V2
func (l *UsableAllowanceCouponV2Logic) UsableAllowanceCouponV2(in *coupon.UsableAllowanceCouponV2Req) (*coupon.UsableAllowanceCouponV2Resp, error) {
    resp := &coupon.UsableAllowanceCouponV2Resp{
        CouponTip: model.CouponTipNotUse,
    }

    if len(in.PriceInfo) == 0 {
        return resp, nil
    }

    // 1. 获取用户未使用的代金券
    notUsedList, err := l.getAllowanceCoupons(in.Mid, model.NotUsed)
    if err != nil {
        return nil, err
    }

    // 2. 获取用户使用中的代金券
    inUseList, err := l.getAllowanceCoupons(in.Mid, model.InUse)
    if err != nil {
        return nil, err
    }

    all := append(notUsedList, inUseList...)
    if len(all) == 0 {
        return resp, nil
    }

    selectedPrice := in.PriceInfo[0].Price
    var maxAmount float64
    var bestCoupon *coupon.CouponAllowancePanelInfo
    var selectedCoupon *coupon.CouponAllowancePanelInfo

    // 3. 遍历每个价格，找出最优券
    for _, priceInfo := range in.PriceInfo {
        usables, _, using, err := l.filterUsableCoupons(
            in.Mid,
            priceInfo.Price,
            all,
            int(priceInfo.Plat),
            int8(priceInfo.ProdLimMonth),
            int8(priceInfo.ProdLimRenewal),
        )
        if err != nil {
            return nil, err
        }

        availables := append(usables, using...)
        if len(availables) == 0 {
            continue
        }

        // 按金额排序
        sort.Slice(availables, func(i, j int) bool {
            if availables[i].CouponAmount == availables[j].CouponAmount {
                return availables[i].Usable > availables[j].Usable
            }
            return availables[i].CouponAmount > availables[j].CouponAmount
        })

        if availables[0].CouponAmount > maxAmount {
            maxAmount = availables[0].CouponAmount
            bestCoupon = availables[0]
        }

        if priceInfo.Price == selectedPrice {
            selectedCoupon = availables[0]
            break
        }
    }

    if bestCoupon == nil {
        return resp, nil
    }

    // 4. 设置返回提示
    switch {
    case bestCoupon.Usable == model.AllowanceUsable:
        resp.CouponTip = fmt.Sprintf(model.CouponTipUse, bestCoupon.CouponAmount)
        resp.CouponInfo = bestCoupon
    case bestCoupon.State == model.InUse:
        resp.CouponTip = model.CouponTipInUse
    case selectedCoupon == nil:
        resp.CouponTip = model.CouponTipChooseOther
    }

    return resp, nil
}

// getAllowanceCoupons 获取代金券列表（带缓存）
func (l *UsableAllowanceCouponV2Logic) getAllowanceCoupons(mid int64, state int32) ([]*model.CouponAllowanceInfo, error) {
    now := time.Now().Unix()

    // 1. 尝试从缓存获取
    cacheKey := fmt.Sprintf("coupon:allowance:%d:%d", mid, state)
    var list []*model.CouponAllowanceInfo

    err := l.svcCtx.Cache.GetCtx(l.ctx, cacheKey, &list)
    if err == nil && list != nil {
        // 过滤过期的
        result := make([]*model.CouponAllowanceInfo, 0)
        for _, c := range list {
            if c.ExpireTime > now {
                result = append(result, c)
            }
        }
        return result, nil
    }

    // 2. 从数据库查询
    list, err = l.svcCtx.CouponAllowanceModel.FindByMidAndState(l.ctx, mid, state, now)
    if err != nil {
        return nil, xerr.NewErrCode(xerr.DB_ERROR)
    }

    // 3. 设置缓存
    if len(list) > 0 {
        _ = l.svcCtx.Cache.SetCtx(l.ctx, cacheKey, list)
    }

    return list, nil
}

// filterUsableCoupons 筛选可用券
func (l *UsableAllowanceCouponV2Logic) filterUsableCoupons(
    mid int64,
    price float64,
    all []*model.CouponAllowanceInfo,
    plat int,
    prodLimMonth, prodLimRenewal int8,
) (usables, disables, using []*coupon.CouponAllowancePanelInfo, err error) {
    now := time.Now().Unix()
    usables = make([]*coupon.CouponAllowancePanelInfo, 0)
    disables = make([]*coupon.CouponAllowancePanelInfo, 0)
    using = make([]*coupon.CouponAllowancePanelInfo, 0)

    for _, c := range all {
        // 获取批次信息
        batch, ok := l.svcCtx.BatchInfoCache[c.BatchToken]
        if !ok || batch == nil {
            continue
        }

        if batch.State == model.BatchStateBlock {
            continue
        }

        ok = true
        explains := make([]string, 0)

        // 平台限制检查
        if !l.platformLimit(batch.PlatformLimit, plat) {
            explains = append(explains, model.CouponPlatformExplain)
            ok = false
        }

        // 商品限制检查
        if !l.productLimit(batch.ProdLimMonth, batch.ProdLimRenewal, prodLimMonth, prodLimRenewal) {
            explains = append(explains, model.CouponProductExplain)
            ok = false
        }

        // 满额检查
        if c.FullAmount > price {
            explains = append(explains, model.CouponFullAmountDissatisfy)
            ok = false
        }

        // 开始时间检查
        if c.StartTime > now {
            explains = append(explains, model.CouponNotInUsableTime)
            ok = false
        }

        // 使用中状态处理
        if c.State == model.InUse {
            if len(explains) > 0 {
                c.State = model.NotUsed
            }
            if ok {
                using = append(using, l.convertToPanelInfo(c, explains, price, model.AllowanceDisables))
            }
            ok = false
        }

        if ok {
            usables = append(usables, l.convertToPanelInfo(c, explains, price, model.AllowanceUsable))
        } else {
            disables = append(disables, l.convertToPanelInfo(c, explains, price, model.AllowanceDisables))
        }
    }

    // 可用券排序：按过期时间升序，金额降序
    if len(usables) > 0 {
        sort.Slice(usables, func(i, j int) bool {
            return usables[i].ExpireTime < usables[j].ExpireTime
        })
        sort.Slice(usables, func(i, j int) bool {
            return usables[i].CouponAmount > usables[j].CouponAmount
        })
        usables[0].Selected = 1
    }

    return
}

// platformLimit 平台限制验证
func (l *UsableAllowanceCouponV2Logic) platformLimit(pstr string, plat int) bool {
    if len(pstr) == 0 {
        return true
    }
    ps := strings.Split(pstr, ",")
    for _, v := range ps {
        if v == fmt.Sprintf("%d", plat) {
            return true
        }
    }
    return false
}

// productLimit 商品限制验证
func (l *UsableAllowanceCouponV2Logic) productLimit(bplm, bplr, plm, plr int8) bool {
    if bplm == model.ProdLimMonthNone && bplr == model.ProdLimRenewalAll {
        return true
    }
    if bplm == model.ProdLimMonthNone && bplr == plr {
        return true
    }
    if bplr == model.ProdLimRenewalAll && bplm == plm {
        return true
    }
    if bplm == plm && bplr == plr {
        return true
    }
    return false
}

// convertToPanelInfo 转换为面板信息
func (l *UsableAllowanceCouponV2Logic) convertToPanelInfo(
    c *model.CouponAllowanceInfo,
    explains []string,
    price float64,
    usable int8,
) *coupon.CouponAllowancePanelInfo {
    return &coupon.CouponAllowancePanelInfo{
        CouponToken:         c.CouponToken,
        CouponAmount:        c.Amount,
        State
```

```go
        // convertToPanelInfo 续
        State:               c.State,
        FullLimitExplain:    fmt.Sprintf("满%.0f元可用", c.FullAmount),
        FullAmount:          c.FullAmount,
        StartTime:           c.StartTime,
        ExpireTime:          c.ExpireTime,
        CouponDiscountPrice: price - c.Amount,
        DisablesExplains:    strings.Join(explains, ","),
        OrderNo:             c.OrderNO,
        Name:                "大会员代金券",
        Usable:              int32(usable),
    }
}
```

### 4.3 使用代金券逻辑 (use_allowance_logic.go)

```go
package logic

import (
    "context"
    "fmt"
    "time"

    "mybilibili/app/coupon/cmd/rpc/coupon"
    "mybilibili/app/coupon/cmd/rpc/internal/svc"
    "mybilibili/app/coupon/model"
    "mybilibili/common/xerr"

    "github.com/zeromicro/go-zero/core/logx"
)

type UseAllowanceCouponLogic struct {
    ctx    context.Context
    svcCtx *svc.ServiceContext
    logx.Logger
}

func NewUseAllowanceCouponLogic(ctx context.Context, svcCtx *svc.ServiceContext) *UseAllowanceCouponLogic {
    return &UseAllowanceCouponLogic{
        ctx:    ctx,
        svcCtx: svcCtx,
        Logger: logx.WithContext(ctx),
    }
}

func (l *UseAllowanceCouponLogic) UseAllowanceCoupon(in *coupon.UseAllowanceCouponReq) (*coupon.UseAllowanceCouponResp, error) {
    // 1. 验证券是否可用
    cp, err := l.judgeCouponUsable(
        in.Mid,
        in.Price,
        in.CouponToken,
        model.PlatformByName[in.Platform],
        int8(in.ProdLimMonth),
        int8(in.ProdLimRenewal),
    )
    if err != nil {
        return nil, err
    }

    // 2. 检查订单是否已绑定券
    exist, err := l.svcCtx.CouponAllowanceModel.FindByOrderNo(l.ctx, in.Mid, in.OrderNo)
    if err != nil {
        return nil, xerr.NewErrCode(xerr.DB_ERROR)
    }
    if exist != nil {
        return nil, xerr.NewErrMsg("订单已绑定优惠券")
    }

    // 3. 更新券状态为使用中
    err = l.updateAllowanceCoupon(cp, model.InUse, in.Remark, in.OrderNo, model.AllowanceConsume)
    if err != nil {
        return nil, err
    }

    return &coupon.UseAllowanceCouponResp{}, nil
}

// judgeCouponUsable 验证券是否可用
func (l *UseAllowanceCouponLogic) judgeCouponUsable(mid int64, price float64, couponToken string, plat int, prodLimMonth, prodLimRenewal int8) (*model.CouponAllowanceInfo, error) {
    now := time.Now().Unix()

    // 1. 查询券信息
    cp, err := l.svcCtx.CouponAllowanceModel.FindByToken(l.ctx, mid, couponToken)
    if err != nil {
        return nil, xerr.NewErrCode(xerr.DB_ERROR)
    }
    if cp == nil {
        return nil, xerr.NewErrMsg("优惠券不存在")
    }

    // 2. 获取批次信息
    batch, ok := l.svcCtx.BatchInfoCache[cp.BatchToken]
    if !ok || batch == nil {
        return nil, xerr.NewErrMsg("批次不存在")
    }

    // 3. 批次状态检查
    if batch.State != model.BatchStateNormal {
        return nil, xerr.NewErrMsg("优惠券已被冻结")
    }

    // 4. 券状态检查
    if cp.State != model.NotUsed {
        return nil, xerr.NewErrMsg("优惠券已被使用")
    }

    // 5. 有效期检查
    if cp.StartTime > now || now > cp.ExpireTime {
        return nil, xerr.NewErrMsg("优惠券不在有效期内")
    }

    // 6. 满额检查
    if cp.FullAmount > price {
        return nil, xerr.NewErrMsg("未达到满额条件")
    }

    // 7. 平台限制检查
    if !l.platformLimit(batch.PlatformLimit, plat) {
        return nil, xerr.NewErrMsg("当前平台不可使用")
    }

    // 8. 商品限制检查
    if !l.productLimit(batch.ProdLimMonth, batch.ProdLimRenewal, prodLimMonth, prodLimRenewal) {
        return nil, xerr.NewErrMsg("当前商品不可使用")
    }

    return cp, nil
}

// updateAllowanceCoupon 更新券状态（事务）
func (l *UseAllowanceCouponLogic) updateAllowanceCoupon(cp *model.CouponAllowanceInfo, state int32, remark, orderNo string, changeType int8) error {
    return l.svcCtx.DB.TransactCtx(l.ctx, func(ctx context.Context, session sqlx.Session) error {
        // 1. 更新券状态
        err := l.svcCtx.CouponAllowanceModel.UpdateState(ctx, session, cp.Id, cp.Mid, state, orderNo, remark, cp.Ver)
        if err != nil {
            return err
        }

        // 2. 插入变更日志
        changeLog := &model.CouponAllowanceChangeLog{
            CouponToken: cp.CouponToken,
            OrderNo:     orderNo,
            Mid:         cp.Mid,
            State:       int8(state),
            ChangeType:  changeType,
            Ctime:       time.Now(),
        }
        err = l.svcCtx.CouponAllowanceChangeLogModel.Insert(ctx, session, changeLog)
        if err != nil {
            return err
        }

        return nil
    })

    // 3. 删除缓存
    l.svcCtx.Cache.DelCtx(l.ctx, fmt.Sprintf("coupon:allowance:%d:%d", cp.Mid, model.NotUsed))
    l.svcCtx.Cache.DelCtx(l.ctx, fmt.Sprintf("coupon:allowance:%d:%d", cp.Mid, model.InUse))

    return nil
}

func (l *UseAllowanceCouponLogic) platformLimit(pstr string, plat int) bool {
    // 同上
}

func (l *UseAllowanceCouponLogic) productLimit(bplm, bplr, plm, plr int8) bool {
    // 同上
}
```

### 4.4 Service Context (svc/service_context.go)

```go
package svc

import (
    "context"
    "sync"
    "time"

    "mybilibili/app/coupon/cmd/rpc/internal/config"
    "mybilibili/app/coupon/model"

    "github.com/zeromicro/go-zero/core/logx"
    "github.com/zeromicro/go-zero/core/stores/cache"
    "github.com/zeromicro/go-zero/core/stores/redis"
    "github.com/zeromicro/go-zero/core/stores/sqlx"
)

type ServiceContext struct {
    Config config.Config
    DB     sqlx.SqlConn
    Redis  *redis.Redis
    Cache  cache.Cache

    // Models
    CouponBatchInfoModel          model.CouponBatchInfoModel
    CouponInfoModel               model.CouponInfoModel
    CouponChangeLogModel          model.CouponChangeLogModel
    CouponAllowanceModel          model.CouponAllowanceInfoModel
    CouponAllowanceChangeLogModel model.CouponAllowanceChangeLogModel
    CouponBalanceModel            model.CouponBalanceInfoModel
    CouponOrderModel              model.CouponOrderModel
    CouponCodeModel               model.CouponCodeModel
    CouponReceiveLogModel         model.CouponReceiveLogModel

    // 批次信息缓存（内存）
    BatchInfoCache map[string]*model.CouponBatchInfo
    batchMu        sync.RWMutex
}

func NewServiceContext(c config.Config) *ServiceContext {
    db := sqlx.NewMysql(c.Mysql.DataSource)
    rds := redis.MustNewRedis(c.RedisConf)
    cacheNode := cache.New(c.CacheRedis, nil, cache.NewStat("coupon"), nil)

    svc := &ServiceContext{
        Config: c,
        DB:     db,
        Redis:  rds,
        Cache:  cacheNode,

        CouponBatchInfoModel:          model.NewCouponBatchInfoModel(db, cacheNode),
        CouponInfoModel:               model.NewCouponInfoModel(db, cacheNode),
        CouponChangeLogModel:          model.NewCouponChangeLogModel(db),
        CouponAllowanceModel:          model.NewCouponAllowanceInfoModel(db, cacheNode),
        CouponAllowanceChangeLogModel: model.NewCouponAllowanceChangeLogModel(db),
        CouponBalanceModel:            model.NewCouponBalanceInfoModel(db, cacheNode),
        CouponOrderModel:              model.NewCouponOrderModel(db, cacheNode),
        CouponCodeModel:               model.NewCouponCodeModel(db, cacheNode),
        CouponReceiveLogModel:         model.NewCouponReceiveLogModel(db),

        BatchInfoCache: make(map[string]*model.CouponBatchInfo),
    }

    // 启动批次信息加载
    svc.loadBatchInfo()
    go svc.loadBatchInfoLoop()

    return svc
}

// loadBatchInfo 加载批次信息到内存
func (s *ServiceContext) loadBatchInfo() {
    ctx := context.Background()
    list, err := s.CouponBatchInfoModel.FindAll(ctx)
    if err != nil {
        logx.Errorf("loadBatchInfo error: %v", err)
        return
    }

    s.batchMu.Lock()
    defer s.batchMu.Unlock()

    tmp := make(map[string]*model.CouponBatchInfo, len(list))
    for _, v := range list {
        tmp[v.BatchToken] = v
    }
    s.BatchInfoCache = tmp
    logx.Infof("loadBatchInfo success, count: %d", len(tmp))
}

// loadBatchInfoLoop 定时刷新批次信息
func (s *ServiceContext) loadBatchInfoLoop() {
    ticker := time.NewTicker(time.Minute)
    defer ticker.Stop()

    for range ticker.C {
        s.loadBatchInfo()
    }
}

// GetBatchInfo 获取批次信息
func (s *ServiceContext) GetBatchInfo(batchToken string) *model.CouponBatchInfo {
    s.batchMu.RLock()
    defer s.batchMu.RUnlock()
    return s.BatchInfoCache[batchToken]
}
```

------

## 五、实施计划

### 5.1 阶段一：基础架构（1天）

```bash
# 1. 创建目录结构
mkdir -p mybilibili/app/coupon/cmd/api/desc
mkdir -p mybilibili/app/coupon/cmd/api/etc
mkdir -p mybilibili/app/coupon/cmd/rpc/etc
mkdir -p mybilibili/app/coupon/model

# 2. 创建数据库表
mysql -h127.0.0.1 -P33060 -uroot -proot123456 mybilibili < deploy/sql/020_coupon_schema.sql

# 3. 编写 proto 文件并生成代码
cd mybilibili/app/coupon/cmd/rpc
/Users/zh/go/bin/goctl rpc protoc coupon.proto --go_out=. --go-grpc_out=. --zrpc_out=. --style go_zero

# 4. 编写 api 文件并生成代码
cd mybilibili/app/coupon/cmd/api
/Users/zh/go/bin/goctl api go -api desc/coupon.api -dir . --style go_zero
```

### 5.2 阶段二：Model 层实现（1天）

| 任务 | 说明 | |-----|------| | coupon_batch_info_model.go | 批次信息表（不分表） | | coupon_info_model.go | 观影券表（分100表） | | coupon_allowance_info_model.go | 代金券表（分10表） | | coupon_balance_info_model.go | 漫画券余额表（分10表） | | coupon_order_model.go | 订单表（不分表） | | coupon_code_model.go | 兑换码表（不分表） | | vars.go | 常量定义 |

### 5.3 阶段三：RPC 核心逻辑（2天）

| 优先级 | Logic | 说明 | |-------|-------|------| | P0 | usable_allowance_coupon_v2_logic.go | 获取可用代金券 | | P0 | use_allowance_coupon_logic.go | 使用代金券 | | P0 | cancel_allowance_coupon_logic.go | 取消使用代金券 | | P0 | allowance_coupon_notify_logic.go | 支付结果通知 | | P1 | salary_coupon_logic.go | 发放优惠券 | | P1 | receive_allowance_logic.go | 领取代金券 | | P1 | use_coupon_code_logic.go | 使用兑换码 | | P2 | user_coupon_logic.go | 观影券列表 | | P2 | coupon_page_logic.go | 券分页列表 |

### 5.4 阶段四：API 层实现（0.5天）

- 实现 API Logic 层，调用 RPC 服务
- 配置中间件（Auth、日志等）
- 编写配置文件

### 5.5 阶段五：测试与部署（0.5天）

```bash
# 1. 启动基础服务
cd mybilibili/deploy && docker-compose up -d

# 2. 启动 RPC 服务
cd mybilibili/app/coupon/cmd/rpc && go run coupon.go -f etc/coupon.yaml

# 3. 启动 API 服务
cd mybilibili/app/coupon/cmd/api && go run coupon.go -f etc/coupon.yaml

# 4. 测试接口
# 获取可用代金券
curl -X POST http://localhost:8080/api/coupon/v1/allowance/usable \
  -H "Content-Type: application/json" \
  -d '{"price_info":[{"price":25,"plat":3,"prod_lim_month":1,"prod_lim_renewal":0}]}'
```

------

## 六、配置文件示例

### 6.1 RPC 配置 (etc/coupon.yaml)

```yaml
Name: coupon.rpc
ListenOn: 0.0.0.0:9080

Etcd:
  Hosts:
    - 127.0.0.1:2379
  Key: coupon.rpc

Mysql:
  DataSource: root:root123456@tcp(127.0.0.1:33060)/mybilibili?charset=utf8mb4&parseTime=true&loc=Local

RedisConf:
  Host: 127.0.0.1:6379
  Type: node
  Pass: ""

CacheRedis:
  - Host: 127.0.0.1:6379
    Type: node
    Pass: ""

Telemetry:
  Name: coupon.rpc
  Endpoint: http://127.0.0.1:14268/api/traces
  Sampler: 1.0
  Batcher: jaeger
```

### 6.2 API 配置 (etc/coupon.yaml)

```yaml
Name: coupon.api
Host: 0.0.0.0
Port: 8085

CouponRpc:
  Etcd:
    Hosts:
      - 127.0.0.1:2379
    Key: coupon.rpc

Auth:
  AccessSecret: "your-secret-key"
  AccessExpire: 86400

Telemetry:
  Name: coupon.api
  Endpoint: http://127.0.0.1:14268/api/traces
  Sampler: 1.0
  Batcher: jaeger
```

------

## 七、总结

### 核心要点

1. **完全参照主项目**：业务逻辑、表结构、分表策略完全一致
2. **分表设计**：观影券100表、代金券/漫画券10表
3. **分布式锁**：使用 Redis 防止并发问题
4. **缓存策略**：批次信息内存缓存 + 用户券列表 Redis 缓存
5. **事务处理**：券状态变更使用数据库事务保证一致性

### 工作量估算

| 阶段 | 工作量 | |-----|--------| | 基础架构 | 1天 | | Model 层 | 1天 | | RPC 核心逻辑 | 2天 | | API 层 | 0.5天 | | 测试部署 | 0.5天 | | **总计** | **5天** |

### 未来优化项

#### 1. 用户身份认证（mid 获取方式优化）

**当前实现**：mid 通过请求参数直接传递（`form:"mid"` 或 `json:"mid"`）

**openbilibili 架构分析**：
- **内部服务层（service）**：mid 通过请求参数传递，因为调用方是可信的内部服务
- **接口层（interface/BFF）**：通过中间件从 cookie/token 验证用户身份，然后 `c.Set("mid", mid)` 存入 context

**参考代码**（openbilibili/app/interface/main/tag/http/http.go）：
```go
// 对外接口使用 authSvc.User 中间件从 cookie/token 验证用户身份
outer.POST("/archive/add", authSvc.User, addArcTagForOuter)

// 对内接口使用 setMid 函数从请求参数中获取 mid 并设置到 context
inner.GET("/info", verifySvc.Verify, setMid, info)

func setMid(c *bm.Context) {
    var (
        err error
        mid int64
    )
    req := c.Request
    midStr := req.Form.Get("mid")
    if midStr != "" {
        mid, err = strconv.ParseInt(midStr, 10, 64)
        if err != nil {
            c.JSON(nil, err)
            c.Abort()
            return
        }
    }
    c.Set("mid", mid)
}
```

**优化方案**：
1. **添加 JWT 中间件**：在 API 层添加 JWT 认证中间件，从 token 中解析 mid
2. **Context 传递**：将 mid 存入 context，在 logic 层通过 context 获取
3. **分层处理**：
   - 对外 API：必须通过 JWT 认证获取 mid
   - 内部 RPC：mid 通过请求参数传递（当前实现）

**go-zero JWT 中间件示例**：
```go
// api 文件中配置
@server (
    prefix: /api/coupon/v1
    group:  allowance
    jwt:    Auth  // 启用 JWT 认证
)

// 配置文件
Auth:
  AccessSecret: "your-secret-key"
  AccessExpire: 86400

// logic 中获取 mid
func (l *AllowanceListLogic) AllowanceList(req *types.AllowanceListReq) (*types.AllowanceListResp, error) {
    // 从 context 中获取 mid（JWT 中间件自动注入）
    mid := ctxdata.GetUidFromCtx(l.ctx)
    // ...
}
```

**优先级**：P1（建议在生产环境部署前完成）

------

方案输出完毕，确认后可以开始实施。

Credits used: 1.84

Elapsed time: 1m

Checkpoint

Restore

v0.0.1-coupon系统.md 2 - 1740

- 
- 

```md
好的，我来分析一下 openbilibili 中的 coupon 模块，然后输出重构方案。

先让我查看主项目中 coupon 模块的完整结构和代码：

Searched workspace
查看 coupon 模块的目录结构
Searched workspace
查看 model 层的数据结构定义
Searched workspace
查看 dao 层的数据访问实现
Searched workspace
查看 service 层的业务逻辑
Searched workspace
查看 api 层的接口定义
Read file(s)

api.proto

model.go

coupon.go
Read file(s)

code.go

order.go

param.go

rpc.go
Read file(s)

service.go

coupon.go

allowance.go
Read file(s)

allowance.go 1090 - 9007199254740992
Read file(s)

code.go

branch.go
Read file(s)

dao.go

mysql.go

allowance.go
现在我已经完整分析了 openbilibili 中 coupon 模块的代码结构。让我输出重构方案：

Coupon 优惠券服务重构方案
一、概述与架构
1.1 项目目标
将 openbilibili 的 coupon（优惠券服务）模块使用 go-zero 框架重构，保持业务逻辑完全一致。

1.2 核心功能分析
根据主项目代码分析，coupon 模块包含以下核心功能：

| 功能模块 | 说明 | |---------|------| | 优惠券批次管理 | 批次创建、状态管理、发放数量控制 | | 观影券（Video Coupon） | 单张券，用于视频付费内容 | | 漫画券（Cartoon Coupon） | 余额型券，用于漫画内容 | | 代金券（Allowance Coupon） | 满减券，用于VIP购买等场景 | | 兑换码（Coupon Code） | 通过兑换码领取代金券 | | 验证码服务 | 兑换码使用时的验证码校验 |

1.3 微服务架构
┌─────────────────────────────────────────────────────────────┐
│                      API Gateway                             │
│                   (coupon-api:8080)                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      RPC Service                             │
│                   (coupon-rpc:9080)                         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Coupon Logic│  │ Allowance   │  │ Code Logic          │  │
│  │ (观影/漫画) │  │ Logic       │  │ (兑换码)            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
        ┌──────────┐   ┌──────────┐   ┌──────────┐
        │  MySQL   │   │  Redis   │   │ Memcache │
        │ (分表)   │   │ (分布式锁)│   │ (缓存)   │
        └──────────┘   └──────────┘   └──────────┘
1.4 目录结构
mybilibili/app/coupon/
├── cmd/
│   ├── api/                          # HTTP API 服务
│   │   ├── desc/coupon.api           # API 定义
│   │   ├── etc/coupon.yaml           # 配置文件
│   │   └── internal/
│   │       ├── config/
│   │       ├── handler/
│   │       ├── logic/
│   │       ├── svc/
│   │       └── types/
│   └── rpc/                          # gRPC 服务
│       ├── coupon.proto              # Protobuf 定义
│       ├── etc/coupon.yaml           # 配置文件
│       └── internal/
│           ├── config/
│           ├── logic/
│           │   ├── coupon_logic.go           # 观影券逻辑
│           │   ├── allowance_logic.go        # 代金券逻辑
│           │   ├── code_logic.go             # 兑换码逻辑
│           │   └── batch_logic.go            # 批次管理逻辑
│           ├── server/
│           └── svc/
└── model/                            # 数据模型
    ├── coupon_info_model.go          # 观影券表 (分100表)
    ├── coupon_allowance_info_model.go # 代金券表 (分10表)
    ├── coupon_balance_info_model.go  # 漫画券余额表 (分10表)
    ├── coupon_batch_info_model.go    # 批次信息表
    ├── coupon_order_model.go         # 订单表
    ├── coupon_code_model.go          # 兑换码表
    └── vars.go                       # 常量定义
1.5 核心设计
1.5.1 分表策略（完全参照主项目）
| 表名 | 分表数 | 分表键 | 分表函数 | |-----|--------|--------|---------| | coupon_info | 100 | mid | mid % 100 | | coupon_change_log | 100 | mid | mid % 100 | | coupon_balance_info | 10 | mid | mid % 10 | | coupon_balance_change_log | 10 | mid | mid % 10 | | coupon_allowance_info | 10 | mid | mid % 10 | | coupon_allowance_change_log | 10 | mid | mid % 10 |

1.5.2 分布式锁设计
// 使用场景
1. 优惠券使用锁：防止同一订单重复使用券
   Key: coupon:use:lock:{orderNo}:{couponType}
   
2. 优惠券发放锁：防止同一批次对同一用户重复发放
   Key: coupon:grant:lock:{batchToken}:{mid}
   
3. 兑换码使用锁：防止重复兑换
   Key: coupon:code:lock:{uniqueNo}
   
4. 领取锁：防止重复领取
   Key: coupon:receive:lock:{appkey}:{orderNo}:{couponType}
1.5.3 缓存策略
// Memcache 缓存
1. 用户优惠券列表缓存
   Key: coupon:list:{mid}:{couponType}
   
2. 用户代金券列表缓存
   Key: coupon:allowance:{mid}:{state}
   
3. 批次当前发放数量缓存
   Key: coupon:batch:count:{batchToken}
二、接口定义
2.1 Protobuf 定义 (coupon.proto)
syntax = "proto3";

package coupon;
option go_package = "./coupon";

// ==================== 服务定义 ====================
service Coupon {
  // ========== 验证码相关 ==========
  // 获取验证码Token
  rpc CaptchaToken(CaptchaTokenReq) returns(CaptchaTokenResp);
  
  // ========== 兑换码相关 ==========
  // 使用兑换码
  rpc UseCouponCode(UseCouponCodeReq) returns(UseCouponCodeResp);
  
  // ========== 代金券相关 ==========
  // 获取可用代金券V2
  rpc UsableAllowanceCouponV2(UsableAllowanceCouponV2Req) returns(UsableAllowanceCouponV2Resp);
  // 使用代金券
  rpc UseAllowanceCoupon(UseAllowanceCouponReq) returns(UseAllowanceCouponResp);
  // 取消使用代金券
  rpc CancelAllowanceCoupon(CancelAllowanceCouponReq) returns(CancelAllowanceCouponResp);
  // 代金券使用通知（支付结果回调）
  rpc AllowanceCouponNotify(AllowanceCouponNotifyReq) returns(AllowanceCouponNotifyResp);
  // 代金券列表
  rpc AllowanceList(AllowanceListReq) returns(AllowanceListResp);
  // 代金券详情
  rpc AllowanceInfo(AllowanceInfoReq) returns(AllowanceInfoResp);
  // 领取代金券
  rpc ReceiveAllowance(ReceiveAllowanceReq) returns(ReceiveAllowanceResp);
  // 同步检查代金券是否可用
  rpc UseNotify(UseNotifyReq) returns(UseNotifyResp);
  
  // ========== 观影券相关 ==========
  // 用户观影券列表
  rpc UserCoupon(UserCouponReq) returns(UserCouponResp);
  // 使用观影券
  rpc UseCoupon(UseCouponReq) returns(UseCouponResp);
  // 观影券详情
  rpc CouponInfo(CouponInfoReq) returns(CouponInfoResp);
  // 观影券分页列表
  rpc CouponPage(CouponPageReq) returns(CouponPageResp);
  // 观影券数量
  rpc VideoCouponCount(VideoCouponCountReq) returns(VideoCouponCountResp);
  
  // ========== 发放相关 ==========
  // 发放优惠券
  rpc SalaryCoupon(SalaryCouponReq) returns(SalaryCouponResp);
  // 第三方发放优惠券
  rpc SalaryCouponForThird(SalaryCouponForThirdReq) returns(SalaryCouponForThirdResp);
  
  // ========== 批次相关 ==========
  // 批次信息
  rpc BatchInfo(BatchInfoReq) returns(BatchInfoResp);
}

// ==================== 通用消息 ====================
message PriceInfo {
  double price = 1;
  int64 plat = 2;
  int32 prod_lim_month = 3;
  int32 prod_lim_renewal = 4;
}

message CouponAllowancePanelInfo {
  string coupon_token = 1;
  double coupon_amount = 2;
  int32 state = 3;
  string full_limit_explain = 4;
  string scope_explain = 5;
  double full_amount = 6;
  double coupon_discount_price = 7;
  int64 start_time = 8;
  int64 expire_time = 9;
  int32 selected = 10;
  string disables_explains = 11;
  string order_no = 12;
  string name = 13;
  int32 usable = 14;
}

message CouponInfo {
  int64 id = 1;
  string coupon_token = 2;
  int64 mid = 3;
  int32 state = 4;
  int64 start_time = 5;
  int64 expire_time = 6;
  int64 origin = 7;
  int64 coupon_type = 8;
  string order_no = 9;
  int64 oid = 10;
  string remark = 11;
}

// ==================== 验证码 ====================
message CaptchaTokenReq {
  string ip = 1;
}

message CaptchaTokenResp {
  string token = 1;
  string url = 2;
}

// ==================== 兑换码 ====================
message UseCouponCodeReq {
  string token = 1;
  string code = 2;
  string verify = 3;
  string ip = 4;
  int64 mid = 5;
}

message UseCouponCodeResp {
  string coupon_token = 1;
  double coupon_amount = 2;
  double full_amount = 3;
  string platform_limit_explain = 4;
  int32 product_limit_month = 5;
  int32 product_limit_renewal = 6;
}

// ==================== 代金券 ====================
message UsableAllowanceCouponV2Req {
  int64 mid = 1;
  repeated PriceInfo price_info = 2;
}

message UsableAllowanceCouponV2Resp {
  string coupon_tip = 1;
  CouponAllowancePanelInfo coupon_info = 2;
}

message UseAllowanceCouponReq {
  int64 mid = 1;
  string coupon_token = 2;
  string remark = 3;
  string order_no = 4;
  double price = 5;
  string platform = 6;
  int32 prod_lim_month = 7;
  int32 prod_lim_renewal = 8;
}

message UseAllowanceCouponResp {}

message CancelAllowanceCouponReq {
  int64 mid = 1;
  string coupon_token = 2;
}

message CancelAllowanceCouponResp {}

message AllowanceCouponNotifyReq {
  int64 mid = 1;
  string order_no = 2;
  int32 pay_state = 3;  // 0:失败 1:成功
}

message AllowanceCouponNotifyResp {}

message AllowanceListReq {
  int64 mid = 1;
  int32 state = 2;  // 0:未使用 2:已使用 3:已过期
}

message AllowanceListResp {
  repeated CouponAllowancePanelInfo list = 1;
}

message AllowanceInfoReq {
  int64 mid = 1;
  string coupon_token = 2;
}

message AllowanceInfoResp {
  int64 id = 1;
  string coupon_token = 2;
  int64 mid = 3;
  int32 state = 4;
  int64 start_time = 5;
  int64 expire_time = 6;
  double amount = 7;
  double full_amount = 8;
  string batch_token = 9;
}

message ReceiveAllowanceReq {
  int64 mid = 1;
  string batch_token = 2;
  string order_no = 3;
  string appkey = 4;
}

message ReceiveAllowanceResp {
  string coupon_token = 1;
}

message UseNotifyReq {
  int64 mid = 1;
  string order_no = 2;
}

message UseNotifyResp {
  string coupon_token = 1;
  double amount = 2;
  double full_amount = 3;
}

// ==================== 观影券 ====================
message UserCouponReq {
  int64 mid = 1;
  int32 coupon_type = 2;
}

message UserCouponResp {
  repeated CouponInfo list = 1;
}

message UseCouponReq {
  int64 mid = 1;
  int64 oid = 2;
  string remark = 3;
  string order_no = 4;
  int32 coupon_type = 5;
  int64 use_ver = 6;
}

message UseCouponResp {
  int32 ret = 1;  // 0:失败 1:成功
  string coupon_token = 2;
}

message CouponInfoReq {
  int64 mid = 1;
  string coupon_token = 2;
}

message CouponInfoResp {
  CouponInfo info = 1;
}

message CouponPageReq {
  int64 mid = 1;
  int32 state = 2;
  int32 pn = 3;
  int32 ps = 4;
}

message CouponPageResp {
  int64 count = 1;
  repeated CouponPageItem list = 2;
}

message CouponPageItem {
  int64 id = 1;
  string title = 2;
  int64 time = 3;
  int64 ref_id = 4;
  string tips = 5;
  int64 count = 6;
}

message VideoCouponCountReq {
  int64 mid = 1;
  int32 coupon_type = 2;
}

message VideoCouponCountResp {
  int32 count = 1;
}

// ==================== 发放 ====================
message SalaryCouponReq {
  int64 mid = 1;
  int64 coupon_type = 2;
  int32 count = 3;
  string batch_token = 4;
  int64 app_id = 5;
  int64 origin = 6;
}

message SalaryCouponResp {}

message SalaryCouponForThirdReq {
  int64 mid = 1;
  int64 coupon_type = 2;
  int32 count = 3;
  string batch_token = 4;
  int64 app_id = 5;
  string unique_no = 6;
}

message SalaryCouponForThirdResp {
  double amount = 1;
  double full_amount = 2;
  string description = 3;
}

// ==================== 批次 ====================
message BatchInfoReq {
  string batch_token = 1;
}

message BatchInfoResp {
  int64 id = 1;
  int64 app_id = 2;
  string name = 3;
  string batch_token = 4;
  int64 max_count = 5;
  int64 current_count = 6;
  int64 start_time = 7;
  int64 expire_time = 8;
  int64 expire_day = 9;
  int64 limit_count = 10;
  double full_amount = 11;
  double amount = 12;
  int32 state = 13;
  int32 coupon_type = 14;
}
2.2 API 定义 (coupon.api)
syntax = "v1"

info (
    title:   "Coupon API"
    desc:    "优惠券服务 API"
    author:  "mybilibili"
    version: "v1.0.0"
)

// ==================== 数据结构 ====================
type PriceInfo {
    Price          float64 `json:"price"`
    Plat           int64   `json:"plat"`
    ProdLimMonth   int32   `json:"prod_lim_month"`
    ProdLimRenewal int32   `json:"prod_lim_renewal"`
}

type CouponAllowancePanelInfo {
    CouponToken         string  `json:"coupon_token"`
    CouponAmount        float64 `json:"coupon_amount"`
    State               int32   `json:"state"`
    FullLimitExplain    string  `json:"full_limit_explain"`
    ScopeExplain        string  `json:"scope_explain"`
    FullAmount          float64 `json:"full_amount"`
    CouponDiscountPrice float64 `json:"coupon_discount_price"`
    StartTime           int64   `json:"start_time"`
    ExpireTime          int64   `json:"expire_time"`
    Selected            int32   `json:"selected"`
    DisablesExplains    string  `json:"disables_explains"`
    OrderNo             string  `json:"order_no"`
    Name                string  `json:"name"`
    Usable              int32   `json:"usable"`
}

// ========== 验证码 ==========
type CaptchaTokenReq {}

type CaptchaTokenResp {
    Token string `json:"token"`
    Url   string `json:"url"`
}

// ========== 兑换码 ==========
type UseCouponCodeReq {
    Token  string `json:"token"`
    Code   string `json:"code"`
    Verify string `json:"verify"`
}

type UseCouponCodeResp {
    CouponToken          string  `json:"coupon_token"`
    CouponAmount         float64 `json:"coupon_amount"`
    FullAmount           float64 `json:"full_amount"`
    PlatformLimitExplain string  `json:"platform_limit_explain"`
    ProductLimitMonth    int32   `json:"product_limit_month"`
    ProductLimitRenewal  int32   `json:"product_limit_renewal"`
}

// ========== 代金券 ==========
type UsableAllowanceCouponV2Req {
    PriceInfo []PriceInfo `json:"price_info"`
}

type UsableAllowanceCouponV2Resp {
    CouponTip  string                    `json:"coupon_tip"`
    CouponInfo *CouponAllowancePanelInfo `json:"coupon_info"`
}

type UseAllowanceCouponReq {
    CouponToken    string  `json:"coupon_token"`
    Remark         string  `json:"remark"`
    OrderNo        string  `json:"order_no"`
    Price          float64 `json:"price"`
    Platform       string  `json:"platform,default=pc"`
    ProdLimMonth   int32   `json:"prod_lim_month,optional"`
    ProdLimRenewal int32   `json:"prod_lim_renewal,optional"`
}

type AllowanceListReq {
    State int32 `form:"state"`
}

type AllowanceListResp {
    List []*CouponAllowancePanelInfo `json:"list"`
}

type CancelAllowanceCouponReq {
    CouponToken string `json:"coupon_token"`
}

type ReceiveAllowanceReq {
    BatchToken string `json:"batch_token"`
    OrderNo    string `json:"order_no"`
    Appkey     string `json:"appkey"`
}

type ReceiveAllowanceResp {
    CouponToken string `json:"coupon_token"`
}

// ========== 观影券 ==========
type UserCouponReq {
    CouponType int32 `form:"coupon_type"`
}

type CouponInfoItem {
    Id         int64  `json:"id"`
    CouponToken string `json:"coupon_token"`
    State      int32  `json:"state"`
    StartTime  int64  `json:"start_time"`
    ExpireTime int64  `json:"expire_time"`
}

type UserCouponResp {
    List []*CouponInfoItem `json:"list"`
}

type CouponPageReq {
    State int32 `form:"state"`
    Pn    int32 `form:"pn,default=1"`
    Ps    int32 `form:"ps,default=20"`
}

type CouponPageItem {
    Id    int64  `json:"id"`
    Title string `json:"title"`
    Time  int64  `json:"time"`
    RefId int64  `json:"ref_id"`
}

type CouponPageResp {
    Count int64            `json:"count"`
    List  []*CouponPageItem `json:"list"`
}

type VideoCouponCountReq {
    CouponType int32 `form:"coupon_type"`
}

type VideoCouponCountResp {
    Count int32 `json:"count"`
}

// ==================== 路由定义 ====================
@server (
    prefix: /api/coupon/v1
    group:  captcha
)
service coupon {
    @doc "获取验证码Token"
    @handler CaptchaToken
    get /captcha/token (CaptchaTokenReq) returns (CaptchaTokenResp)
}

@server (
    prefix: /api/coupon/v1
    group:  code
    middleware: AuthMiddleware
)
service coupon {
    @doc "使用兑换码"
    @handler UseCouponCode
    post /code/use (UseCouponCodeReq) returns (UseCouponCodeResp)
}

@server (
    prefix: /api/coupon/v1
    group:  allowance
    middleware: AuthMiddleware
)
service coupon {
    @doc "获取可用代金券V2"
    @handler UsableAllowanceCouponV2
    post /allowance/usable (UsableAllowanceCouponV2Req) returns (UsableAllowanceCouponV2Resp)
    
    @doc "使用代金券"
    @handler UseAllowanceCoupon
    post /allowance/use (UseAllowanceCouponReq) returns ()
    
    @doc "取消使用代金券"
    @handler CancelAllowanceCoupon
    post /allowance/cancel (CancelAllowanceCouponReq) returns ()
    
    @doc "代金券列表"
    @handler AllowanceList
    get /allowance/list (AllowanceListReq) returns (AllowanceListResp)
    
    @doc "领取代金券"
    @handler ReceiveAllowance
    post /allowance/receive (ReceiveAllowanceReq) returns (ReceiveAllowanceResp)
}

@server (
    prefix: /api/coupon/v1
    group:  coupon
    middleware: AuthMiddleware
)
service coupon {
    @doc "用户观影券列表"
    @handler UserCoupon
    get /user/list (UserCouponReq) returns (UserCouponResp)
    
    @doc "观影券分页列表"
    @handler CouponPage
    get /page (CouponPageReq) returns (CouponPageResp)
    
    @doc "观影券数量"
    @handler VideoCouponCount
    get /video/count (VideoCouponCountReq) returns (VideoCouponCountResp)
}
三、数据库设计
3.1 表结构（完全参照主项目）
-- deploy/sql/020_coupon_schema.sql

-- ==================== 批次信息表 ====================
CREATE TABLE IF NOT EXISTS `coupon_batch_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `app_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '应用ID',
  `name` varchar(64) NOT NULL DEFAULT '' COMMENT '批次名称',
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `max_count` bigint(20) NOT NULL DEFAULT '-1' COMMENT '最大发放数量,-1不限制',
  `current_count` bigint(20) NOT NULL DEFAULT '0' COMMENT '当前发放数量',
  `start_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '开始时间',
  `expire_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '过期时间',
  `expire_day` bigint(20) NOT NULL DEFAULT '-1' COMMENT '有效天数,-1使用expire_time',
  `limit_count` bigint(20) NOT NULL DEFAULT '-1' COMMENT '每人限领数量,-1不限制',
  `full_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '满额条件',
  `amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '优惠金额',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态:0正常,1冻结',
  `coupon_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '券类型:1观影券,2漫画券,3代金券',
  `platform_limit` varchar(64) NOT NULL DEFAULT '' COMMENT '平台限制,逗号分隔',
  `product_limit_month` tinyint(4) NOT NULL DEFAULT '0' COMMENT '商品月份限制:0不限,1月度,3季度,12年度',
  `product_limit_renewal` tinyint(4) NOT NULL DEFAULT '0' COMMENT '续费限制:0不限,1自动续期,2非自动续期',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_batch_token` (`batch_token`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券批次信息表';

-- ==================== 观影券信息表（分100表）====================
-- 示例：coupon_info_00 ~ coupon_info_99
CREATE TABLE IF NOT EXISTS `coupon_info_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态:0未使用,1使用中,2已使用,3已过期,4已冻结',
  `start_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '开始时间',
  `expire_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '过期时间',
  `origin` bigint(20) NOT NULL DEFAULT '0' COMMENT '来源',
  `coupon_type` bigint(20) NOT NULL DEFAULT '0' COMMENT '券类型',
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `oid` bigint(20) NOT NULL DEFAULT '0' COMMENT '关联ID',
  `remark` varchar(128) NOT NULL DEFAULT '' COMMENT '备注',
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `use_ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '使用版本',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_coupon_token` (`coupon_token`),
  KEY `ix_mid_state_type` (`mid`,`state`,`coupon_type`),
  KEY `ix_order_no` (`order_no`),
  KEY `ix_mtime` (`mtime`)
) ENGINE
Credits used: 4.35
Elapsed time: 2m 27s
Checkpoint
Restore
继续往下输出。

Kiro
继续输出数据库设计和后续内容：

-- 继续 coupon_info_00 表定义
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='观影券信息表';

-- 需要创建 coupon_info_00 ~ coupon_info_99 共100张表

-- ==================== 观影券变更日志表（分100表）====================
CREATE TABLE IF NOT EXISTS `coupon_change_log_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  KEY `ix_coupon_token` (`coupon_token`),
  KEY `ix_mid` (`mid`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='观影券变更日志表';

-- ==================== 代金券信息表（分10表）====================
CREATE TABLE IF NOT EXISTS `coupon_allowance_info_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态:0未使用,1使用中,2已使用',
  `start_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '开始时间',
  `expire_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '过期时间',
  `origin` tinyint(4) NOT NULL DEFAULT '0' COMMENT '来源:1系统发放,2业务领取,3新年活动,4兑换码',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '优惠金额',
  `full_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '满额条件',
  `app_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '应用ID',
  `remark` varchar(128) NOT NULL DEFAULT '' COMMENT '备注',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_coupon_token` (`coupon_token`),
  KEY `ix_mid_state` (`mid`,`state`),
  KEY `ix_order_no` (`order_no`),
  KEY `ix_mid_batch` (`mid`,`batch_token`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='代金券信息表';

-- 需要创建 coupon_allowance_info_00 ~ coupon_allowance_info_09 共10张表

-- ==================== 代金券变更日志表（分10表）====================
CREATE TABLE IF NOT EXISTS `coupon_allowance_change_log_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态',
  `change_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '变更类型:1发放,2消费,3取消,4消费成功,5消费失败,6领取',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  KEY `ix_coupon_token` (`coupon_token`),
  KEY `ix_mid` (`mid`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='代金券变更日志表';

-- ==================== 漫画券余额表（分10表）====================
CREATE TABLE IF NOT EXISTS `coupon_balance_info_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `balance` bigint(20) NOT NULL DEFAULT '0' COMMENT '余额',
  `start_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '开始时间',
  `expire_time` bigint(20) NOT NULL DEFAULT '0' COMMENT '过期时间',
  `origin` tinyint(4) NOT NULL DEFAULT '0' COMMENT '来源',
  `coupon_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '券类型',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_mid_batch` (`mid`,`batch_token`),
  KEY `ix_mid_type` (`mid`,`coupon_type`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='漫画券余额表';

-- ==================== 漫画券余额变更日志表（分10表）====================
CREATE TABLE IF NOT EXISTS `coupon_balance_change_log_00` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `balance` bigint(20) NOT NULL DEFAULT '0' COMMENT '变更后余额',
  `change_balance` bigint(20) NOT NULL DEFAULT '0' COMMENT '变更数量',
  `change_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '变更类型:1VIP发放,2系统发放,3消费,4消费失败退回',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  KEY `ix_mid_batch` (`mid`,`batch_token`),
  KEY `ix_order_no` (`order_no`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='漫画券余额变更日志表';

-- ==================== 优惠券订单表 ====================
CREATE TABLE IF NOT EXISTS `coupon_order` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `count` bigint(20) NOT NULL DEFAULT '0' COMMENT '使用数量',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态:0待支付,1支付中,2支付成功,3支付失败',
  `coupon_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '券类型',
  `third_trade_no` varchar(64) NOT NULL DEFAULT '' COMMENT '第三方交易号',
  `remark` varchar(128) NOT NULL DEFAULT '' COMMENT '备注',
  `tips` varchar(128) NOT NULL DEFAULT '' COMMENT '提示',
  `use_ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '使用版本',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `ix_mid_state_type` (`mid`,`state`,`coupon_type`),
  KEY `ix_third_trade_no` (`third_trade_no`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券订单表';

-- ==================== 优惠券订单日志表 ====================
CREATE TABLE IF NOT EXISTS `coupon_order_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  KEY `ix_order_no` (`order_no`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券订单日志表';

-- ==================== 兑换码表 ====================
CREATE TABLE IF NOT EXISTS `coupon_code` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `code` varchar(32) NOT NULL DEFAULT '' COMMENT '兑换码',
  `state` tinyint(4) NOT NULL DEFAULT '1' COMMENT '状态:1未使用,2已使用,3已冻结',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '使用者ID',
  `coupon_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '券类型',
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '兑换后的券Token',
  `ver` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本号',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`),
  KEY `ix_batch_token` (`batch_token`),
  KEY `ix_mid` (`mid`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='兑换码表';

-- ==================== 领取日志表 ====================
CREATE TABLE IF NOT EXISTS `coupon_receive_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `appkey` varchar(32) NOT NULL DEFAULT '' COMMENT '应用Key',
  `order_no` varchar(64) NOT NULL DEFAULT '' COMMENT '订单号',
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `coupon_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '券类型',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_appkey_order_type` (`appkey`,`order_no`,`coupon_type`),
  KEY `ix_mid` (`mid`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='领取日志表';

-- ==================== 用户卡片表（新年活动）====================
CREATE TABLE IF NOT EXISTS `coupon_user_card` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `mid` bigint(20) NOT NULL DEFAULT '0' COMMENT '用户ID',
  `card_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '卡片类型:0月度,1季度,2年度',
  `state` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态:0未开,1已开,2已使用',
  `batch_token` varchar(64) NOT NULL DEFAULT '' COMMENT '批次Token',
  `coupon_token` varchar(64) NOT NULL DEFAULT '' COMMENT '券Token',
  `act_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '活动ID',
  `ctime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_mid_act_card` (`mid`,`act_id`,`card_type`),
  KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户卡片表';
四、核心 Logic 实现
4.1 常量定义 (model/vars.go)
package model

// 优惠券使用状态
const (
    UseFaild   int8 = 0
    UseSuccess int8 = 1
)

// 优惠券状态
const (
    NotUsed int32 = 0 // 未使用
    InUse   int32 = 1 // 使用中
    Used    int32 = 2 // 已使用
    Expire  int32 = 3 // 已过期
    Block   int32 = 4 // 已冻结
)

// 支付状态
const (
    WaitPay    int8 = 0
    InPay      int8 = 1
    PaySuccess int8 = 2
    PayFaild   int8 = 3
)

// 最大发放数量
const MaxSalaryCount = 100

// 余额变更类型
const (
    VipSalary         int8 = 1 // VIP发放
    SystemAdminSalary int8 = 2 // 系统发放
    Consume           int8 = 3 // 消费
    ConsumeFaildBack  int8 = 4 // 消费失败退回
)

// 优惠券类型
const (
    CouponVideo     int8 = 1 // 观影券
    CouponCartoon   int8 = 2 // 漫画券
    CouponAllowance int8 = 3 // 代金券
)

// 代金券来源
const (
    AllowanceNone            int8 = 0
    AllowanceSystemAdmin     int8 = 1 // 系统发放
    AllowanceBusinessReceive int8 = 2 // 业务领取
    AllowanceBusinessNewYear int8 = 3 // 新年活动
    AllowanceCodeOpen        int8 = 4 // 兑换码
)

// 批次状态
const (
    BatchStateNormal int8 = 0 // 正常
    BatchStateBlock  int8 = 1 // 冻结
)

// 代金券不可用原因
const (
    CouponHadBlock             = "代金券已被冻结"
    CouponFullAmountDissatisfy = "未达到满额条件"
    CouponNotInUsableTime      = "当前不在有效期内"
    CouponInUse                = "已绑定在其他未支付订单,点击解锁"
    CouponPlatformExplain      = "当前平台不可使用"
    CouponProductExplain       = "当前商品不可使用"
)

// 代金券提示
const (
    CouponTipNotUse      = "不使用代金券"
    CouponTipChooseOther = "选中其他商品有惊喜"
    CouponTipUse         = "抵扣%.2f元"
    CouponTipInUse       = "有代金券被锁定"
)

// 代金券可用状态
const (
    AllowanceDisables int8 = 0
    AllowanceUsable   int8 = 1
)

// 代金券变更类型
const (
    AllowanceSalary         int8 = 1 // 发放
    AllowanceConsume        int8 = 2 // 消费
    AllowanceCancel         int8 = 3 // 取消
    AllowanceConsumeSuccess int8 = 4 // 消费成功
    AllowanceConsumeFaild   int8 = 5 // 消费失败
    AllowanceReceive        int8 = 6 // 领取
)

// 支付通知状态
const (
    AllowanceUseFaild   int8 = 0
    AllowanceUseSuccess int8 = 1
)

// 兑换码状态
const (
    CodeStateNotUse int32 = 1 // 未使用
    CodeStateUsed   int32 = 2 // 已使用
    CodeStateBlock  int32 = 3 // 已冻结
)

// 设备类型
const (
    DeviceIOS         int = 1
    DeviceIPAD        int = 2
    DevicePC          int = 3
    DeviceANDROID     int = 4
    DeviceIPADHD      int = 5
    DeviceIOSBLUE     int = 6
    DeviceANDROIDBLUE int = 7
    DevicePUBLIC      int = 8
)

// 平台名称映射
var PlatformByName = map[string]int{
    "ios":       DeviceIOS,
    "ios_b":     DeviceIOS,
    "ipad":      DeviceIPAD,
    "ipadhd":    DeviceIPAD,
    "pc":        DevicePC,
    "public":    DevicePC,
    "android":   DeviceANDROID,
    "android_b": DeviceANDROID,
}

// 商品月份限制
const (
    ProdLimMonthNone int8 = 0
    ProdLimMonth1    int8 = 1
    ProdLimMonth3    int8 = 3
    ProdLimMonth12   int8 = 12
)

// 续费限制
const (
    ProdLimRenewalAll     int8 = 0 // 不限
    ProdLimRenewalAuto    int8 = 1 // 自动续期
    ProdLimRenewalNotAuto int8 = 2 // 非自动续期
)
4.2 代金券核心逻辑 (allowance_logic.go 示例)
package logic

import (
    "context"
    "fmt"
    "sort"
    "strings"
    "time"

    "mybilibili/app/coupon/cmd/rpc/coupon"
    "mybilibili/app/coupon/cmd/rpc/internal/svc"
    "mybilibili/app/coupon/model"
    "mybilibili/common/xerr"

    "github.com/zeromicro/go-zero/core/logx"
    "github.com/zeromicro/go-zero/core/stores/sqlx"
)

type UsableAllowanceCouponV2Logic struct {
    ctx    context.Context
    svcCtx *svc.ServiceContext
    logx.Logger
}

func NewUsableAllowanceCouponV2Logic(ctx context.Context, svcCtx *svc.ServiceContext) *UsableAllowanceCouponV2Logic {
    return &UsableAllowanceCouponV2Logic{
        ctx:    ctx,
        svcCtx: svcCtx,
        Logger: logx.WithContext(ctx),
    }
}

// UsableAllowanceCouponV2 获取可用代金券V2
func (l *UsableAllowanceCouponV2Logic) UsableAllowanceCouponV2(in *coupon.UsableAllowanceCouponV2Req) (*coupon.UsableAllowanceCouponV2Resp, error) {
    resp := &coupon.UsableAllowanceCouponV2Resp{
        CouponTip: model.CouponTipNotUse,
    }

    if len(in.PriceInfo) == 0 {
        return resp, nil
    }

    // 1. 获取用户未使用的代金券
    notUsedList, err := l.getAllowanceCoupons(in.Mid, model.NotUsed)
    if err != nil {
        return nil, err
    }

    // 2. 获取用户使用中的代金券
    inUseList, err := l.getAllowanceCoupons(in.Mid, model.InUse)
    if err != nil {
        return nil, err
    }

    all := append(notUsedList, inUseList...)
    if len(all) == 0 {
        return resp, nil
    }

    selectedPrice := in.PriceInfo[0].Price
    var maxAmount float64
    var bestCoupon *coupon.CouponAllowancePanelInfo
    var selectedCoupon *coupon.CouponAllowancePanelInfo

    // 3. 遍历每个价格，找出最优券
    for _, priceInfo := range in.PriceInfo {
        usables, _, using, err := l.filterUsableCoupons(
            in.Mid,
            priceInfo.Price,
            all,
            int(priceInfo.Plat),
            int8(priceInfo.ProdLimMonth),
            int8(priceInfo.ProdLimRenewal),
        )
        if err != nil {
            return nil, err
        }

        availables := append(usables, using...)
        if len(availables) == 0 {
            continue
        }

        // 按金额排序
        sort.Slice(availables, func(i, j int) bool {
            if availables[i].CouponAmount == availables[j].CouponAmount {
                return availables[i].Usable > availables[j].Usable
            }
            return availables[i].CouponAmount > availables[j].CouponAmount
        })

        if availables[0].CouponAmount > maxAmount {
            maxAmount = availables[0].CouponAmount
            bestCoupon = availables[0]
        }

        if priceInfo.Price == selectedPrice {
            selectedCoupon = availables[0]
            break
        }
    }

    if bestCoupon == nil {
        return resp, nil
    }

    // 4. 设置返回提示
    switch {
    case bestCoupon.Usable == model.AllowanceUsable:
        resp.CouponTip = fmt.Sprintf(model.CouponTipUse, bestCoupon.CouponAmount)
        resp.CouponInfo = bestCoupon
    case bestCoupon.State == model.InUse:
        resp.CouponTip = model.CouponTipInUse
    case selectedCoupon == nil:
        resp.CouponTip = model.CouponTipChooseOther
    }

    return resp, nil
}

// getAllowanceCoupons 获取代金券列表（带缓存）
func (l *UsableAllowanceCouponV2Logic) getAllowanceCoupons(mid int64, state int32) ([]*model.CouponAllowanceInfo, error) {
    now := time.Now().Unix()

    // 1. 尝试从缓存获取
    cacheKey := fmt.Sprintf("coupon:allowance:%d:%d", mid, state)
    var list []*model.CouponAllowanceInfo

    err := l.svcCtx.Cache.GetCtx(l.ctx, cacheKey, &list)
    if err == nil && list != nil {
        // 过滤过期的
        result := make([]*model.CouponAllowanceInfo, 0)
        for _, c := range list {
            if c.ExpireTime > now {
                result = append(result, c)
            }
        }
        return result, nil
    }

    // 2. 从数据库查询
    list, err = l.svcCtx.CouponAllowanceModel.FindByMidAndState(l.ctx, mid, state, now)
    if err != nil {
        return nil, xerr.NewErrCode(xerr.DB_ERROR)
    }

    // 3. 设置缓存
    if len(list) > 0 {
        _ = l.svcCtx.Cache.SetCtx(l.ctx, cacheKey, list)
    }

    return list, nil
}

// filterUsableCoupons 筛选可用券
func (l *UsableAllowanceCouponV2Logic) filterUsableCoupons(
    mid int64,
    price float64,
    all []*model.CouponAllowanceInfo,
    plat int,
    prodLimMonth, prodLimRenewal int8,
) (usables, disables, using []*coupon.CouponAllowancePanelInfo, err error) {
    now := time.Now().Unix()
    usables = make([]*coupon.CouponAllowancePanelInfo, 0)
    disables = make([]*coupon.CouponAllowancePanelInfo, 0)
    using = make([]*coupon.CouponAllowancePanelInfo, 0)

    for _, c := range all {
        // 获取批次信息
        batch, ok := l.svcCtx.BatchInfoCache[c.BatchToken]
        if !ok || batch == nil {
            continue
        }

        if batch.State == model.BatchStateBlock {
            continue
        }

        ok = true
        explains := make([]string, 0)

        // 平台限制检查
        if !l.platformLimit(batch.PlatformLimit, plat) {
            explains = append(explains, model.CouponPlatformExplain)
            ok = false
        }

        // 商品限制检查
        if !l.productLimit(batch.ProdLimMonth, batch.ProdLimRenewal, prodLimMonth, prodLimRenewal) {
            explains = append(explains, model.CouponProductExplain)
            ok = false
        }

        // 满额检查
        if c.FullAmount > price {
            explains = append(explains, model.CouponFullAmountDissatisfy)
            ok = false
        }

        // 开始时间检查
        if c.StartTime > now {
            explains = append(explains, model.CouponNotInUsableTime)
            ok = false
        }

        // 使用中状态处理
        if c.State == model.InUse {
            if len(explains) > 0 {
                c.State = model.NotUsed
            }
            if ok {
                using = append(using, l.convertToPanelInfo(c, explains, price, model.AllowanceDisables))
            }
            ok = false
        }

        if ok {
            usables = append(usables, l.convertToPanelInfo(c, explains, price, model.AllowanceUsable))
        } else {
            disables = append(disables, l.convertToPanelInfo(c, explains, price, model.AllowanceDisables))
        }
    }

    // 可用券排序：按过期时间升序，金额降序
    if len(usables) > 0 {
        sort.Slice(usables, func(i, j int) bool {
            return usables[i].ExpireTime < usables[j].ExpireTime
        })
        sort.Slice(usables, func(i, j int) bool {
            return usables[i].CouponAmount > usables[j].CouponAmount
        })
        usables[0].Selected = 1
    }

    return
}

// platformLimit 平台限制验证
func (l *UsableAllowanceCouponV2Logic) platformLimit(pstr string, plat int) bool {
    if len(pstr) == 0 {
        return true
    }
    ps := strings.Split(pstr, ",")
    for _, v := range ps {
        if v == fmt.Sprintf("%d", plat) {
            return true
        }
    }
    return false
}

// productLimit 商品限制验证
func (l *UsableAllowanceCouponV2Logic) productLimit(bplm, bplr, plm, plr int8) bool {
    if bplm == model.ProdLimMonthNone && bplr == model.ProdLimRenewalAll {
        return true
    }
    if bplm == model.ProdLimMonthNone && bplr == plr {
        return true
    }
    if bplr == model.ProdLimRenewalAll && bplm == plm {
        return true
    }
    if bplm == plm && bplr == plr {
        return true
    }
    return false
}

// convertToPanelInfo 转换为面板信息
func (l *UsableAllowanceCouponV2Logic) convertToPanelInfo(
    c *model.CouponAllowanceInfo,
    explains []string,
    price float64,
    usable int8,
) *coupon.CouponAllowancePanelInfo {
    return &coupon.CouponAllowancePanelInfo{
        CouponToken:         c.CouponToken,
        CouponAmount:        c.Amount,
        State
Credits used: 2.55
Elapsed time: 1m 22s
Checkpoint
Restore
继续往下输出方案

Kiro
继续输出方案：

        // convertToPanelInfo 续
        State:               c.State,
        FullLimitExplain:    fmt.Sprintf("满%.0f元可用", c.FullAmount),
        FullAmount:          c.FullAmount,
        StartTime:           c.StartTime,
        ExpireTime:          c.ExpireTime,
        CouponDiscountPrice: price - c.Amount,
        DisablesExplains:    strings.Join(explains, ","),
        OrderNo:             c.OrderNO,
        Name:                "大会员代金券",
        Usable:              int32(usable),
    }
}
4.3 使用代金券逻辑 (use_allowance_logic.go)
package logic

import (
    "context"
    "fmt"
    "time"

    "mybilibili/app/coupon/cmd/rpc/coupon"
    "mybilibili/app/coupon/cmd/rpc/internal/svc"
    "mybilibili/app/coupon/model"
    "mybilibili/common/xerr"

    "github.com/zeromicro/go-zero/core/logx"
)

type UseAllowanceCouponLogic struct {
    ctx    context.Context
    svcCtx *svc.ServiceContext
    logx.Logger
}

func NewUseAllowanceCouponLogic(ctx context.Context, svcCtx *svc.ServiceContext) *UseAllowanceCouponLogic {
    return &UseAllowanceCouponLogic{
        ctx:    ctx,
        svcCtx: svcCtx,
        Logger: logx.WithContext(ctx),
    }
}

func (l *UseAllowanceCouponLogic) UseAllowanceCoupon(in *coupon.UseAllowanceCouponReq) (*coupon.UseAllowanceCouponResp, error) {
    // 1. 验证券是否可用
    cp, err := l.judgeCouponUsable(
        in.Mid,
        in.Price,
        in.CouponToken,
        model.PlatformByName[in.Platform],
        int8(in.ProdLimMonth),
        int8(in.ProdLimRenewal),
    )
    if err != nil {
        return nil, err
    }

    // 2. 检查订单是否已绑定券
    exist, err := l.svcCtx.CouponAllowanceModel.FindByOrderNo(l.ctx, in.Mid, in.OrderNo)
    if err != nil {
        return nil, xerr.NewErrCode(xerr.DB_ERROR)
    }
    if exist != nil {
        return nil, xerr.NewErrMsg("订单已绑定优惠券")
    }

    // 3. 更新券状态为使用中
    err = l.updateAllowanceCoupon(cp, model.InUse, in.Remark, in.OrderNo, model.AllowanceConsume)
    if err != nil {
        return nil, err
    }

    return &coupon.UseAllowanceCouponResp{}, nil
}

// judgeCouponUsable 验证券是否可用
func (l *UseAllowanceCouponLogic) judgeCouponUsable(mid int64, price float64, couponToken string, plat int, prodLimMonth, prodLimRenewal int8) (*model.CouponAllowanceInfo, error) {
    now := time.Now().Unix()

    // 1. 查询券信息
    cp, err := l.svcCtx.CouponAllowanceModel.FindByToken(l.ctx, mid, couponToken)
    if err != nil {
        return nil, xerr.NewErrCode(xerr.DB_ERROR)
    }
    if cp == nil {
        return nil, xerr.NewErrMsg("优惠券不存在")
    }

    // 2. 获取批次信息
    batch, ok := l.svcCtx.BatchInfoCache[cp.BatchToken]
    if !ok || batch == nil {
        return nil, xerr.NewErrMsg("批次不存在")
    }

    // 3. 批次状态检查
    if batch.State != model.BatchStateNormal {
        return nil, xerr.NewErrMsg("优惠券已被冻结")
    }

    // 4. 券状态检查
    if cp.State != model.NotUsed {
        return nil, xerr.NewErrMsg("优惠券已被使用")
    }

    // 5. 有效期检查
    if cp.StartTime > now || now > cp.ExpireTime {
        return nil, xerr.NewErrMsg("优惠券不在有效期内")
    }

    // 6. 满额检查
    if cp.FullAmount > price {
        return nil, xerr.NewErrMsg("未达到满额条件")
    }

    // 7. 平台限制检查
    if !l.platformLimit(batch.PlatformLimit, plat) {
        return nil, xerr.NewErrMsg("当前平台不可使用")
    }

    // 8. 商品限制检查
    if !l.productLimit(batch.ProdLimMonth, batch.ProdLimRenewal, prodLimMonth, prodLimRenewal) {
        return nil, xerr.NewErrMsg("当前商品不可使用")
    }

    return cp, nil
}

// updateAllowanceCoupon 更新券状态（事务）
func (l *UseAllowanceCouponLogic) updateAllowanceCoupon(cp *model.CouponAllowanceInfo, state int32, remark, orderNo string, changeType int8) error {
    return l.svcCtx.DB.TransactCtx(l.ctx, func(ctx context.Context, session sqlx.Session) error {
        // 1. 更新券状态
        err := l.svcCtx.CouponAllowanceModel.UpdateState(ctx, session, cp.Id, cp.Mid, state, orderNo, remark, cp.Ver)
        if err != nil {
            return err
        }

        // 2. 插入变更日志
        changeLog := &model.CouponAllowanceChangeLog{
            CouponToken: cp.CouponToken,
            OrderNo:     orderNo,
            Mid:         cp.Mid,
            State:       int8(state),
            ChangeType:  changeType,
            Ctime:       time.Now(),
        }
        err = l.svcCtx.CouponAllowanceChangeLogModel.Insert(ctx, session, changeLog)
        if err != nil {
            return err
        }

        return nil
    })

    // 3. 删除缓存
    l.svcCtx.Cache.DelCtx(l.ctx, fmt.Sprintf("coupon:allowance:%d:%d", cp.Mid, model.NotUsed))
    l.svcCtx.Cache.DelCtx(l.ctx, fmt.Sprintf("coupon:allowance:%d:%d", cp.Mid, model.InUse))

    return nil
}

func (l *UseAllowanceCouponLogic) platformLimit(pstr string, plat int) bool {
    // 同上
}

func (l *UseAllowanceCouponLogic) productLimit(bplm, bplr, plm, plr int8) bool {
    // 同上
}
4.4 Service Context (svc/service_context.go)
package svc

import (
    "context"
    "sync"
    "time"

    "mybilibili/app/coupon/cmd/rpc/internal/config"
    "mybilibili/app/coupon/model"

    "github.com/zeromicro/go-zero/core/logx"
    "github.com/zeromicro/go-zero/core/stores/cache"
    "github.com/zeromicro/go-zero/core/stores/redis"
    "github.com/zeromicro/go-zero/core/stores/sqlx"
)

type ServiceContext struct {
    Config config.Config
    DB     sqlx.SqlConn
    Redis  *redis.Redis
    Cache  cache.Cache

    // Models
    CouponBatchInfoModel          model.CouponBatchInfoModel
    CouponInfoModel               model.CouponInfoModel
    CouponChangeLogModel          model.CouponChangeLogModel
    CouponAllowanceModel          model.CouponAllowanceInfoModel
    CouponAllowanceChangeLogModel model.CouponAllowanceChangeLogModel
    CouponBalanceModel            model.CouponBalanceInfoModel
    CouponOrderModel              model.CouponOrderModel
    CouponCodeModel               model.CouponCodeModel
    CouponReceiveLogModel         model.CouponReceiveLogModel

    // 批次信息缓存（内存）
    BatchInfoCache map[string]*model.CouponBatchInfo
    batchMu        sync.RWMutex
}

func NewServiceContext(c config.Config) *ServiceContext {
    db := sqlx.NewMysql(c.Mysql.DataSource)
    rds := redis.MustNewRedis(c.RedisConf)
    cacheNode := cache.New(c.CacheRedis, nil, cache.NewStat("coupon"), nil)

    svc := &ServiceContext{
        Config: c,
        DB:     db,
        Redis:  rds,
        Cache:  cacheNode,

        CouponBatchInfoModel:          model.NewCouponBatchInfoModel(db, cacheNode),
        CouponInfoModel:               model.NewCouponInfoModel(db, cacheNode),
        CouponChangeLogModel:          model.NewCouponChangeLogModel(db),
        CouponAllowanceModel:          model.NewCouponAllowanceInfoModel(db, cacheNode),
        CouponAllowanceChangeLogModel: model.NewCouponAllowanceChangeLogModel(db),
        CouponBalanceModel:            model.NewCouponBalanceInfoModel(db, cacheNode),
        CouponOrderModel:              model.NewCouponOrderModel(db, cacheNode),
        CouponCodeModel:               model.NewCouponCodeModel(db, cacheNode),
        CouponReceiveLogModel:         model.NewCouponReceiveLogModel(db),

        BatchInfoCache: make(map[string]*model.CouponBatchInfo),
    }

    // 启动批次信息加载
    svc.loadBatchInfo()
    go svc.loadBatchInfoLoop()

    return svc
}

// loadBatchInfo 加载批次信息到内存
func (s *ServiceContext) loadBatchInfo() {
    ctx := context.Background()
    list, err := s.CouponBatchInfoModel.FindAll(ctx)
    if err != nil {
        logx.Errorf("loadBatchInfo error: %v", err)
        return
    }

    s.batchMu.Lock()
    defer s.batchMu.Unlock()

    tmp := make(map[string]*model.CouponBatchInfo, len(list))
    for _, v := range list {
        tmp[v.BatchToken] = v
    }
    s.BatchInfoCache = tmp
    logx.Infof("loadBatchInfo success, count: %d", len(tmp))
}

// loadBatchInfoLoop 定时刷新批次信息
func (s *ServiceContext) loadBatchInfoLoop() {
    ticker := time.NewTicker(time.Minute)
    defer ticker.Stop()

    for range ticker.C {
        s.loadBatchInfo()
    }
}

// GetBatchInfo 获取批次信息
func (s *ServiceContext) GetBatchInfo(batchToken string) *model.CouponBatchInfo {
    s.batchMu.RLock()
    defer s.batchMu.RUnlock()
    return s.BatchInfoCache[batchToken]
}
五、实施计划
5.1 阶段一：基础架构（1天）
# 1. 创建目录结构
mkdir -p mybilibili/app/coupon/cmd/api/desc
mkdir -p mybilibili/app/coupon/cmd/api/etc
mkdir -p mybilibili/app/coupon/cmd/rpc/etc
mkdir -p mybilibili/app/coupon/model

# 2. 创建数据库表
mysql -h127.0.0.1 -P33060 -uroot -proot123456 mybilibili < deploy/sql/020_coupon_schema.sql

# 3. 编写 proto 文件并生成代码
cd mybilibili/app/coupon/cmd/rpc
/Users/zh/go/bin/goctl rpc protoc coupon.proto --go_out=. --go-grpc_out=. --zrpc_out=. --style go_zero

# 4. 编写 api 文件并生成代码
cd mybilibili/app/coupon/cmd/api
/Users/zh/go/bin/goctl api go -api desc/coupon.api -dir . --style go_zero
5.2 阶段二：Model 层实现（1天）
| 任务 | 说明 | |-----|------| | coupon_batch_info_model.go | 批次信息表（不分表） | | coupon_info_model.go | 观影券表（分100表） | | coupon_allowance_info_model.go | 代金券表（分10表） | | coupon_balance_info_model.go | 漫画券余额表（分10表） | | coupon_order_model.go | 订单表（不分表） | | coupon_code_model.go | 兑换码表（不分表） | | vars.go | 常量定义 |

5.3 阶段三：RPC 核心逻辑（2天）
| 优先级 | Logic | 说明 | |-------|-------|------| | P0 | usable_allowance_coupon_v2_logic.go | 获取可用代金券 | | P0 | use_allowance_coupon_logic.go | 使用代金券 | | P0 | cancel_allowance_coupon_logic.go | 取消使用代金券 | | P0 | allowance_coupon_notify_logic.go | 支付结果通知 | | P1 | salary_coupon_logic.go | 发放优惠券 | | P1 | receive_allowance_logic.go | 领取代金券 | | P1 | use_coupon_code_logic.go | 使用兑换码 | | P2 | user_coupon_logic.go | 观影券列表 | | P2 | coupon_page_logic.go | 券分页列表 |

5.4 阶段四：API 层实现（0.5天）
实现 API Logic 层，调用 RPC 服务
配置中间件（Auth、日志等）
编写配置文件
5.5 阶段五：测试与部署（0.5天）
# 1. 启动基础服务
cd mybilibili/deploy && docker-compose up -d

# 2. 启动 RPC 服务
cd mybilibili/app/coupon/cmd/rpc && go run coupon.go -f etc/coupon.yaml

# 3. 启动 API 服务
cd mybilibili/app/coupon/cmd/api && go run coupon.go -f etc/coupon.yaml

# 4. 测试接口
# 获取可用代金券
curl -X POST http://localhost:8080/api/coupon/v1/allowance/usable \
  -H "Content-Type: application/json" \
  -d '{"price_info":[{"price":25,"plat":3,"prod_lim_month":1,"prod_lim_renewal":0}]}'
六、配置文件示例
6.1 RPC 配置 (etc/coupon.yaml)
Name: coupon.rpc
ListenOn: 0.0.0.0:9080

Etcd:
  Hosts:
    - 127.0.0.1:2379
  Key: coupon.rpc

Mysql:
  DataSource: root:root123456@tcp(127.0.0.1:33060)/mybilibili?charset=utf8mb4&parseTime=true&loc=Local

RedisConf:
  Host: 127.0.0.1:6379
  Type: node
  Pass: ""

CacheRedis:
  - Host: 127.0.0.1:6379
    Type: node
    Pass: ""

Telemetry:
  Name: coupon.rpc
  Endpoint: http://127.0.0.1:14268/api/traces
  Sampler: 1.0
  Batcher: jaeger
6.2 API 配置 (etc/coupon.yaml)
Name: coupon.api
Host: 0.0.0.0
Port: 8085

CouponRpc:
  Etcd:
    Hosts:
      - 127.0.0.1:2379
    Key: coupon.rpc

Auth:
  AccessSecret: "your-secret-key"
  AccessExpire: 86400

Telemetry:
  Name: coupon.api
  Endpoint: http://127.0.0.1:14268/api/traces
  Sampler: 1.0
  Batcher: jaeger
七、总结
核心要点
完全参照主项目：业务逻辑、表结构、分表策略完全一致
分表设计：观影券100表、代金券/漫画券10表
分布式锁：使用 Redis 防止并发问题
缓存策略：批次信息内存缓存 + 用户券列表 Redis 缓存
事务处理：券状态变更使用数据库事务保证一致性
工作量估算
| 阶段 | 工作量 | |-----|--------| | 基础架构 | 1天 | | Model 层 | 1天 | | RPC 核心逻辑 | 2天 | | API 层 | 0.5天 | | 测试部署 | 0.5天 | | 总计 | 5天 |

方案输出完毕，确认后可以开始实施。
```

AGENTS.md 2 - 585

- 
- 

~~~md
# MyBilibili AI 开发助手指南

> **版本**: v1.2.0  
> **更新时间**: 2025-12-20  
> **项目**: MyBilibili - 基于 go-zero 的微服务重构项目
> **重要更新**: 必须使用 goctl 工具生成代码（包括 pb 文件）

---

## 📋 项目概述

MyBilibili 是从 openbilibili 主项目模仿实现的微服务系统，使用 go-zero 框架重构。

### 项目结构
```
mybilibili/
├── app/                          # 业务服务
│   ├── api/                      # HTTP 网关
│   ├── creative/                 # 创作中心 API
│   ├── hotrank/                  # 热门排行榜（已重构）
│   ├── recall/                   # 召回服务
│   ├── recommend/                # 推荐服务（已重构）
│   ├── video/                    # 视频服务（已重构）
│   └── wallet/                   # 虚拟钱包（已重构）⭐参考模板
├── common/                       # 公共组件
│   ├── model/                    # 公共数据模型
│   ├── result/                   # 统一响应
│   ├── tool/                     # 工具函数
│   └── xerr/                     # 错误码
├── deploy/                       # 部署配置
│   ├── sql/                      # SQL 脚本
│   └── docker-compose.yml
├── doc/                          # 文档
└── 设计与修复方案/                # 设计文档
```

### 参考项目
- **主项目**: `openbilibili/` - 业务逻辑和表结构的唯一参考来源
- **重构模板**: `mybilibili/app/wallet/` - go-zero 最佳实践参考

---

## 🎯 核心开发准则

### 准则一：严格遵循 go-zero 最佳实践

**微服务分层架构**：
```
API 服务层（HTTP）
    ↓ gRPC
RPC 服务层（核心业务）
    ↓
Model 层（数据访问）
    ↓
MySQL / Redis / Kafka
```

**标准目录结构**（以 wallet 为模板）：
```
app/{module}/
├── cmd/
│   ├── api/                    # HTTP API 服务
│   │   ├── desc/{module}.api   # API 定义文件
│   │   ├── etc/{module}.yaml   # 配置文件
│   │   └── internal/
│   │       ├── config/         # 配置结构
│   │       ├── handler/        # HTTP Handler
│   │       ├── logic/          # 业务逻辑
│   │       ├── svc/            # 服务上下文
│   │       └── types/          # 类型定义
│   └── rpc/                    # gRPC 服务
│       ├── {module}.proto      # Protobuf 定义
│       ├── etc/{module}.yaml   # 配置文件
│       └── internal/
│           ├── config/         # 配置结构
│           ├── logic/          # 核心业务逻辑 ⭐
│           ├── server/         # gRPC 服务器
│           └── svc/            # 服务上下文
└── model/                      # 数据模型
```

### 准则二：业务实现完全参照 openbilibili

**⚠️ 重要：不要私自改动业务逻辑**

1. **查找主项目对应模块**：
   ```
   openbilibili/app/service/main/{module}/    # 主站服务
   openbilibili/app/service/live/{module}/    # 直播服务
   openbilibili/app/interface/main/{module}/  # 接口层
   ```

2. **参考内容**：
   - 业务流程和算法
   - 数据校验规则
   - 错误处理逻辑
   - 常量和枚举定义

3. **示例**：钱包模块参考
   ```
   主项目: openbilibili/app/service/live/wallet/
   重构后: mybilibili/app/wallet/
   ```

### 准则三：表结构完全参照主项目

**数据库设计原则**：
- 表名、字段名、类型完全一致
- 索引设计参照主项目
- 分表策略保持一致

**SQL 脚本位置**：`deploy/sql/`

**命名规范**：
```
001_init.sql              # 基础表
002_test_data.sql         # 测试数据
010_wallet_schema.sql     # 钱包模块
03_recommend.sql          # 推荐模块
```

### 准则四：开发前输出技术设计文档

**每次重构新模块前，必须先输出设计文档**，包含：

1. **概述与架构**
   - 项目目标和要求
   - 微服务划分
   - 目录结构设计
   - 核心设计（锁机制、分表策略等）

2. **接口与实现**
   - Protobuf 接口定义
   - API 接口定义
   - 核心 Logic 实现代码
   - Model 层实现

3. **实施计划**
   - 分阶段实施步骤
   - 测试方案
   - 部署方案

**设计文档位置**：`设计与修复方案/`

**命名规范**：
```
v{版本}-{模块名}-总览.md
v{版本}-{模块名}-第1部分-概述与架构.md
v{版本}-{模块名}-第2部分-接口与实现.md
v{版本}-{模块名}-第3部分-实施计划.md
```

### 准则五：技术栈参考已重构模块

**核心技术栈**：
- **框架**: go-zero v1.6+
- **数据库**: MySQL 8.0
- **缓存**: Redis 7
- **服务发现**: etcd
- **消息队列**: Kafka
- **链路追踪**: Jaeger
- **监控**: Prometheus + Grafana

**参考模块**：
- `app/wallet/` - 虚拟钱包（分布式事务、双重锁、分表）
- `app/recommend/` - 推荐系统（召回、排序、特征工程）
- `app/hotrank/` - 热门排行（定时任务、批量更新）

### 准则六：必须使用 /Users/zh/go/bin/goctl 工具生成代码 ⭐⭐⭐

**� 强制要求：所有代码必须通过 /Users/zh/go/bin/goctl 工具生成，禁止手写框架代码！**

**为什么必须使用 /Users/zh/go/bin/goctl**：
1. 保证代码结构与 go-zero 框架完全兼容
2. 避免手写代码导致的格式、命名不一致
3. 自动生成 handler、logic、types、server 等样板代码
4. 确保 gRPC 和 HTTP 接口定义的一致性

**/Users/zh/go/bin/goctl 代码生成命令**：

```bash
# ==================== RPC 服务代码生成 ====================
# 进入 RPC 目录
cd app/{module}/cmd/rpc

# 生成 gRPC 代码（必须使用此命令）
/Users/zh/go/bin/goctl rpc protoc {module}.proto \
    --go_out=. \
    --go-grpc_out=. \
    --zrpc_out=. \
    --style go_zero

# ==================== API 服务代码生成 ====================
# 进入 API 目录
cd app/{module}/cmd/api

# 生成 HTTP API 代码（必须使用此命令）
/Users/zh/go/bin/goctl api go \
    -api desc/{module}.api \
    -dir . \
    --style go_zero

# ==================== Model 代码生成（可选）====================
# 从 SQL 文件生成 Model
/Users/zh/go/bin/goctl model mysql ddl \
    -src {table}.sql \
    -dir ./model \
    -c \
    --style go_zero

# 从数据库连接生成 Model
/Users/zh/go/bin/goctl model mysql datasource \
    -url "root:password@tcp(127.0.0.1:3306)/dbname" \
    -table "{table_name}" \
    -dir ./model \
    -c \
    --style go_zero
```

**开发工作流程**：

```
1. 编写 .proto 文件（定义 RPC 接口）
       ↓
2. 执行 /Users/zh/go/bin/goctl rpc protoc 生成 RPC 代码
       ↓
3. 编写 .api 文件（定义 HTTP 接口）
       ↓
4. 执行 /Users/zh/go/bin/goctl api go 生成 API 代码
       ↓
5. 只修改 logic 层实现业务逻辑
       ↓
6. 只修改 svc 层添加依赖注入
```

**⚠️ 禁止手写的文件**：
- `internal/handler/*.go` - 必须由 /Users/zh/go/bin/goctl 生成
- `internal/types/types.go` - 必须由 /Users/zh/go/bin/goctl 生成
- `internal/server/*_server.go` - 必须由 /Users/zh/go/bin/goctl 生成
- `{module}.go` (main 入口) - 必须由 /Users/zh/go/bin/goctl 生成
- `*_grpc.pb.go` / `*.pb.go` - 必须由 /Users/zh/go/bin/goctl 生成

**✅ 允许手动修改的文件**：
- `internal/logic/*.go` - 业务逻辑实现
- `internal/svc/service_context.go` - 服务上下文
- `internal/config/config.go` - 配置结构扩展
- `etc/*.yaml` - 配置文件
- `model/*.go` - 数据模型（或用 /Users/zh/go/bin/goctl 生成后修改）

**接口变更时的操作**：

```bash
# 当 .proto 文件有变更时，重新生成
cd app/{module}/cmd/rpc
/Users/zh/go/bin/goctl rpc protoc {module}.proto --go_out=. --go-grpc_out=. --zrpc_out=. --style go_zero

# 当 .api 文件有变更时，重新生成
cd app/{module}/cmd/api
/Users/zh/go/bin/goctl api go -api desc/{module}.api -dir . --style go_zero

# 注意：重新生成会覆盖 handler/types/server，但不会覆盖 logic 和 svc
```

---

## 📝 开发流程

### 阶段一：需求分析与设计

```markdown
1. 确认要重构的模块
2. 在 openbilibili 中找到对应模块
3. 分析业务逻辑和数据结构
4. 输出技术设计文档（必须）
5. 等待确认后开始实施
```

### 阶段二：基础架构搭建

```bash
# 1. 创建目录结构
mkdir -p app/{module}/cmd/api/desc
mkdir -p app/{module}/cmd/api/etc
mkdir -p app/{module}/cmd/rpc/etc
mkdir -p app/{module}/model

# 2. 编写 Protobuf 定义
# app/{module}/cmd/rpc/{module}.proto

# 3. 生成 RPC 代码
cd app/{module}/cmd/rpc
/Users/zh/go/bin//Users/zh/go/bin/goctl rpc protoc {module}.proto --go_out=. --go-grpc_out=. --zrpc_out=. --style go_zero

# 4. 编写 API 定义
# app/{module}/cmd/api/desc/{module}.api

# 5. 生成 API 代码
cd app/{module}/cmd/api
/Users/zh/go/bin//Users/zh/go/bin/goctl api go -api desc/{module}.api -dir . --style go_zero

# 6. 创建数据库表
# deploy/sql/0XX_{module}_schema.sql
```

### 阶段三：核心功能实现

```markdown
1. 实现 Model 层（参照主项目表结构）
2. 实现 RPC Service Context
3. 实现 RPC Logic（核心业务逻辑）
4. 实现 API Service Context
5. 实现 API Logic（聚合调用）
6. 编写配置文件
```

### 阶段四：测试与验证

```bash
# 1. 启动基础服务
cd deploy && docker-compose up -d

# 2. 初始化数据库
mysql -h127.0.0.1 -P33060 -uroot -proot123456 < deploy/sql/0XX_{module}_schema.sql

# 3. 启动 RPC 服务
cd app/{module}/cmd/rpc && go run {module}.go -f etc/{module}.yaml

# 4. 启动 API 服务
cd app/{module}/cmd/api && go run {module}.go -f etc/{module}.yaml

# 5. 测试接口
curl http://localhost:800X/api/{module}/v1/xxx
```

---

## 🔧 代码规范

### Protobuf 定义规范

```protobuf
syntax = "proto3";

package {module};
option go_package = "./{module}";

// ==================== 服务定义 ====================
service {Module} {
  // 方法注释
  rpc MethodName(MethodReq) returns(MethodResp);
}

// ==================== 请求/响应定义 ====================
message MethodReq {
  int64 uid = 1;                    // 字段注释
  string field = 2;                 // 字段注释
}

message MethodResp {
  int64 code = 1;                   // 响应码
  string msg = 2;                   // 响应消息
}
```

### API 定义规范

```go
syntax = "v1"

info (
    title:   "{模块名} API"
    desc:    "{模块描述}"
    author:  "mybilibili"
    version: "v1.0.0"
)

// ==================== 数据结构定义 ====================
type MethodReq {
    Uid    int64  `json:"uid"`
    Field  string `json:"field"`
}

type MethodResp {
    Data interface{} `json:"data"`
}

// ==================== 路由定义 ====================
@server (
    prefix: /api/{module}/v1
    group:  {group}
)
service {module} {
    @doc "接口描述"
    @handler MethodName
    post /path (MethodReq) returns (MethodResp)
}
```

### Service Context 规范

```go
package svc

import (
    "mybilibili/app/{module}/cmd/rpc/internal/config"
    "mybilibili/app/{module}/model"
    
    "github.com/zeromicro/go-zero/core/stores/redis"
    "github.com/zeromicro/go-zero/core/stores/sqlx"
)

type ServiceContext struct {
    Config config.Config
    
    // MySQL 连接
    DB sqlx.SqlConn
    
    // Redis 连接
    Redis *redis.Redis
    
    // Model 层
    XxxModel model.XxxModel
}

func NewServiceContext(c config.Config) *ServiceContext {
    db := sqlx.NewMysql(c.Mysql.DataSource)
    
    rds := redis.New(c.RedisConf.Host, func(r *redis.Redis) {
        r.Type = c.RedisConf.Type
        r.Pass = c.RedisConf.Pass
    })
    
    return &ServiceContext{
        Config:   c,
        DB:       db,
        Redis:    rds,
        XxxModel: model.NewXxxModel(db, c.CacheRedis),
    }
}
```

### Logic 实现规范

```go
package logic

import (
    "context"
    
    "mybilibili/app/{module}/cmd/rpc/internal/svc"
    "mybilibili/app/{module}/cmd/rpc/{module}"
    "mybilibili/common/xerr"
    
    "github.com/zeromicro/go-zero/core/logx"
)

type XxxLogic struct {
    ctx    context.Context
    svcCtx *svc.ServiceContext
    logx.Logger
}

func NewXxxLogic(ctx context.Context, svcCtx *svc.ServiceContext) *XxxLogic {
    return &XxxLogic{
        ctx:    ctx,
        svcCtx: svcCtx,
        Logger: logx.WithContext(ctx),
    }
}

func (l *XxxLogic) Xxx(in *{module}.XxxReq) (*{module}.XxxResp, error) {
    // 1. 参数校验
    if in.Uid <= 0 {
        return nil, xerr.NewErrCode(xerr.REQUEST_PARAM_ERROR)
    }
    
    // 2. 业务逻辑（参照主项目实现）
    // ...
    
    // 3. 返回结果
    return &{module}.XxxResp{}, nil
}
```

---

## 📚 参考资源

### 已重构模块（可作为模板）

| 模块 | 路径 | 特点 |
|-----|------|------|
| wallet | `app/wallet/` | 分布式事务、双重锁、分表、Kafka |
| recommend | `app/recommend/` | 召回、排序、特征工程 |
| hotrank | `app/hotrank/` | 定时任务、批量更新、游标分页 |
| video | `app/video/` | 基础 CRUD、缓存策略 |

### 主项目模块对照

| 主项目路径 | 说明 |
|-----------|------|
| `openbilibili/app/service/main/` | 主站核心服务 |
| `openbilibili/app/service/live/` | 直播相关服务 |
| `openbilibili/app/interface/main/` | 接口层 |
| `openbilibili/app/admin/` | 管理后台 |
| `openbilibili/app/job/` | 定时任务 |

### 文档资源

- `doc/GO-ZERO-BEST-PRACTICES.md` - go-zero 最佳实践
- `设计与修复方案/` - 各模块设计文档
- `gozero重构准则.md` - 重构准则

---

## ⚠️ 注意事项

### 必须遵守

1. **不要私自修改业务逻辑** - 完全参照 openbilibili
2. **不要简化方案** - 保持与主项目一致的复杂度
3. **先输出设计文档** - 每次重构前必须先设计
4. **表结构完全一致** - 不要修改字段名和类型
5. **必须使用 /Users/zh/go/bin/goctl 生成代码** ⭐ - 禁止手写 handler/types/server 等框架代码
6. **接口变更必须重新生成** - 修改 .proto 或 .api 后必须执行 /Users/zh/go/bin/goctl 命令

### 常见问题

1. **服务发现问题**
   - 开发环境使用 `127.0.0.1` 而非 `0.0.0.0`
   - 检查 etcd 注册地址

2. **RPC 调用失败**
   - 检查服务是否启动
   - 检查配置文件中的 RPC 地址

3. **数据库连接问题**
   - 确认 MySQL 服务运行
   - 检查连接字符串格式

4. **/Users/zh/go/bin/goctl 生成代码问题**
   - 确保 /Users/zh/go/bin/goctl 版本与 go-zero 版本匹配：`/Users/zh/go/bin/goctl --version`
   - proto 文件语法错误：先用 `protoc` 验证
   - api 文件语法错误：检查 type 定义和路由格式
   - 生成失败时检查 `go_package` 配置是否正确

5. **代码被覆盖问题**
   - /Users/zh/go/bin/goctl 重新生成会覆盖 handler/types/server
   - logic 和 svc 不会被覆盖，业务代码安全
   - 如需保留自定义 handler，考虑使用中间件

---

## 🚀 快速开始模板

当需要重构新模块时，请按以下步骤进行：

```markdown
## 第一步：确认模块信息

请告诉我：
1. 要重构的模块名称
2. 主项目中对应的路径
3. 核心功能列表

## 第二步：我将输出技术设计文档

包含：
- 概述与架构
- 接口定义
- 实施计划

## 第三步：确认后开始实施

按照设计文档逐步实现：
1. 基础架构
2. 核心功能
3. 测试验证
```

---

**准备就绪，开始重构！** 🎉
~~~

 现在开始一步一步完成系统的重构



Kiro

好的，现在开始按照设计方案一步一步实施 coupon 系统的重构。

## 阶段一：基础架构搭建

### 步骤 1：创建目录结构

Command

```
mkdir -p mybilibili/app/coupon/cmd/api/desc
```

------

```
➜  bilibili
```

Command

```
mkdir -p mybilibili/app/coupon/cmd/api/etc
```

------

```
➜  bilibili
```

Command

```
mkdir -p mybilibili/app/coupon/cmd/rpc/etc
```

------

```
➜  bilibili
```

Command

```
mkdir -p mybilibili/app/coupon/model
```

------

```
➜  bilibili
```

### 步骤 2：创建 Protobuf 定义文件



3 edits to file

coupon.proto

- 
- 

### 步骤 3：使用 goctl 生成 RPC 代码

Command

```
/Users/zh/go/bin/goctl rpc protoc coupon.proto --go_out=. --go-grpc_out=. --zrpc_out=. --style go_zero
```

------

```
"protoc-gen-go" installed from cache
"protoc-gen-go-grpc" installed from cache
Error: protoc-gen-go: program not found or is not executable
Please specify a program using absolute path or make sure the program is available in you
r PATH system variable                                                                   --go_out: protoc-gen-go: Plugin failed with status code 1.
Usage:
  goctl rpc protoc [flags]

Examples:
goctl rpc protoc xx.proto --go_out=./pb --go-grpc_out=./pb --zrpc_out=.

Flags:
      --branch string     The branch of the remote repo, it does work with --remote
  -c, --client            Whether to generate rpc client (default true)
  -h, --help              help for protoc
      --home string       The goctl home path of the template, --home and --remote cannot
 be set at the same time, if they are, --remote has higher priority                            --module string     
  -m, --multiple          Generated in multiple rpc service mode
      --remote string     The remote git repo of the template, --home and --remote cannot
 be set at the same time, if they are, --remote has higher priority                                                The git repo directory must be consistent with the https://gith
ub.com/zeromicro/go-zero-template directory structure                                          --style string      The file naming format, see [https://github.com/zeromicro/go-ze
ro/blob/master/tools/goctl/config/readme.md]                                               -v, --verbose           Enable log output
      --zrpc_out string   The zrpc output directory


protoc-gen-go: program not found or is not executable
Please specify a program using absolute path or make sure the program is available in you
r PATH system variable                                                                   --go_out: protoc-gen-go: Plugin failed with status code 1.
```

需要设置 PATH 环境变量：

Command

```
export PATH=$PATH:/Users/zh/go/bin && /Users/zh/go/bin/goctl rpc protoc coupon.proto --go_out=. --go-grpc_out=. --zrpc_out=. --style go_zero
```

------

```
Done.
```

### 步骤 4：创建 API 定义文件



3 edits to file

coupon.api

- 
- 

### 步骤 5：使用 goctl 生成 API 代码

Command

```
export PATH=$PATH:/Users/zh/go/bin && /Users/zh/go/bin/goctl api go -api desc/coupon.api -dir . --style go_zero
```

------

```
Done.
```

### 步骤 6：创建数据库 Schema 文件



2 edits to file

020_coupon_schema.sql

- 
- 

现在创建分表的 SQL（观影券100表、代金券10表）：



3 edits to file

021_coupon_sharding.sql

- 
- 

### 步骤 7：创建 Model 层常量定义



2 edits to file

vars.go

- 
- 

### 步骤 8：创建配置文件

Accepted edits to

coupon.yaml

- 
- 

Accepted edits to

coupon.yaml

- 
- 

### 步骤 9：查看生成的目录结构

Searched workspace

查看 coupon 模块生成的目录结构

基础架构已经搭建完成。现在进入阶段二：Model 层实现。

## 阶段二：Model 层实现

### 步骤 1：创建批次信息表 Model



2 edits to file

coupon_batch_info_model.go

- 
- 

### 步骤 2：创建代金券信息表 Model（分10表）



2 edits to file

coupon_allowance_info_model.go

- 
- 

### 步骤 3：创建代金券变更日志表 Model

Created

coupon_allowance_change_log_model.go

- 
- 

### 步骤 4：创建兑换码表 Model

Created

coupon_code_model.go

- 
- 

### 步骤 5：创建领取日志表 Model

Created

coupon_receive_log_model.go

- 
- 

### 步骤 6：更新 RPC 配置结构

Read file(s)

config.go

Accepted edits to

config.go

- 
- 

### 步骤 7：更新 RPC Service Context

Read file(s)

service_context.go



2 edits to file

service_context.go

- 
- 

## 阶段三：RPC 核心逻辑实现

### 步骤 1：实现获取可用代金券 V2 逻辑

Read file(s)

usable_allowance_coupon_v2_logic.go



2 edits to file

usable_allowance_coupon_v2_logic.go

- 
- 

### 步骤 2：实现使用代金券逻辑

Read file(s)

use_allowance_coupon_logic.go

Accepted edits to

use_allowance_coupon_logic.go

- 
- 

Conversation above has been summarized

The conversation in this session is about to reach the agent context limit. I'm summarizing earlier messages, and only the summary will be sent to the agent as context instead of the full text.
