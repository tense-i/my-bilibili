# MyBilibili 虚拟钱包系统设计方案 v2.0.0（第1部分）

> **版本**: v2.0.0  
> **创建时间**: 2025-11-09  
> **状态**: 设计阶段

---

## 一、项目概述

### 1.1 目标

基于 Bilibili 主项目的 `app/service/live/wallet` 模块，为 MyBilibili 实现完整的**虚拟钱包系统**。

### 1.2 核心要求

1. ✅ **严格按照主项目业务逻辑**：完整实现充值、消费、兑换
2. ✅ **严格按照主项目数据层**：保持数据模型一致
3. ✅ **使用go-zero最佳实践**：参考mybilibili现有模块
4. ✅ **分布式事务支持**：使用DTM或本地事务+锁机制
5. ✅ **不简化方案**：可分步实现，但功能完整

### 1.3 简历亮点对应

**双币种账户体系**：金瓜子（gold/iap_gold）和银瓜子（silver），iOS/Android差异化处理  
**分布式事务保障**：TransactionID锁+用户锁+FOR UPDATE，ACID特性  
**实时清算系统**：完整流水记录+快照机制，99.99%一致性  

### 1.4 技术栈

- go-zero v1.6.1
- MySQL 8.0（分表）
- Redis 7（锁+缓存）
- Kafka（消息队列）
- etcd（服务发现）

---

## 二、系统架构

### 2.1 微服务划分

```
wallet-api (HTTP网关)
   ├─ POST /api/wallet/v1/recharge   # 充值
   ├─ POST /api/wallet/v1/pay        # 消费
   ├─ POST /api/wallet/v1/exchange   # 兑换
   ├─ GET  /api/wallet/v1/detail     # 查询
   └─ GET  /api/wallet/v1/stream     # 流水

wallet-rpc (gRPC服务)
   ├─ Recharge()   # 充值RPC
   ├─ Pay()        # 消费RPC
   ├─ Exchange()   # 兑换RPC
   ├─ GetDetail()  # 查询RPC
   └─ GetStreamList() # 流水RPC
```

### 2.2 目录结构

```
mybilibili/app/wallet/
├── cmd/
│   ├── api/                    # HTTP API
│   │   ├── desc/wallet.api
│   │   ├── etc/wallet-api.yaml
│   │   ├── internal/
│   │   │   ├── config/
│   │   │   ├── handler/
│   │   │   ├── logic/          ⭐API业务逻辑
│   │   │   ├── svc/
│   │   │   └── types/
│   │   └── wallet.go
│   │
│   └── rpc/                    # gRPC服务
│       ├── etc/wallet.yaml
│       ├── internal/
│       │   ├── config/
│       │   ├── logic/          ⭐RPC核心逻辑
│       │   │   ├── recharge_logic.go
│       │   │   ├── pay_logic.go
│       │   │   ├── exchange_logic.go
│       │   │   ├── detail_logic.go
│       │   │   └── stream_logic.go
│       │   ├── server/
│       │   └── svc/
│       ├── pb/
│       ├── wallet.proto
│       ├── wallet_client/
│       └── wallet.go
│
└── model/                      # 数据模型
    ├── user_wallet_model.go
    ├── coin_stream_record_model.go
    └── coin_exchange_record_model.go
```

### 2.3 核心流程图

**充值流程：**
```
1. 参数校验
2. TransactionID锁（Redis，300s）
3. 用户锁（Redis，600s）
4. 开启MySQL事务
5. SELECT FOR UPDATE（悲观锁）
6. UPDATE余额 + INSERT流水
7. COMMIT
8. 删除缓存
9. 发布Kafka消息
```

**消费流程：**
```
1-5. 同充值
6. 余额检查（防超支）
7. UPDATE扣款 + INSERT流水（失败也记录）
8-9. 同充值
```

**兑换流程：**
```
1-5. 同充值
6. 源币种余额检查
7. UPDATE原子兑换（一条SQL）
8. INSERT两条流水 + INSERT兑换记录
9-10. 同充值
```

---

## 三、核心设计（严格参考主项目）

### 3.1 双重锁机制

```go
// 1. TransactionID锁（防重复提交）
key := fmt.Sprintf("wallet:lock:tid:%s", tid)
redis.Setnx(key, "locked", 300) // 5分钟

// 2. 用户锁（防并发超支）
key := fmt.Sprintf("wallet:lock:user:%d", uid)
redis.Setnx(key, lockValue, 600) // 10分钟

// 3. 数据库悲观锁
SELECT * FROM user_wallet_X WHERE uid=? FOR UPDATE
```

### 3.2 分表策略

```go
// user_wallet_0 ~ user_wallet_9（按uid取模）
tableIndex := uid % 10

// coin_stream_record_0 ~ coin_stream_record_9（按tid hash）
h := fnv.New32a()
h.Write([]byte(tid))
tableIndex := h.Sum32() % 10
```

### 3.3 快照机制（每日对账）

```go
type UserWallet struct {
    // 当前余额
    Gold    int64
    IapGold int64
    Silver  int64
    
    // 快照（每日0点更新）
    SnapshotTime    string
    SnapshotGold    int64
    SnapshotIapGold int64
    SnapshotSilver  int64
}

// 对账公式
// 昨日快照 + 今日充值 - 今日消费 + 今日兑换 = 今日余额
```

---

## 四、数据库设计

### 4.1 user_wallet表（分10张）

```sql
CREATE TABLE `user_wallet_0` (
  `uid` bigint(20) NOT NULL,
  `gold` bigint(20) NOT NULL DEFAULT '0' COMMENT '金瓜子',
  `iap_gold` bigint(20) NOT NULL DEFAULT '0' COMMENT 'iOS金瓜子',
  `silver` bigint(20) NOT NULL DEFAULT '0' COMMENT '银瓜子',
  `gold_recharge_cnt` bigint(20) NOT NULL DEFAULT '0',
  `gold_pay_cnt` bigint(20) NOT NULL DEFAULT '0',
  `silver_pay_cnt` bigint(20) NOT NULL DEFAULT '0',
  `cost_base` bigint(20) NOT NULL DEFAULT '0',
  
  `snapshot_time` datetime DEFAULT NULL,
  `snapshot_gold` bigint(20) DEFAULT '0',
  `snapshot_iap_gold` bigint(20) DEFAULT '0',
  `snapshot_silver` bigint(20) DEFAULT '0',
  
  `reserved1` bigint(20) DEFAULT '0',
  `reserved2` varchar(255) DEFAULT '',
  `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `mtime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`uid`)
) ENGINE=InnoDB COMMENT='用户钱包';
```

### 4.2 coin_stream_record表（分10张）

```sql
CREATE TABLE `coin_stream_record_0` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `uid` bigint(20) NOT NULL,
  `transaction_id` varchar(64) NOT NULL,
  `extend_tid` varchar(64) DEFAULT '',
  `coin_type` int(11) NOT NULL COMMENT '1=gold 2=iap_gold 3=silver',
  `delta_coin_num` bigint(20) NOT NULL COMMENT '变化（正负）',
  `org_coin_num` bigint(20) NOT NULL COMMENT '原余额',
  `op_result` int(11) NOT NULL COMMENT '1=增加成功 -1=减少失败',
  `op_reason` int(11) DEFAULT '0' COMMENT '0=成功 1=余额不足',
  `op_type` int(11) NOT NULL COMMENT '1=充值 2=消费 3=兑换',
  `op_time` datetime NOT NULL,
  `biz_code` varchar(64) DEFAULT '',
  `platform` int(11) DEFAULT '0',
  PRIMARY KEY (`id`),
  KEY `idx_uid` (`uid`),
  KEY `idx_tid` (`transaction_id`)
) ENGINE=InnoDB COMMENT='流水记录';
```

### 4.3 coin_exchange_record表

```sql
CREATE TABLE `coin_exchange_record` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `uid` bigint(20) NOT NULL,
  `transaction_id` varchar(64) NOT NULL,
  `src_coin_type` int(11) NOT NULL,
  `src_coin_num` bigint(20) NOT NULL,
  `dest_coin_type` int(11) NOT NULL,
  `dest_coin_num` bigint(20) NOT NULL,
  `exchange_rate` decimal(10,4) DEFAULT '1.0000',
  `status` int(11) DEFAULT '1',
  `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_uid` (`uid`)
) ENGINE=InnoDB COMMENT='兑换记录';
```

---

**继续阅读：**
- 第2部分：Protobuf定义与核心业务逻辑实现
- 第3部分：分步实现计划与测试方案
