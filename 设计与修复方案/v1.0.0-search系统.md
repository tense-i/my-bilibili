MyBilibili 搜索服务模块设计方案 v1.0.0

## 一、项目概述

### 1.1 目标

基于 Bilibili 主项目的 `app/service/main/search` 模块，为 MyBilibili 实现完整的**内部搜索服务**，支持弹幕搜索、PGC番剧搜索、评论记录搜索等功能。

### 1.2 核心要求

1. **业务逻辑严格按照主项目**：保持核心搜索流程一致
2. **数据层严格按照主项目构建**：保持 Elasticsearch 索引结构和分片策略一致
3. **支持多集群 ES 部署**：不同业务使用不同 ES 集群
4. **支持索引更新**：提供索引增量更新接口

### 1.3 技术栈

- **Go 1.21+**
- **go-zero** 微服务框架
- **Elasticsearch 7.x**: 全文搜索引擎
- **Redis**: 热门搜索词缓存（可选）
- **etcd**: 服务发现
- **Prometheus**: 监控指标

------

## 二、系统架构设计

### 2.1 总体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     API 网关层                               │
│                   (search-api)                              │
│                                                              │
│  HTTP 接口:                                                  │
│  - GET  /x/internal/search/dm          弹幕搜索              │
│  - GET  /x/internal/search/dm/date     弹幕日期搜索          │
│  - GET  /x/internal/search/dmhistory   弹幕历史搜索          │
│  - GET  /x/internal/search/pgc         PGC番剧搜索           │
│  - GET  /x/internal/search/reply       评论记录搜索          │
│  - POST /x/internal/search/dm/update   弹幕索引更新          │
│  - POST /x/internal/search/pgc/update  PGC索引更新           │
│  - POST /x/internal/search/reply/update 评论索引更新         │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ gRPC
                        ↓
┌─────────────────────────────────────────────────────────────┐
│              搜索服务 (search-rpc)                           │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  1. 参数解析与校验                                    │  │
│  │     - 基础搜索参数 (BasicSearchParams)                │  │
│  │     - 业务特定参数                                    │  │
│  └──────────────────────────────────────────────────────┘  │
│                        ↓                                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  2. 查询构建 (Query Builder)                         │  │
│  │     - Bool Query 组合                                 │  │
│  │     - Term/Terms 精确匹配                             │  │
│  │     - Range 范围查询                                  │  │
│  │     - MultiMatch 全文搜索                             │  │
│  │     - Regexp 正则匹配                                 │  │
│  └──────────────────────────────────────────────────────┘  │
│                        ↓                                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  3. ES 集群路由                                       │  │
│  │     - dmExternal: 弹幕搜索集群                        │  │
│  │     - externalPublic: PGC番剧集群                     │  │
│  │     - replyExternal: 评论记录集群                     │  │
│  └──────────────────────────────────────────────────────┘  │
│                        ↓                                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  4. 索引路由 (Index Router)                          │  │
│  │     - dm_search_{oid%1000}: 弹幕按OID分片             │  │
│  │     - dm_date_{YYYY_MM}: 弹幕按月份分片               │  │
│  │     - pgc_media: PGC单索引                            │  │
│  │     - replyrecord_{mid%100}: 评论按MID分片            │  │
│  └──────────────────────────────────────────────────────┘  │
│                        ↓                                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  5. 结果处理                                          │  │
│  │     - 排序 (Score/Field Sort)                         │  │
│  │     - 分页 (From/Size)                                │  │
│  │     - 字段过滤 (Source Filter)                        │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                        │
                        ↓
        ┌──────────────────────────────────────┐
        │     Elasticsearch 集群               │
        │                                      │
        │  ┌────────────────────────────────┐ │
        │  │ dmExternal 集群                │ │
        │  │ - dm_search_000 ~ dm_search_999│ │
        │  │ - dm_date_2024_01 ~ ...        │ │
        │  └────────────────────────────────┘ │
        │                                      │
        │  ┌────────────────────────────────┐ │
        │  │ externalPublic 集群            │ │
        │  │ - pgc_media                    │ │
        │  └────────────────────────────────┘ │
        │                                      │
        │  ┌────────────────────────────────┐ │
        │  │ replyExternal 集群             │ │
        │  │ - replyrecord_00 ~ replyrecord_99│
        │  └────────────────────────────────┘ │
        └──────────────────────────────────────┘
```

### 2.2 服务划分

#### 服务1: `search-rpc`（搜索核心服务）

- **职责**: 搜索核心逻辑、ES 查询执行
- **端口**: 9007 (RPC), 9097 (Metrics)
- **依赖**: Elasticsearch, Redis (可选)
- **核心模块**:
  - `internal/logic/`: 各搜索业务逻辑
  - `internal/svc/`: 服务上下文（ES客户端）
  - `model/`: ES 客户端封装

#### 服务2: `search-api`（HTTP API 网关）

- **职责**: HTTP 接口暴露、参数校验
- **端口**: 8888 (HTTP)
- **依赖**: search-rpc
- **核心模块**:
  - `internal/handler/`: HTTP 处理器
  - `internal/logic/`: 业务逻辑（调用 RPC）

------

## 三、数据层设计（严格按照主项目）

### 3.1 Elasticsearch 索引设计

#### 3.1.1 弹幕搜索索引 (`dm_search_{000-999}`)

**分片策略**: `oid % 1000`

**索引映射**:

```json
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "dm_analyzer": {
          "type": "custom",
          "tokenizer": "ik_max_word",
          "filter": ["lowercase"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id": { "type": "long" },
      "oid": { "type": "long" },
      "oidstr": { "type": "keyword" },
      "mid": { "type": "long" },
      "content": { 
        "type": "text", 
        "analyzer": "dm_analyzer",
        "search_analyzer": "ik_smart"
      },
      "mode": { "type": "integer" },
      "pool": { "type": "integer" },
      "progress": { "type": "integer" },
      "state": { "type": "integer" },
      "type": { "type": "integer" },
      "attr": { "type": "integer" },
      "attr_format": { "type": "integer" },
      "fontsize": { "type": "integer" },
      "color": { "type": "integer" },
      "ctime": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      },
      "mtime": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      }
    }
  }
}
```

**字段说明**:

| **字段名** | **类型** | **说明**       | **备注**                   |
| ---------- | -------- | -------------- | -------------------------- |
| **id**     | long     | 弹幕 ID        | 全局唯一标识符             |
| **oid**    | long     | 对象 ID        | 通常指视频的 CID (Chat ID) |
| **oidstr** | keyword  | 对象 ID 字符串 | 优化精确查询，不分词       |
| **mid**    | long     | 发送者用户 ID  | 关联用户信息               |

| **字段名**   | **类型** | **说明**         | **取值参考**                      |
| ------------ | -------- | ---------------- | --------------------------------- |
| **content**  | text     | **弹幕文本内容** | 支持全文搜索                      |
| **progress** | integer  | 出现时间点       | 单位：**毫秒 (ms)**               |
| **mode**     | integer  | 弹幕模式         | 1:滚动, 4:底部, 5:顶部            |
| **fontsize** | integer  | 字体大小         | 例如: 25                          |
| **color**    | integer  | 颜色值           | 十进制颜色码 (如 16777215 为白色) |

| **字段名**      | **类型** | **说明** | **取值参考**                |
| --------------- | -------- | -------- | --------------------------- |
| **pool**        | integer  | 弹幕池   | 0:普通, 1:字幕, 2:特殊      |
| **type**        | integer  | 弹幕类型 | 区分普通弹幕、代码弹幕等    |
| **state**       | integer  | 状态控制 | 0:正常, 1:删除, 2:保护/精选 |
| **attr**        | integer  | 属性位   | 位运算存储多个标签          |
| **attr_format** | integer  | 属性格式 | 辅助解析 attr 字段          |

#### 3.1.2 弹幕日期索引 (`dm_date_{YYYY_MM}`)

**分片策略**: 按月份分片，如 `dm_date_2024_01`

**索引映射**:

```json
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "id": { "type": "long" },
      "oid": { "type": "long" },
      "month": { "type": "keyword" },
      "date": { "type": "keyword" },
      "total": { "type": "long" },
      "ctime": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      }
    }
  }
}
```

**字段说明**:

#### 3.1.3 PGC番剧索引 (`pgc_media`)

**分片策略**: 单索引

**索引映射**:

```json
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "title_analyzer": {
          "type": "custom",
          "tokenizer": "ik_max_word",
          "filter": ["lowercase"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "media_id": { "type": "long" },
      "season_id": { "type": "long" },
      "title": { 
        "type": "text", 
        "analyzer": "title_analyzer",
        "fields": {
          "keyword": { "type": "keyword" }
        }
      },
      "season_type": { "type": "integer" },
      "style_id": { "type": "long" },
      "status": { "type": "integer" },
      "release_date": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      },
      "producer_id": { "type": "long" },
      "is_deleted": { "type": "integer" },
      "area_id": { "type": "keyword" },
      "score": { "type": "float" },
      "is_finish": { "type": "keyword" },
      "season_version": { "type": "integer" },
      "season_status": { "type": "integer" },
      "pub_time": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      },
      "season_month": { "type": "integer" },
      "latest_time": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      },
      "copyright_info": { "type": "keyword" },
      "dm_count": { "type": "long" },
      "play_count": { "type": "long" },
      "fav_count": { "type": "long" },
      "ctime": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      },
      "mtime": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      }
    }
  }
}
```

**字段说明**:

| **字段名**         | **类型** | **说明**     | **备注**                                |
| ------------------ | -------- | ------------ | --------------------------------------- |
| **media_id**       | long     | 媒体 ID      | 对应作品大类 ID                         |
| **season_id**      | long     | 季度 ID      | 对应具体某季（如《进击的巨人 第一季》） |
| **title**          | text     | 番剧标题     | 支持全文搜索                            |
| **season_type**    | integer  | 季度类型     | 1:番剧, 2:电影, 3:纪录片, 4:国创        |
| **style_id**       | long     | 风格 ID      | 关联热血、恋爱、科幻等标签              |
| **area_id**        | keyword  | 地区 ID      | 如：日本、中国大陆、美国等              |
| **producer_id**    | long     | 制作方 ID    | 关联动画制作公司（如 MAPPA, BONES）     |
| **status**         | integer  | 状态         | 全局状态控制                            |
| **is_deleted**     | integer  | 是否删除     | 逻辑删除标记（0:未删, 1:已删）          |
| **score**          | float    | 评分         | 观众综合评分（如 9.8）                  |
| **is_finish**      | keyword  | 是否完结     | 标识连载状态                            |
| **copyright_info** | keyword  | 版权信息     | 涉及独家、首播、限免等权属              |
| **season_version** | integer  | 季度版本     | 区分 TV 版、OVA、剧场版等               |
| **season_status**  | integer  | 季度状态     | 标识预热、热映、下架等                  |
| **release_date**   | date     | 发布日期     | 正式上架日期                            |
| **pub_time**       | date     | 发布时间     | 精确的发布时刻                          |
| **season_month**   | integer  | 季度月份     | 对应 1月、4月、7月、10月新番档期        |
| **latest_time**    | date     | 最新更新时间 | 最后一次剧集更新的时间                  |
| **dm_count**       | long     | 弹幕数       | 该番剧累计弹幕总量                      |
| **play_count**     | long     | 播放数       | 累计播放播放次数                        |
| **fav_count**      | long     | 收藏数       | 追番（订阅）人数                        |

#### 3.1.4 评论记录索引 (`replyrecord_{00-99}`)

**分片策略**: `mid % 100`

**索引映射**:

```json
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "reply_analyzer": {
          "type": "custom",
          "tokenizer": "ik_max_word",
          "filter": ["lowercase"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id": { "type": "long" },
      "oid": { "type": "long" },
      "mid": { "type": "long" },
      "type": { "type": "integer" },
      "state": { "type": "integer" },
      "content": { 
        "type": "text", 
        "analyzer": "reply_analyzer" 
      },
      "like": { "type": "long" },
      "hate": { "type": "long" },
      "rcount": { "type": "integer" },
      "floor": { "type": "integer" },
      "ctime": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      },
      "mtime": { 
        "type": "date", 
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis" 
      }
    }
  }
}
```

**字段说明**:

| **字段名**  | **类型** | **说明**     | **备注**                                   |
| ----------- | -------- | ------------ | ------------------------------------------ |
| **id**      | long     | 评论 ID      | 全局唯一标识（主键）                       |
| **oid**     | long     | 对象 ID      | 评论所属的主体（如视频 ID、动态 ID）       |
| **type**    | integer  | 评论类型     | 1:视频, 2:话题, 3:活动 (用于区分 oid 来源) |
| **mid**     | long     | 用户 ID      | 发送评论的用户唯一标识                     |
| **content** | text     | **评论内容** | 支持全文搜索                               |
| **floor**   | integer  | 楼层         | 该评论在当前对象下的排队序号               |
| **state**   | integer  | 状态         | 0:正常, 1:删除, 2:隐藏/待审                |
| **like**    | long     | 点赞数       | 认可该评论的人数                           |
| **hate**    | long     | 点踩数       | 反对该评论的人数                           |
| **rcount**  | integer  | 回复数       | 该评论下的二级回复（子评论）数量           |
| **ctime**   | date     | 创建时间     | 评论发布的原始时间                         |
| **mtime**   | date     | 修改时间     | 评论最后被编辑或状态变更的时间             |

### 3.2 ES 集群配置

| **集群名**         | **核心用途**     | **对应索引**                          | **包含模型 (前文所述)**                    | **索引策略建议**                                             |
| ------------------ | ---------------- | ------------------------------------- | ------------------------------------------ | ------------------------------------------------------------ |
| **dmExternal**     | **弹幕搜索**     | `dm_search*` (全文) `dm_date*` (按天) | 弹幕 ID, 内容, 出现时间 (progress), 颜色等 | **滚动索引 (Rollover)**：弹幕量极大，建议按月或按千万级条数自动分片。 |
| **externalPublic** | **PGC番剧搜索**  | `pgc_media`                           | 标题, 风格, 地区, 评分, 播放量等           | **配置字典优化**：对 style_id 和 area_id 进行 Mapping 优化，支持精准筛选。 |
| **replyExternal**  | **评论记录搜索** | `replyrecord_*`                       | 评论内容, 用户 ID, 楼层, 点赞数等          | **冷热分离**：近期评论存入热索引，一年前的评论进入压缩后的冷索引。 |

### 3.3 Redis 数据结构（可选）

#### 3.3.1 热门搜索词缓存

```
Key: search:hot:{type}
Type: ZSet
Score: 搜索次数
Member: 搜索关键词
TTL: 3600 (1小时)
示例: ZADD search:hot:dm 100 "初音未来" 80 "鬼畜"
```

#### 3.3.2 搜索结果缓存

```
Key: search:cache:{type}:{hash(params)}
Type: String (JSON)
TTL: 300 (5分钟)
说明: 缓存高频搜索结果
```

------

## 四、核心业务逻辑（严格按照主项目）

### 4.1 基础搜索参数

```go
// BasicSearchParams 基础搜索参数（与主项目一致）
type BasicSearchParams struct {
    AppID    string   `form:"app_id" params:"app_id"`       // 应用ID
    KW       string   `form:"kw" params:"kw"`               // 搜索关键词
    KwFields []string `form:"kw_fields,split" params:"kw_fields"` // 关键词搜索字段
    Order    []string `form:"order,split" params:"order"`   // 排序字段
    Sort     []string `form:"sort,split" params:"sort"`     // 排序方式 asc/desc
    Pn       int32    `form:"pn" params:"pn" default:"1"`   // 页码
    Ps       int32    `form:"ps" params:"ps" default:"20"`  // 每页数量
    Debug    bool     `form:"debug" params:"debug"`         // 调试模式
    Source   []string // 返回字段列表
}
```

### 4.2 弹幕搜索 (DmSearch)

#### 请求参数

```go
type DmSearchParams struct {
    Bsp        *BasicSearchParams
    Oid        int64  `form:"oid" params:"oid" default:"-1"`        // 对象ID
    Mid        int64  `form:"mid" params:"mid" default:"-1"`        // 用户ID
    Mode       int    `form:"mode" params:"mode" default:"-1"`      // 弹幕模式
    Pool       int    `form:"pool" params:"pool" default:"-1"`      // 弹幕池
    Progress   int    `form:"progress" params:"progress" default:"-1"` // 进度
    States     []int  `form:"states,split" params:"states"`         // 状态列表
    Type       int    `form:"type" params:"type" default:"-1"`      // 类型
    AttrFormat []int  `form:"attr_format,split" params:"attr_format"` // 属性格式
    CtimeFrom  string `form:"ctime_from" params:"ctime_from"`       // 创建时间起始
    CtimeTo    string `form:"ctime_to" params:"ctime_to"`           // 创建时间结束
}
```

#### 查询构建逻辑

```go
func (d *Dao) DmSearch(ctx context.Context, p *DmSearchParams) (*SearchResult, error) {
    // 1. 计算索引名（按 oid 分片）
    indexName := fmt.Sprintf("dm_search_%03d", p.Oid%1000)
    
    // 2. 构建 Bool Query
    query := elastic.NewBoolQuery()
    
    // 关键词搜索（正则匹配）
    if p.Bsp.KW != "" {
        query = query.Must(elastic.NewRegexpQuery(p.Bsp.KwFields[0], ".*"+p.Bsp.KW+".*"))
    }
    
    // 精确过滤条件
    if p.Oid != -1 {
        query = query.Filter(elastic.NewTermQuery("oid", p.Oid))
    }
    if p.Mid != -1 {
        query = query.Filter(elastic.NewTermQuery("mid", p.Mid))
    }
    if p.Mode != -1 {
        query = query.Filter(elastic.NewTermQuery("mode", p.Mode))
    }
    if p.Pool != -1 {
        query = query.Filter(elastic.NewTermQuery("pool", p.Pool))
    }
    if p.Progress != -1 {
        query = query.Filter(elastic.NewTermQuery("progress", p.Progress))
    }
    if len(p.States) > 0 {
        query = query.Filter(elastic.NewTermsQuery("state", toInterfaceSlice(p.States)...))
    }
    if p.Type != -1 {
        query = query.Filter(elastic.NewTermQuery("type", p.Type))
    }
    if len(p.AttrFormat) > 0 {
        query = query.Filter(elastic.NewTermsQuery("attr_format", toInterfaceSlice(p.AttrFormat)...))
    }
    
    // 时间范围过滤
    if p.CtimeFrom != "" {
        query = query.Filter(elastic.NewRangeQuery("ctime").Gte(p.CtimeFrom))
    }
    if p.CtimeTo != "" {
        query = query.Filter(elastic.NewRangeQuery("ctime").Lte(p.CtimeTo))
    }
    
    // 3. 执行搜索
    return d.searchResult(ctx, "dmExternal", indexName, query, p.Bsp)
}
```

### 4.3 弹幕历史搜索 (DmHistory)

#### 请求参数

```go
type DmHistoryParams struct {
    Bsp       *BasicSearchParams
    Oid       int64   `form:"oid" params:"oid" default:"-1"`
    States    []int64 `form:"states,split" params:"states"`
    CtimeFrom string  `form:"ctime_from" params:"ctime_from"`
    CtimeTo   string  `form:"ctime_to" params:"ctime_to"`
}
```

#### 查询构建逻辑

```go
func (d *Dao) DmHistory(ctx context.Context, p *DmHistoryParams) (*SearchResult, error) {
    indexName := fmt.Sprintf("dm_search_%03d", p.Oid%1000)
    query := elastic.NewBoolQuery()
    
    // 关键词搜索（MultiMatch）
    if p.Bsp.KW != "" {
        query = query.Must(
            elastic.NewMultiMatchQuery(p.Bsp.KW, p.Bsp.KwFields...).
                Type("best_fields").
                TieBreaker(0.6),
        )
    }
    
    // 使用 oidstr 精确匹配
    if p.Oid != -1 {
        query = query.Filter(elastic.NewTermQuery("oidstr", p.Oid))
    }
    
    if len(p.States) > 0 {
        query = query.Filter(elastic.NewTermsQuery("state", toInterfaceSlice(p.States)...))
    }
    
    if p.CtimeFrom != "" {
        query = query.Filter(elastic.NewRangeQuery("ctime").Gte(p.CtimeFrom))
    }
    if p.CtimeTo != "" {
        query = query.Filter(elastic.NewRangeQuery("ctime").Lte(p.CtimeTo))
    }
    
    return d.searchResult(ctx, "dmExternal", indexName, query, p.Bsp)
}
```

### 4.4 弹幕日期搜索 (DmDate)

#### 请求参数

```go
type DmDateParams struct {
    Bsp       *BasicSearchParams
    Oid       int64  `form:"oid" params:"oid" default:"-1"`
    Month     string `form:"month" params:"month" default:""`      // 格式: 2024-01
    MonthFrom string `form:"month_from" params:"month_from" default:""`
    MonthTo   string `form:"month_to" params:"month_to" default:""`
}
```

#### 查询构建逻辑

```go
func (d *Dao) DmDateSearch(ctx context.Context, p *DmDateParams) (*SearchResult, error) {
    // 索引名按月份分片
    indexName := "dm_date_" + strings.Replace(p.Month, "-", "_", -1)
    
    query := elastic.NewBoolQuery()
    
    if p.Bsp.KW != "" {
        query = query.Must(elastic.NewRegexpQuery(p.Bsp.KwFields[0], ".*"+p.Bsp.KW+".*"))
    }
    
    if p.Oid != -1 {
        query = query.Filter(elastic.NewTermQuery("oid", p.Oid))
    }
    if p.Month != "" {
        query = query.Filter(elastic.NewTermQuery("month", p.Month))
    }
    if p.MonthFrom != "" {
        query = query.Filter(elastic.NewRangeQuery("month").Gte(p.MonthFrom))
    }
    if p.MonthTo != "" {
        query = query.Filter(elastic.NewRangeQuery("month").Lte(p.MonthTo))
    }
    
    return d.searchResult(ctx, "dmExternal", indexName, query, p.Bsp)
}
```

### 4.5 PGC番剧搜索 (PgcMedia)

#### 请求参数

```go
type PgcMediaParams struct {
    Bsp             *BasicSearchParams
    MediaIds        []int64  `form:"media_ids,split" params:"media_ids"`
    SeasonIds       []int64  `form:"season_ids,split" params:"season_ids"`
    SeasonTypes     []int64  `form:"season_types,split" params:"season_types"`
    StyleIds        []int64  `form:"style_ids,split" params:"style_ids"`
    Status          int      `form:"status" params:"status" default:"-1000"`
    ReleaseDateFrom string   `form:"release_date_from" params:"release_date_from"`
    ReleaseDateTo   string   `form:"release_date_to" params:"release_date_to"`
    SeasonIDFrom    int      `form:"season_id_from" params:"season_id_from"`
    SeasonIDTo      int      `form:"season_id_to" params:"season_id_to"`
    ProducerIds     []int64  `form:"producer_ids,split" params:"producer_ids"`
    IsDeleted       int      `form:"is_deleted" params:"is_deleted" default:"0"`
    AreaIds         []string `form:"area_ids,split" params:"area_ids"`
    ScoreFrom       int      `form:"score_from" params:"score_from"`
    ScoreTo         int      `form:"score_to" params:"score_to"`
    IsFinish        string   `form:"is_finish" params:"is_finish"`
    SeasonVersions  []int64  `form:"season_versions,split" params:"season_versions"`
    SeasonStatuses  []int64  `form:"season_statuses,split" params:"season_statuses"`
    PubTimeFrom     string   `form:"pub_time_from" params:"pub_time_from"`
    PubTimeTo       string   `form:"pub_time_to" params:"pub_time_to"`
    SeasonMonths    []int64  `form:"season_months,split" params:"season_months"`
    LatestTimeFrom  string   `form:"latest_time_from" params:"latest_time_from"`
    LatestTimeTo    string   `form:"latest_time_to" params:"latest_time_to"`
    CopyrightInfos  []string `form:"copyright_infos,split" params:"copyright_infos"`
    CTimeFrom       string   `form:"ctime_from" params:"ctime_from"`
    CTimeTo         string   `form:"ctime_to" params:"ctime_to"`
    MTimeFrom       string   `form:"mtime_from" params:"mtime_from"`
    MTimeTo         string   `form:"mtime_to" params:"mtime_to"`
}
```



#### 查询构建逻辑

```go
func (d *Dao) PgcMedia(ctx context.Context, p *PgcMediaParams) (*SearchResult, error) {
    query := elastic.NewBoolQuery()
    
    // 标题全文搜索
    if p.Bsp.KW != "" {
        query = query.Must(
            elastic.NewMultiMatchQuery(p.Bsp.KW, "title").
                Type("best_fields").
                TieBreaker(0.3),
        )
    }
    
    // 精确过滤条件
    if len(p.MediaIds) > 0 {
        query = query.Filter(elastic.NewTermsQuery("media_id", toInterfaceSlice(p.MediaIds)...))
    }
    if len(p.SeasonIds) > 0 {
        query = query.Filter(elastic.NewTermsQuery("season_id", toInterfaceSlice(p.SeasonIds)...))
    }
    if len(p.SeasonTypes) > 0 {
        query = query.Filter(elastic.NewTermsQuery("season_type", toInterfaceSlice(p.SeasonTypes)...))
    }
    if len(p.StyleIds) > 0 {
        query = query.Filter(elastic.NewTermsQuery("style_id", toInterfaceSlice(p.StyleIds)...))
    }
    if p.Status > -1000 {
        query = query.Filter(elastic.NewTermQuery("status", p.Status))
    }
    if len(p.ProducerIds) > 0 {
        query = query.Filter(elastic.NewTermsQuery("producer_id", toInterfaceSlice(p.ProducerIds)...))
    }
    if len(p.AreaIds) > 0 {
        query = query.Filter(elastic.NewTermsQuery("area_id", toStringInterfaceSlice(p.AreaIds)...))
    }
    if p.IsFinish != "" {
        query = query.Filter(elastic.NewTermQuery("is_finish", p.IsFinish))
    }
    if len(p.SeasonVersions) > 0 {
        query = query.Filter(elastic.NewTermsQuery("season_version", toInterfaceSlice(p.SeasonVersions)...))
    }
    if len(p.SeasonStatuses) > 0 {
        query = query.Filter(elastic.NewTermsQuery("season_status", toInterfaceSlice(p.SeasonStatuses)...))
    }
    if len(p.SeasonMonths) > 0 {
        query = query.Filter(elastic.NewTermsQuery("season_month", toInterfaceSlice(p.SeasonMonths)...))
    }
    if len(p.CopyrightInfos) > 0 {
        query = query.Filter(elastic.NewTermsQuery("copyright_info", toStringInterfaceSlice(p.CopyrightInfos)...))
    }
    
    // 排除已删除
    if p.IsDeleted == 0 {
        query = query.MustNot(elastic.NewTermQuery("is_deleted", 1))
    }
    
    // 范围查询
    if p.ReleaseDateFrom != "" {
        query = query.Filter(elastic.NewRangeQuery("release_date").Gte(p.ReleaseDateFrom))
    }
    if p.ReleaseDateTo != "" {
        query = query.Filter(elastic.NewRangeQuery("release_date").Lte(p.ReleaseDateTo))
    }
    if p.SeasonIDFrom > 0 {
        query = query.Filter(elastic.NewRangeQuery("season_id").Gte(p.SeasonIDFrom))
    }
    if p.SeasonIDTo > 0 {
        query = query.Filter(elastic.NewRangeQuery("season_id").Lte(p.SeasonIDTo))
    }
    if p.ScoreFrom > 0 {
        query = query.Filter(elastic.NewRangeQuery("score").Gte(p.ScoreFrom))
    }
    if p.ScoreTo > 0 {
        query = query.Filter(elastic.NewRangeQuery("score").Lte(p.ScoreTo))
    }
    if p.PubTimeFrom != "" {
        query = query.Filter(elastic.NewRangeQuery("pub_time").Gte(p.PubTimeFrom))
    }
    if p.PubTimeTo != "" {
        query = query.Filter(elastic.NewRangeQuery("pub_time").Lte(p.PubTimeTo))
    }
    if p.LatestTimeFrom != "" {
        query = query.Filter(elastic.NewRangeQuery("latest_time").Gte(p.LatestTimeFrom))
    }
    if p.LatestTimeTo != "" {
        query = query.Filter(elastic.NewRangeQuery("latest_time").Lte(p.LatestTimeTo))
    }
    if p.CTimeFrom != "" {
        query = query.Filter(elastic.NewRangeQuery("ctime").Gte(p.CTimeFrom))
    }
    if p.CTimeTo != "" {
        query = query.Filter(elastic.NewRangeQuery("ctime").Lte(p.CTimeTo))
    }
    if p.MTimeFrom != "" {
        query = query.Filter(elastic.NewRangeQuery("mtime").Gte(p.MTimeFrom))
    }
    if p.MTimeTo != "" {
        query = query.Filter(elastic.NewRangeQuery("mtime").Lte(p.MTimeTo))
    }
    
    // 指定返回字段
    p.Bsp.Source = []string{
        "media_id", "season_id", "season_type", "dm_count", 
        "play_count", "fav_count", "score", "latest_time", 
        "pub_time", "release_date",
    }
    
    return d.searchResult(ctx, "externalPublic", "pgc_media", query, p.Bsp)
}
```

### 4.6 评论记录搜索 (ReplyRecord)

#### 请求参数

```go
type ReplyRecordParams struct {
    Bsp       *BasicSearchParams
    Mid       int64   `form:"mid" params:"mid"`                    // 用户ID（必需）
    Types     []int64 `form:"types,split" params:"types"`          // 类型列表
    States    []int64 `form:"states,split" params:"states"`        // 状态列表
    CTimeFrom string  `form:"ctime_from" params:"ctime_from"`      // 创建时间起始
    CTimeTo   string  `form:"ctime_to" params:"ctime_to"`          // 创建时间结束
}
```

#### 查询构建逻辑

```go
func (d *Dao) ReplyRecord(ctx context.Context, p *ReplyRecordParams) (*SearchResult, error) {
    // mid 是必需参数
    if p.Mid <= 0 {
        return nil, errors.New("mid is required")
    }
    
    // 索引名按 mid 分片
    indexName := fmt.Sprintf("replyrecord_%02d", p.Mid%100)
    
    query := elastic.NewBoolQuery()
    
    // 用户ID精确匹配
    query = query.Must(elastic.NewTermQuery("mid", p.Mid))
    
    // 类型过滤
    if len(p.Types) > 0 {
        query = query.Must(elastic.NewTermsQuery("type", toInterfaceSlice(p.Types)...))
    }
    
    // 状态过滤
    if len(p.States) > 0 {
        query = query.Must(elastic.NewTermsQuery("state", toInterfaceSlice(p.States)...))
    }
    
    // 时间范围
    if p.CTimeFrom != "" {
        query = query.Must(elastic.NewRangeQuery("ctime").Gte(p.CTimeFrom))
    }
    if p.CTimeTo != "" {
        query = query.Must(elastic.NewRangeQuery("ctime").Lte(p.CTimeTo))
    }
    
    return d.searchResult(ctx, "replyExternal", indexName, query, p.Bsp)
}
```

### 4.7 索引更新逻辑

#### 4.7.1 弹幕索引更新

```go
type DmUpdateParams struct {
    ID    int64                  `json:"id"`
    Oid   int64                  `json:"oid"`
    Field map[string]interface{} `json:"field"`
}

func (p *DmUpdateParams) IndexName() string {
    return fmt.Sprintf("dm_search_%03d", p.Oid%1000)
}

func (p *DmUpdateParams) IndexID() string {
    return fmt.Sprintf("%d", p.ID)
}

func (d *Dao) DmUpdate(ctx context.Context, items []*DmUpdateParams) error {
    bulkItems := make([]BulkUpdateItem, 0, len(items))
    for _, item := range items {
        bulkItems = append(bulkItems, BulkUpdateItem{
            IndexName: item.IndexName(),
            IndexID:   item.IndexID(),
            Fields:    item.Field,
        })
    }
    return d.esClient.BulkUpdate(ctx, "dmExternal", bulkItems)
}
```

#### 4.7.2 PGC索引更新

```go
type PgcMediaUpdateParams struct {
    MediaID int64                  `json:"media_id"`
    Field   map[string]interface{} `json:"field"`
}

func (p *PgcMediaUpdateParams) IndexName() string {
    return "pgc_media"
}

func (p *PgcMediaUpdateParams) IndexID() string {
    return fmt.Sprintf("%d", p.MediaID)
}

func (d *Dao) PgcUpdate(ctx context.Context, items []*PgcMediaUpdateParams) error {
    bulkItems := make([]BulkUpdateItem, 0, len(items))
    for _, item := range items {
        bulkItems = append(bulkItems, BulkUpdateItem{
            IndexName: item.IndexName(),
            IndexID:   item.IndexID(),
            Fields:    item.Field,
        })
    }
    return d.esClient.BulkUpdate(ctx, "externalPublic", bulkItems)
}
```

#### 4.7.3 评论索引更新

```go
type ReplyRecordUpdateParams struct {
    ID    int64 `json:"id"`
    OID   int64 `json:"oid"`
    MID   int64 `json:"mid"`
    State int   `json:"state"`
}

func (p *ReplyRecordUpdateParams) IndexName() string {
    return fmt.Sprintf("replyrecord_%02d", p.MID%100)
}

func (p *ReplyRecordUpdateParams) IndexID() string {
    return fmt.Sprintf("%d_%d", p.ID, p.OID)
}

func (d *Dao) ReplyUpdate(ctx context.Context, items []*ReplyRecordUpdateParams) error {
    bulkItems := make([]BulkUpdateItem, 0, len(items))
    for _, item := range items {
        bulkItems = append(bulkItems, BulkUpdateItem{
            IndexName: item.IndexName(),
            IndexID:   item.IndexID(),
            Fields: map[string]interface{}{
                "state": item.State,
            },
        })
    }
    return d.esClient.BulkUpdate(ctx, "replyExternal", bulkItems)
}
```

### 4.8 通用搜索结果处理

```go
func (d *Dao) searchResult(ctx context.Context, clusterName, indexName string, query elastic.Query, bsp *BasicSearchParams) (*SearchResult, error) {
    result := &SearchResult{Debug: ""}
    
    // 1. 调试模式：输出查询 DSL
    if bsp.Debug {
        src, err := query.Source()
        if err == nil {
            data, _ := json.Marshal(src)
            result.Debug = string(data)
        }
    }
    
    // 2. 获取 ES 客户端
    client, ok := d.esPool[clusterName]
    if !ok {
        return nil, fmt.Errorf("ES cluster not found: %s", clusterName)
    }
    
    // 3. 构建排序器
    sorters := make([]elastic.Sorter, 0)
    if bsp.KW != "" {
        sorters = append(sorters, elastic.NewScoreSort().Desc())
    }
    for i, field := range bsp.Order {
        sortOrder := "desc"
        if i < len(bsp.Sort) {
            sortOrder = bsp.Sort[i]
        } else if len(bsp.Sort) > 0 {
            sortOrder = bsp.Sort[0]
        }
        if sortOrder == "desc" {
            sorters = append(sorters, elastic.NewFieldSort(field).Desc())
        } else {
            sorters = append(sorters, elastic.NewFieldSort(field).Asc())
        }
    }
    
    // 4. 构建搜索请求
    searchService := client.Search().
        Index(indexName).
        Query(query).
        From(int((bsp.Pn - 1) * bsp.Ps)).
        Size(int(bsp.Ps)).
        Pretty(true)
    
    for _, sorter := range sorters {
        searchService = searchService.SortBy(sorter)
    }
    
    if len(bsp.Source) > 0 {
        fsc := elastic.NewFetchSourceContext(true).Include(bsp.Source...)
        searchService = searchService.FetchSourceContext(fsc)
    }
    
    // 5. 执行查询
    searchResp, err := searchService.Do(ctx)
    if err != nil {
        return nil, err
    }
    
    // 6. 解析结果
    var data []json.RawMessage
    for _, hit := range searchResp.Hits.Hits {
        var t json.RawMessage
        if err := json.Unmarshal(hit.Source, &t); err != nil {
            continue
        }
        data = append(data, t)
    }
    
    result.Order = strings.Join(bsp.Order, ",")
    result.Sort = strings.Join(bsp.Sort, ",")
    result.Result = data
    result.Page = &Page{
        Pn:    bsp.Pn,
        Ps:    bsp.Ps,
        Total: searchResp.Hits.TotalHits.Value,
    }
    
    return result, nil
}
```

------

## 五、API 设计

### 5.1 HTTP API（通过 search-api 网关）

#### 5.1.1 弹幕搜索

```http
GET /x/internal/search/dm

Request Query Parameters:
- app_id: string (必需) - 应用ID
- kw: string (可选) - 搜索关键词
- kw_fields: string (可选) - 关键词搜索字段，逗号分隔
- order: string (可选) - 排序字段，逗号分隔
- sort: string (可选) - 排序方式，逗号分隔 (asc/desc)
- pn: int (可选，默认1) - 页码
- ps: int (可选，默认20) - 每页数量
- oid: int64 (必需) - 对象ID
- mid: int64 (可选) - 用户ID
- mode: int (可选) - 弹幕模式
- pool: int (可选) - 弹幕池
- states: string (可选) - 状态列表，逗号分隔
- type: int (可选) - 类型
- ctime_from: string (可选) - 创建时间起始
- ctime_to: string (可选) - 创建时间结束
- debug: bool (可选) - 调试模式

Response:
{
  "code": 0,
  "message": "success",
  "data": {
    "order": "ctime",
    "sort": "desc",
    "result": [
      {
        "id": 123456,
        "oid": 100001,
        "mid": 1001,
        "content": "前方高能",
        "mode": 1,
        "pool": 0,
        "progress": 12000,
        "state": 0,
        "ctime": "2024-01-15 10:30:00"
      }
    ],
    "page": {
      "num": 1,
      "size": 20,
      "total": 100
    },
    "debug": ""
  }
}
```

#### 5.1.2 弹幕日期搜索

```http
GET /x/internal/search/dm/date

Request Query Parameters:
- oid: int64 (必需) - 对象ID
- month: string (必需) - 月份 (格式: 2024-01)
- month_from: string (可选) - 月份起始
- month_to: string (可选) - 月份结束
- pn: int (可选，默认1) - 页码
- ps: int (可选，默认20) - 每页数量

Response:
{
  "code": 0,
  "message": "success",
  "data": {
    "result": [
      {
        "oid": 100001,
        "month": "2024-01",
        "date": "2024-01-15",
        "total": 1500
      }
    ],
    "page": {
      "num": 1,
      "size": 20,
      "total": 31
    }
  }
}
```

#### 5.1.3 弹幕历史搜索

```http
GET /x/internal/search/dmhistory

Request Query Parameters:
- oid: int64 (必需) - 对象ID
- kw: string (可选) - 搜索关键词
- states: string (可选) - 状态列表
- ctime_from: string (可选) - 创建时间起始
- ctime_to: string (可选) - 创建时间结束
- pn: int (可选，默认1) - 页码
- ps: int (可选，默认20) - 每页数量

Response: 同弹幕搜索
```

#### 5.1.4 PGC番剧搜索

```http
GET /x/internal/search/pgc

Request Query Parameters:
- kw: string (可选) - 搜索关键词（标题）
- media_ids: string (可选) - 媒体ID列表
- season_ids: string (可选) - 季度ID列表
- season_types: string (可选) - 季度类型列表
- status: int (可选) - 状态
- release_date_from: string (可选) - 发布日期起始
- release_date_to: string (可选) - 发布日期结束
- area_ids: string (可选) - 地区ID列表
- score_from: int (可选) - 评分起始
- score_to: int (可选) - 评分结束
- is_finish: string (可选) - 是否完结
- pn: int (可选，默认1) - 页码
- ps: int (可选，默认20) - 每页数量

Response:
{
  "code": 0,
  "message": "success",
  "data": {
    "result": [
      {
        "media_id": 28229899,
        "season_id": 39462,
        "season_type": 1,
        "dm_count": 1500000,
        "play_count": 50000000,
        "fav_count": 2000000,
        "score": 9.8,
        "latest_time": "2024-01-15 00:00:00",
        "pub_time": "2023-10-01 00:00:00",
        "release_date": "2023-10-01"
      }
    ],
    "page": {
      "num": 1,
      "size": 20,
      "total": 100
    }
  }
}
```

#### 5.1.5 评论记录搜索

```http
GET /x/internal/search/reply

Request Query Parameters:
- mid: int64 (必需) - 用户ID
- types: string (可选) - 类型列表
- states: string (可选) - 状态列表
- ctime_from: string (可选) - 创建时间起始
- ctime_to: string (可选) - 创建时间结束
- pn: int (可选，默认1) - 页码
- ps: int (可选，默认20) - 每页数量

Response:
{
  "code": 0,
  "message": "success",
  "data": {
    "result": [
      {
        "id": 123456,
        "oid": 100001,
        "mid": 1001,
        "type": 1,
        "state": 0,
        "content": "这个视频太棒了！",
        "like": 100,
        "rcount": 5,
        "ctime": "2024-01-15 10:30:00"
      }
    ],
    "page": {
      "num": 1,
      "size": 20,
      "total": 50
    }
  }
}
```

#### 5.1.6 弹幕索引更新

```http
POST /x/internal/search/dm/update

Request Body:
{
  "items": [
    {
      "id": 123456,
      "oid": 100001,
      "field": {
        "state": 1,
        "mtime": "2024-01-15 10:30:00"
      }
    }
  ]
}

Response:
{
  "code": 0,
  "message": "success",
  "data": {
    "success": true
  }
}
```

#### 5.1.7 PGC索引更新

```http
POST /x/internal/search/pgc/update

Request Body:
{
  "items": [
    {
      "media_id": 28229899,
      "field": {
        "play_count": 50000001,
        "mtime": "2024-01-15 10:30:00"
      }
    }
  ]
}

Response:
{
  "code": 0,
  "message": "success",
  "data": {
    "success": true
  }
}
```

#### 5.1.8 评论索引更新

```http
POST /x/internal/search/reply/update

Request Body:
{
  "items": [
    {
      "id": 123456,
      "oid": 100001,
      "mid": 1001,
      "state": 1
    }
  ]
}

Response:
{
  "code": 0,
  "message": "success",
  "data": {
    "success": true
  }
}
```

### 5.2 gRPC API

#### 5.2.1 搜索服务 Proto 定义

```protobuf
syntax = "proto3";

package search;
option go_package = "./search";

service Search {
  // 弹幕搜索
  rpc DmSearch(DmSearchReq) returns(SearchResp);
  
  // PGC番剧搜索
  rpc PgcMediaSearch(PgcMediaSearchReq) returns(SearchResp);
  
  // 评论记录搜索
  rpc ReplyRecordSearch(ReplyRecordSearchReq) returns(SearchResp);
  
  // 弹幕历史搜索
  rpc DmHistorySearch(DmHistorySearchReq) returns(SearchResp);
  
  // 弹幕日期搜索
  rpc DmDateSearch(DmDateSearchReq) returns(SearchResp);
  
  // 弹幕索引更新
  rpc DmUpdate(DmUpdateReq) returns(UpdateResp);
  
  // PGC索引更新
  rpc PgcUpdate(PgcUpdateReq) returns(UpdateResp);
  
  // 评论索引更新
  rpc ReplyUpdate(ReplyUpdateReq) returns(UpdateResp);
}

// 通用搜索参数
message BasicSearchParams {
  string app_id = 1;
  string kw = 2;
  repeated string kw_fields = 3;
  repeated string order = 4;
  repeated string sort = 5;
  int32 pn = 6;
  int32 ps = 7;
  bool debug = 8;
}

// 搜索响应
message SearchResp {
  string order = 1;
  string sort = 2;
  repeated bytes result = 3;
  Page page = 4;
  string debug = 5;
}

message Page {
  int32 pn = 1;
  int32 ps = 2;
  int64 total = 3;
}

// 更新响应
message UpdateResp {
  bool success = 1;
  string message = 2;
}
```

------

## 六、配置文件

### 6.1 search-rpc 配置

```yaml
Name: search.rpc
Mode: dev
ListenOn: 127.0.0.1:9007

# etcd 服务注册
Etcd:
  Hosts:
    - 127.0.0.1:23790
  Key: search.rpc

# Prometheus 监控
Prometheus:
  Host: 127.0.0.1
  Port: 9097
  Path: /metrics

# Elasticsearch 集群配置
Elasticsearch:
  # 弹幕搜索集群
  DmExternal:
    Addresses:
      - http://127.0.0.1:9200
  # PGC番剧集群
  ExternalPublic:
    Addresses:
      - http://127.0.0.1:9200
  # 评论记录集群
  ReplyExternal:
    Addresses:
      - http://127.0.0.1:9200

# Redis 配置（可选，用于缓存）
SearchRedis:
  Host: 127.0.0.1:63790
  Type: node
  Pass: redis123456

# 业务配置
Business:
  # 搜索限制
  MaxPageSize: 100          # 最大每页数量
  DefaultPageSize: 20       # 默认每页数量
  MaxKeywordLength: 100     # 最大关键词长度
  
  # 缓存配置
  CacheEnable: false        # 是否启用缓存
  CacheTTL: 300             # 缓存时长(秒)
  
  # 超时配置
  SearchTimeout: 5000       # 搜索超时(ms)
  UpdateTimeout: 10000      # 更新超时(ms)
```

### 6.2 search-api 配置

```yaml
Name: search-api
Mode: dev
Host: 0.0.0.0
Port: 8888

# 依赖服务
SearchRpc:
  Etcd:
    Hosts:
      - 127.0.0.1:23790
    Key: search.rpc
  Timeout: 5000

# 日志配置
Log:
  Mode: console
  Level: info
```

------

## 七、目录结构

```
mybilibili/app/search/
├── cmd/
│   ├── api/                          # HTTP API 服务
│   │   ├── desc/
│   │   │   └── search.api            # API 定义文件
│   │   ├── etc/
│   │   │   └── search.yaml           # 配置文件
│   │   ├── internal/
│   │   │   ├── config/
│   │   │   │   └── config.go         # 配置结构
│   │   │   ├── handler/
│   │   │   │   └── search/           # HTTP 处理器
│   │   │   │       ├── dm_search_handler.go
│   │   │   │       ├── dm_date_search_handler.go
│   │   │   │       ├── dm_history_search_handler.go
│   │   │   │       ├── dm_update_handler.go
│   │   │   │       ├── pgc_media_search_handler.go
│   │   │   │       ├── pgc_update_handler.go
│   │   │   │       ├── reply_record_search_handler.go
│   │   │   │       └── reply_update_handler.go
│   │   │   ├── logic/
│   │   │   │   └── search/           # 业务逻辑
│   │   │   │       ├── dm_search_logic.go
│   │   │   │       ├── dm_date_search_logic.go
│   │   │   │       ├── dm_history_search_logic.go
│   │   │   │       ├── dm_update_logic.go
│   │   │   │       ├── pgc_media_search_logic.go
│   │   │   │       ├── pgc_update_logic.go
│   │   │   │       ├── reply_record_search_logic.go
│   │   │   │       └── reply_update_logic.go
│   │   │   ├── svc/
│   │   │   │   └── service_context
```

------

```
│   │   │   │   └── service_context.go
│   │   │   └── types/
│   │   │       └── types.go          # 请求/响应类型
│   │   └── search.go                 # 入口文件
│   │
│   └── rpc/                          # gRPC 服务
│       ├── etc/
│       │   └── search.yaml           # 配置文件
│       ├── internal/
│       │   ├── config/
│       │   │   └── config.go         # 配置结构
│       │   ├── logic/                # 业务逻辑
│       │   │   ├── dm_search_logic.go
│       │   │   ├── dm_date_search_logic.go
│       │   │   ├── dm_history_search_logic.go
│       │   │   ├── dm_update_logic.go
│       │   │   ├── pgc_media_search_logic.go
│       │   │   ├── pgc_update_logic.go
│       │   │   ├── reply_record_search_logic.go
│       │   │   └── reply_update_logic.go
│       │   ├── server/
│       │   │   └── search_server.go  # gRPC 服务实现
│       │   └── svc/
│       │       └── service_context.go
│       ├── search/                   # protobuf 生成代码
│       │   └── search.pb.go
│       ├── search_client/            # 客户端代码
│       │   └── search.go
│       ├── search.go                 # 入口文件
│       └── search.proto              # Proto 定义
│
├── model/                            # 数据模型
│   └── es_client.go                  # ES 客户端封装
│
├── deploy/                           # 部署配置
│   └── es/                           # ES 索引配置
│       ├── dm_search_mapping.json
│       ├── dm_date_mapping.json
│       ├── pgc_media_mapping.json
│       ├── replyrecord_mapping.json
│       ├── create_indices.sh         # 生产环境索引创建脚本
│       ├── create_indices_dev.sh     # 开发环境索引创建脚本
│       └── README.md
│
├── Makefile                          # 构建脚本
└── README.md                         # 项目说明
```

------

## 八、开发计划

### 8.1 Phase 1: 基础框架搭建（1-2天）✅ 已完成

- [x] 创建 `search-rpc` 服务骨架
- [x] 创建 `search-api` 服务骨架
- [x] 定义 Proto 文件并生成代码
- [x] 实现 ES 客户端封装
- [x] 实现服务注册与发现

### 8.2 Phase 2: 弹幕搜索实现（1-2天）✅ 已完成

- [x] 实现弹幕搜索 (DmSearch)
- [x] 实现弹幕历史搜索 (DmHistory)
- [x] 实现弹幕日期搜索 (DmDate)
- [x] 实现弹幕索引更新 (DmUpdate)
- [x] 创建 ES 索引映射

### 8.3 Phase 3: PGC番剧搜索实现（1天）✅ 已完成

- [x] 实现 PGC 番剧搜索 (PgcMedia)
- [x] 实现 PGC 索引更新 (PgcUpdate)
- [x] 创建 ES 索引映射

### 8.4 Phase 4: 评论记录搜索实现（1天）✅ 已完成

- [x] 实现评论记录搜索 (ReplyRecord)
- [x] 实现评论索引更新 (ReplyUpdate)
- [x] 创建 ES 索引映射

### 8.5 Phase 5: 测试与优化（2-3天）

- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能测试
- [ ] 搜索效果测试
- [ ] 监控指标完善

### 8.6 Phase 6: 数据同步（可选，2-3天）

- [ ] 实现 MySQL → ES 数据同步
- [ ] 实现增量同步（基于 Canal/Kafka）
- [ ] 实现全量同步脚本

**总预计时间**: 8-12天

------

## 九、监控指标

### 9.1 核心指标

#### 搜索服务指标

```promql
# QPS
rate(rpc_server_requests_code_total{service="search-rpc"}[5m])

# 平均响应时间
rate(rpc_server_requests_duration_ms_sum{service="search-rpc"}[5m]) / 
rate(rpc_server_requests_duration_ms_count{service="search-rpc"}[5m])

# 错误率
sum(rate(rpc_server_requests_code_total{service="search-rpc",code!="0"}[5m])) / 
sum(rate(rpc_server_requests_code_total{service="search-rpc"}[5m]))

# P99 延迟
histogram_quantile(0.99, rate(rpc_server_requests_duration_ms_bucket{service="search-rpc"}[5m]))
```

#### ES 集群指标

```promql
# ES 查询耗时
es_search_duration_ms{cluster="dmExternal"}
es_search_duration_ms{cluster="externalPublic"}
es_search_duration_ms{cluster="replyExternal"}

# ES 查询错误数
es_search_errors_total{cluster="dmExternal"}

# ES 索引更新耗时
es_bulk_update_duration_ms{cluster="dmExternal"}
```

### 9.2 业务指标

| 指标名 | 说明 | 计算方式 | |--------|------|----------| | search_dm_qps | 弹幕搜索 QPS | rate(search_dm_total[5m]) | | search_pgc_qps | PGC 搜索 QPS | rate(search_pgc_total[5m]) | | search_reply_qps | 评论搜索 QPS | rate(search_reply_total[5m]) | | search_hit_rate | 搜索命中率 | 有结果请求数 / 总请求数 | | search_avg_result_count | 平均结果数 | 总结果数 / 总请求数 | | update_dm_qps | 弹幕更新 QPS | rate(update_dm_total[5m]) | | update_pgc_qps | PGC 更新 QPS | rate(update_pgc_total[5m]) | | update_reply_qps | 评论更新 QPS | rate(update_reply_total[5m]) |

### 9.3 告警规则

```yaml
groups:
  - name: search-service
    rules:
      # 搜索服务错误率过高
      - alert: SearchServiceHighErrorRate
        expr: |
          sum(rate(rpc_server_requests_code_total{service="search-rpc",code!="0"}[5m])) / 
          sum(rate(rpc_server_requests_code_total{service="search-rpc"}[5m])) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "搜索服务错误率过高"
          description: "搜索服务错误率超过 1%"
      
      # 搜索延迟过高
      - alert: SearchServiceHighLatency
        expr: |
          histogram_quantile(0.99, rate(rpc_server_requests_duration_ms_bucket{service="search-rpc"}[5m])) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "搜索服务延迟过高"
          description: "搜索服务 P99 延迟超过 1 秒"
      
      # ES 集群不可用
      - alert: ESClusterDown
        expr: es_cluster_health_status{status="red"} == 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ES 集群不可用"
          description: "ES 集群 {{ $labels.cluster }} 状态为 red"
```

------

## 十、数据同步方案

### 10.1 数据流架构

```
┌─────────────────────────────────────────────────────────────┐
│                     业务服务层                               │
│  (dm-service, pgc-service, reply-service)                   │
└───────────────────────┬─────────────────────────────────────┘
                        │ 写入
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                     MySQL 数据库                             │
│  - dm_index (弹幕表)                                         │
│  - pgc_media (番剧表)                                        │
│  - reply (评论表)                                            │
└───────────────────────┬─────────────────────────────────────┘
                        │ Binlog
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                     Canal Server                             │
│  - 监听 MySQL Binlog                                         │
│  - 解析数据变更事件                                           │
└───────────────────────┬─────────────────────────────────────┘
                        │ 消息
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                     Kafka                                    │
│  - topic: dm_binlog                                          │
│  - topic: pgc_binlog                                         │
│  - topic: reply_binlog                                       │
└───────────────────────┬─────────────────────────────────────┘
                        │ 消费
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                     Search Job                               │
│  - 消费 Kafka 消息                                           │
│  - 转换数据格式                                              │
│  - 批量写入 ES                                               │
└───────────────────────┬─────────────────────────────────────┘
                        │ 写入
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                     Elasticsearch                            │
│  - dm_search_* (弹幕索引)                                    │
│  - pgc_media (番剧索引)                                      │
│  - replyrecord_* (评论索引)                                  │
└─────────────────────────────────────────────────────────────┘
```

### 10.2 同步策略

| 数据类型 | 同步方式 | 延迟要求 | 说明 | |----------|----------|----------|------| | 弹幕 | 准实时 | < 5s | 通过 Canal + Kafka 增量同步 | | PGC番剧 | 准实时 | < 30s | 数据量小，可接受稍高延迟 | | 评论 | 准实时 | < 5s | 通过 Canal + Kafka 增量同步 |

### 10.3 全量同步脚本

```bash
#!/bin/bash
# full_sync.sh - 全量同步脚本

ES_HOST="http://localhost:9200"
MYSQL_HOST="localhost"
MYSQL_USER="root"
MYSQL_PASS="root123456"
MYSQL_DB="mybilibili"

# 同步弹幕数据
sync_dm() {
    echo "开始同步弹幕数据..."
    mysql -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASS $MYSQL_DB -e "
        SELECT id, oid, mid, content, mode, pool, progress, state, type, attr, ctime, mtime
        FROM dm_index
        WHERE state = 0
    " | while read line; do
        # 解析并写入 ES
        # ...
    done
    echo "弹幕数据同步完成"
}

# 同步 PGC 数据
sync_pgc() {
    echo "开始同步 PGC 数据..."
    # ...
    echo "PGC 数据同步完成"
}

# 同步评论数据
sync_reply() {
    echo "开始同步评论数据..."
    # ...
    echo "评论数据同步完成"
}

# 执行同步
sync_dm
sync_pgc
sync_reply
```

------

## 十一、风险与挑战

### 11.1 技术风险

1. **ES 集群性能问题**
   - **风险**: 高并发搜索导致 ES 响应变慢
   - **缓解**:
     - 合理设置分片数和副本数
     - 使用 ES 查询缓存
     - 实现应用层缓存（Redis）
     - 限流降级
2. **索引分片不均匀**
   - **风险**: 某些分片数据量过大，导致热点
   - **缓解**:
     - 监控分片大小
     - 定期 reindex 重新分配
     - 调整分片策略
3. **数据同步延迟**
   - **风险**: MySQL 与 ES 数据不一致
   - **缓解**:
     - 监控同步延迟
     - 实现数据校验机制
     - 提供手动同步接口

### 11.2 业务风险

1. **搜索结果不准确**
   - **风险**: 用户搜索不到想要的内容
   - **缓解**:
     - 优化分词器配置
     - 调整搜索权重
     - 收集用户反馈
2. **索引更新失败**
   - **风险**: 数据变更未同步到 ES
   - **缓解**:
     - 实现重试机制
     - 记录失败日志
     - 定期全量同步

------

## 十二、总结

本设计方案严格基于 Bilibili 主项目的 `app/service/main/search` 模块，实现了完整的内部搜索服务：

### 12.1 功能模块

| 模块 | 功能 | 状态 | |------|------|------| | 弹幕搜索 | 按内容、用户、状态等条件搜索弹幕 | ✅ 已实现 | | 弹幕历史搜索 | 搜索弹幕历史记录 | ✅ 已实现 | | 弹幕日期搜索 | 按日期统计弹幕数量 | ✅ 已实现 | | PGC番剧搜索 | 按标题、类型、状态等条件搜索番剧 | ✅ 已实现 | | 评论记录搜索 | 按用户搜索评论记录 | ✅ 已实现 | | 索引更新 | 增量更新 ES 索引 | ✅ 已实现 |

### 12.2 核心优势

- ✅ **架构清晰**: API 层与 RPC 层分离，职责明确
- ✅ **多集群支持**: 支持不同业务使用不同 ES 集群
- ✅ **分片策略**: 按业务特点设计合理的分片策略
- ✅ **扩展性强**: 易于添加新的搜索类型
- ✅ **与主项目一致**: 严格按照 openbilibili 主项目实现

### 12.3 待完善

- [ ] 数据同步服务 (search-job)
- [ ] 搜索结果缓存
- [ ] 热门搜索词统计
- [ ] 搜索建议/自动补全
- [ ] 搜索日志分析

### 12.4 ES 索引汇总

| 索引名 | 分片策略 | 集群 | 说明 | |--------|----------|------|------| | dm_search_{000-999} | oid % 1000 | dmExternal | 弹幕搜索，1000个索引 | | dm_date_{YYYY_MM} | 按月份 | dmExternal | 弹幕日期统计 | | pgc_media | 单索引 | externalPublic | PGC番剧 | | replyrecord_{00-99} | mid % 100 | replyExternal | 评论记录，100个索引 |

