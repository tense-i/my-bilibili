# MyBilibili 虚拟钱包系统设计方案 v2.0.0 - 总览

> **版本**: v2.0.0  
> **创建时间**: 2025-11-09  
> **状态**: 设计阶段  
> **作者**: MyBilibili 团队

---

## 📋 文档索引

本设计方案分为3个部分，建议按顺序阅读：

### 📖 第1部分：概述与架构
**文件**: `v2.0.0-虚拟钱包系统-第1部分-概述与架构.md`

**内容**：
- ✅ 项目概述（目标、要求、技术栈）
- ✅ 系统架构设计（微服务划分、目录结构）
- ✅ 核心设计（双重锁、分表、快照）
- ✅ 数据库设计（完整表结构）

### 📖 第2部分：接口与实现
**文件**: `v2.0.0-虚拟钱包系统-第2部分-接口与实现.md`

**内容**：
- ✅ Protobuf接口定义（wallet.proto）
- ✅ 充值Logic完整实现
- ✅ 消费Logic完整实现
- ✅ 兑换Logic完整实现
- ✅ Model层实现（user_wallet_model.go）

### 📖 第3部分：实施计划
**文件**: `v2.0.0-虚拟钱包系统-第3部分-实施计划.md`

**内容**：
- ✅ 分6阶段实施计划（每阶段1周）
- ✅ 测试方案（单元测试、并发测试、压力测试）
- ✅ 部署方案（Docker Compose、K8s）
- ✅ 监控与告警
- ✅ 性能优化
- ✅ FAQ与注意事项
- ✅ 交付标准

---

## 🎯 核心亮点

### 1. 双币种账户体系
- **金瓜子（Gold）**：付费货币，支持Android/PC/H5
- **IAP金瓜子（IapGold）**：iOS专用，符合Apple政策
- **银瓜子（Silver）**：免费货币
- **平台隔离**：iOS和Android的金瓜子独立存储

### 2. 分布式事务保障
- **TransactionID锁**（300s）：防止重复提交，保证幂等性
- **用户锁**（600s）：防止并发修改余额，防止超支
- **FOR UPDATE**：数据库悲观锁，保证事务内数据一致性
- **完整流水记录**：每笔交易都有流水，失败也记录

### 3. 实时清算系统
- **流水记录**：coin_stream_record表记录每笔交易
- **兑换记录**：coin_exchange_record表记录兑换关系
- **快照机制**：snapshot字段记录每日余额，用于对账
- **对账公式**：昨日快照 + 今日充值 - 今日消费 + 今日兑换 = 今日余额
- **99.99%一致性**：通过事务+双重锁+流水+快照实现

---

## 📊 技术架构

```
wallet-api (HTTP网关)
   ↓ gRPC
wallet-rpc (核心服务)
   ├─ RechargeLogic    # 充值
   ├─ PayLogic         # 消费
   ├─ ExchangeLogic    # 兑换
   ├─ DetailLogic      # 查询
   └─ StreamLogic      # 流水
   ↓
数据层
   ├─ MySQL（分表10张）
   ├─ Redis（分布式锁）
   ├─ Memcache（余额缓存）
   └─ Kafka（消息队列）
```

---

## 🗂️ 数据库表结构

### user_wallet_0 ~ user_wallet_9（10张分表）
```sql
uid              bigint       PK
gold             bigint       金瓜子
iap_gold         bigint       iOS金瓜子
silver           bigint       银瓜子
gold_recharge_cnt bigint      累计充值
gold_pay_cnt     bigint       累计消费
snapshot_time    datetime     快照时间
snapshot_gold    bigint       快照余额
```

### coin_stream_record_0 ~ coin_stream_record_9（10张分表）
```sql
id               bigint       PK AUTO_INCREMENT
uid              bigint       用户ID
transaction_id   varchar(64)  交易ID
coin_type        int          币种类型
delta_coin_num   bigint       变化金额（正负）
org_coin_num     bigint       原始余额
op_result        int          操作结果
op_type          int          操作类型（1=充值 2=消费 3=兑换）
op_time          datetime     操作时间
```

### coin_exchange_record
```sql
id               bigint       PK AUTO_INCREMENT
uid              bigint       用户ID
transaction_id   varchar(64)  交易ID
src_coin_type    int          源币种
src_coin_num     bigint       源币种数量
dest_coin_type   int          目标币种
dest_coin_num    bigint       目标币种数量
exchange_rate    decimal      兑换比例
```

---

## 📅 实施时间表

### 阶段一：基础架构（第1周）
- 项目结构
- 数据库初始化
- Model生成
- 配置文件

### 阶段二：充值功能（第2周）
- RPC实现
- API实现
- 单元测试
- 集成测试

### 阶段三：消费功能（第3周）
- RPC实现（含余额检查）
- API实现
- 并发测试（防超支）

### 阶段四：兑换功能（第4周）
- RPC实现（原子性）
- API实现
- 测试

### 阶段五：查询功能（第5周）
- 余额查询
- 流水查询
- 缓存策略

### 阶段六：高级功能（第6周）
- 快照机制
- Kafka消息
- 监控告警

---

## ✅ 设计原则

### 1. 严格参考主项目
- ✅ 业务逻辑完全一致
- ✅ 数据模型完全一致
- ✅ 核心算法完全一致

### 2. 使用go-zero最佳实践
- ✅ 微服务分层架构
- ✅ Service Context模式
- ✅ 统一错误处理
- ✅ 缓存策略

### 3. 不简化方案
- ✅ 双重锁机制
- ✅ 完整流水记录
- ✅ 快照对账
- ✅ 分表策略

---

## 🔧 核心代码片段

### 充值流程（关键步骤）
```go
1. 参数校验
2. TransactionID锁（Redis SET NX，300s）
3. 用户锁（Redis SET NX，600s）
4. 开启MySQL事务
5. SELECT FOR UPDATE（悲观锁）
6. UPDATE余额 + 统计
7. INSERT流水记录
8. COMMIT事务
9. 删除缓存
10. 发布Kafka消息
```

### 消费流程（防超支）
```go
// 余额检查⭐关键
if curCoin < coinNum {
    stream.OpReason = OP_REASON_NOT_ENOUGH
    // 记录失败流水
    CoinStreamRecordModel.Insert(stream)
    return ErrCoinNotEnough
}
```

### 兑换流程（原子性）
```sql
-- 一条SQL完成兑换⭐关键
UPDATE user_wallet_X SET 
    gold = gold - 1000,
    silver = silver + 1000,
    gold_pay_cnt = gold_pay_cnt + 1000
WHERE uid = ?
```

---

## 📈 性能指标

### 目标指标
- 充值接口：RT < 100ms（P99）
- 消费接口：RT < 100ms（P99）
- 查询接口：RT < 50ms（P99）
- 并发支持：1000 QPS
- 数据一致性：99.99%

### 优化策略
1. **数据库**：分表、索引优化、读写分离
2. **缓存**：Memcache余额缓存、Redis分布式锁
3. **异步**：Kafka消息异步发布
4. **批量**：批量查询、批量更新

---

## 🚀 快速开始

### 1. 阅读设计文档
```bash
# 按顺序阅读
1. v2.0.0-虚拟钱包系统-第1部分-概述与架构.md
2. v2.0.0-虚拟钱包系统-第2部分-接口与实现.md
3. v2.0.0-虚拟钱包系统-第3部分-实施计划.md
```

### 2. 准备环境
```bash
# 启动基础服务
cd deploy
docker-compose up -d mysql redis etcd kafka

# 初始化数据库
mysql -h127.0.0.1 -P33060 -uroot -p < deploy/sql/010_wallet_schema.sql
```

### 3. 开始实施
```bash
# 阶段一：基础架构
mkdir -p app/wallet/cmd/api
mkdir -p app/wallet/cmd/rpc
mkdir -p app/wallet/model

# 生成代码
cd app/wallet/cmd/rpc
goctl rpc protoc wallet.proto --go_out=. --go-grpc_out=. --zrpc_out=.

cd app/wallet/cmd/api
goctl api go -api wallet.api -dir . --style go_zero
```

---

## 📞 联系方式

**项目地址**: `/Users/zh/project/goproj/bilibili/mybilibili`  
**设计文档**: `mybilibili/设计与修复方案/v2.0.0-虚拟钱包系统-*.md`  
**主项目参考**: `/Users/zh/project/goproj/bilibili/app/service/live/wallet`

---

## 📝 变更记录

| 版本 | 日期 | 说明 |
|-----|------|------|
| v2.0.0 | 2025-11-09 | 初始设计方案，完整的虚拟钱包系统 |

---

**准备就绪，等待实施！** 🎉
