#!/bin/bash
# Redis 推荐系统完整测试数据初始化脚本

REDIS_HOST="127.0.0.1"
REDIS_PORT="63790"
REDIS_PASS="redis123456"

echo "========================================"
echo "开始初始化 Redis 推荐系统测试数据"
echo "========================================"

# 1. 热门视频索引
echo "✓ 初始化热门视频索引..."
redis-cli -h $REDIS_HOST -p $REDIS_PORT -a $REDIS_PASS 2>/dev/null << EOF
DEL RECALL:HOT:INDEX
DEL RECALL:HOT_DEFAULT:0
ZADD RECALL:HOT:INDEX 98.5 100001
ZADD RECALL:HOT:INDEX 97.2 100011
ZADD RECALL:HOT:INDEX 96.8 100019
ZADD RECALL:HOT:INDEX 96.5 100003
ZADD RECALL:HOT:INDEX 96.0 100015
ZADD RECALL:HOT:INDEX 95.5 100009
ZADD RECALL:HOT:INDEX 94.8 100013
ZADD RECALL:HOT:INDEX 94.3 100006
ZADD RECALL:HOT:INDEX 93.8 100010
ZADD RECALL:HOT:INDEX 93.2 100016
ZADD RECALL:HOT:INDEX 92.5 100012
ZADD RECALL:HOT:INDEX 91.8 100018
ZADD RECALL:HOT:INDEX 91.2 100007
ZADD RECALL:HOT:INDEX 90.5 100014
ZADD RECALL:HOT:INDEX 90.0 100020
ZADD RECALL:HOT:INDEX 89.8 100004
ZADD RECALL:HOT:INDEX 89.2 100017
ZADD RECALL:HOT:INDEX 88.5 100008
ZADD RECALL:HOT:INDEX 87.8 100005
ZADD RECALL:HOT:INDEX 87.0 100002
ZUNIONSTORE RECALL:HOT_DEFAULT:0 1 RECALL:HOT:INDEX
EOF

# 2. 精选视频索引
echo "✓ 初始化精选视频索引..."
redis-cli -h $REDIS_HOST -p $REDIS_PORT -a $REDIS_PASS 2>/dev/null << EOF
DEL RECALL:SELECTION:INDEX
SADD RECALL:SELECTION:INDEX 100001
SADD RECALL:SELECTION:INDEX 100011
SADD RECALL:SELECTION:INDEX 100015
SADD RECALL:SELECTION:INDEX 100019
EOF

# 3. I2I 相似视频索引
echo "✓ 初始化 I2I 相似视频索引..."
redis-cli -h $REDIS_HOST -p $REDIS_PORT -a $REDIS_PASS 2>/dev/null << EOF
# 100001 (MMD视频) 的相似视频
DEL RECALL:I2I:100001
ZADD RECALL:I2I:100001 0.95 100002
ZADD RECALL:I2I:100001 0.92 100004
ZADD RECALL:I2I:100001 0.85 100005
ZADD RECALL:I2I:100001 0.80 100006

# 100002 (手书视频) 的相似视频
DEL RECALL:I2I:100002
ZADD RECALL:I2I:100002 0.95 100001
ZADD RECALL:I2I:100002 0.90 100004
ZADD RECALL:I2I:100002 0.82 100005

# 100003 (我的世界) 的相似视频
DEL RECALL:I2I:100003
ZADD RECALL:I2I:100003 0.92 100007
ZADD RECALL:I2I:100003 0.88 100008
ZADD RECALL:I2I:100003 0.85 100009

# 100009 (原神) 的相似视频
DEL RECALL:I2I:100009
ZADD RECALL:I2I:100009 0.90 100010
ZADD RECALL:I2I:100009 0.85 100003
ZADD RECALL:I2I:100009 0.80 100007

# 100011 (钢琴) 的相似视频
DEL RECALL:I2I:100011
ZADD RECALL:I2I:100011 0.88 100012
ZADD RECALL:I2I:100011 0.85 100001
ZADD RECALL:I2I:100011 0.82 100002

# 100015 (科普) 的相似视频
DEL RECALL:I2I:100015
ZADD RECALL:I2I:100015 0.90 100016
ZADD RECALL:I2I:100015 0.85 100013
ZADD RECALL:I2I:100015 0.80 100014
EOF

# 4. 标签热门视频索引 (按 tag_id)
echo "✓ 初始化标签视频索引..."
redis-cli -h $REDIS_HOST -p $REDIS_PORT -a $REDIS_PASS 2>/dev/null << EOF
# tag_id 1 - MMD
DEL RECALL:HOT_T:1
ZADD RECALL:HOT_T:1 95.0 100001
ZADD RECALL:HOT_T:1 94.0 100002
ZADD RECALL:HOT_T:1 93.0 100004

# tag_id 2 - 初音未来
DEL RECALL:HOT_T:2
ZADD RECALL:HOT_T:2 96.0 100001
ZADD RECALL:HOT_T:2 92.0 100004

# tag_id 5 - 我的世界
DEL RECALL:HOT_T:5
ZADD RECALL:HOT_T:5 97.0 100003
ZADD RECALL:HOT_T:5 93.0 100007
ZADD RECALL:HOT_T:5 90.0 100008

# tag_id 101 - VOCALOID
DEL RECALL:HOT_T:101
ZADD RECALL:HOT_T:101 96.0 100001
ZADD RECALL:HOT_T:101 94.0 100002

# tag_id 114 - 原神
DEL RECALL:HOT_T:114
ZADD RECALL:HOT_T:114 95.0 100009
ZADD RECALL:HOT_T:114 92.0 100010

# tag_id 119 - 钢琴
DEL RECALL:HOT_T:119
ZADD RECALL:HOT_T:119 97.0 100011

# tag_id 131 - 科普
DEL RECALL:HOT_T:131
ZADD RECALL:HOT_T:131 96.0 100015

# tag_id 143 - 鬼畜
DEL RECALL:HOT_T:143
ZADD RECALL:HOT_T:143 98.0 100019
ZADD RECALL:HOT_T:143 95.0 100020
EOF

# 5. UP主视频索引
echo "✓ 初始化 UP 主视频索引..."
CURRENT_TIME=$(date +%s)
redis-cli -h $REDIS_HOST -p $REDIS_PORT -a $REDIS_PASS 2>/dev/null << EOF
# UP主 1001 (动画区)
DEL RECALL:HOT_UP:1001
ZADD RECALL:HOT_UP:1001 $CURRENT_TIME 100001
ZADD RECALL:HOT_UP:1001 $((CURRENT_TIME - 86400)) 100002
ZADD RECALL:HOT_UP:1001 $((CURRENT_TIME - 172800)) 100004

# UP主 1002 (游戏区)
DEL RECALL:HOT_UP:1002
ZADD RECALL:HOT_UP:1002 $CURRENT_TIME 100003
ZADD RECALL:HOT_UP:1002 $((CURRENT_TIME - 86400)) 100007
ZADD RECALL:HOT_UP:1002 $((CURRENT_TIME - 172800)) 100008

# UP主 1003 (动画区)
DEL RECALL:HOT_UP:1003
ZADD RECALL:HOT_UP:1003 $CURRENT_TIME 100005
ZADD RECALL:HOT_UP:1003 $((CURRENT_TIME - 86400)) 100006

# UP主 1004 (游戏区-原神)
DEL RECALL:HOT_UP:1004
ZADD RECALL:HOT_UP:1004 $CURRENT_TIME 100009
ZADD RECALL:HOT_UP:1004 $((CURRENT_TIME - 86400)) 100010

# UP主 1005 (音乐区)
DEL RECALL:HOT_UP:1005
ZADD RECALL:HOT_UP:1005 $CURRENT_TIME 100011
ZADD RECALL:HOT_UP:1005 $((CURRENT_TIME - 86400)) 100012

# UP主 1006 (生活区)
DEL RECALL:HOT_UP:1006
ZADD RECALL:HOT_UP:1006 $CURRENT_TIME 100013
ZADD RECALL:HOT_UP:1006 $((CURRENT_TIME - 86400)) 100014

# UP主 1007 (知识区)
DEL RECALL:HOT_UP:1007
ZADD RECALL:HOT_UP:1007 $CURRENT_TIME 100015
ZADD RECALL:HOT_UP:1007 $((CURRENT_TIME - 86400)) 100016

# UP主 1008 (时尚区)
DEL RECALL:HOT_UP:1008
ZADD RECALL:HOT_UP:1008 $CURRENT_TIME 100017
ZADD RECALL:HOT_UP:1008 $((CURRENT_TIME - 86400)) 100018

# UP主 1009 (鬼畜区)
DEL RECALL:HOT_UP:1009
ZADD RECALL:HOT_UP:1009 $CURRENT_TIME 100019
ZADD RECALL:HOT_UP:1009 $((CURRENT_TIME - 86400)) 100020
EOF

# 6. 布隆过滤器 (用户观看历史)
echo "✓ 初始化布隆过滤器..."
redis-cli -h $REDIS_HOST -p $REDIS_PORT -a $REDIS_PASS 2>/dev/null << EOF
# 用户 1001 的观看历史
DEL RECALL:BLOOM:1001
SADD RECALL:BLOOM:1001 100001
SADD RECALL:BLOOM:1001 100002

# 用户 1002 的观看历史
DEL RECALL:BLOOM:1002
SADD RECALL:BLOOM:1002 100003
SADD RECALL:BLOOM:1002 100007

# 用户 1003 的观看历史
DEL RECALL:BLOOM:1003
SADD RECALL:BLOOM:1003 100011
SADD RECALL:BLOOM:1003 100012
EOF

# 7. 随机召回索引 (新发布视频)
echo "✓ 初始化随机召回索引..."
redis-cli -h $REDIS_HOST -p $REDIS_PORT -a $REDIS_PASS 2>/dev/null << EOF
# 动画标签的新视频
DEL RECALL:T:动画
ZADD RECALL:T:动画 $CURRENT_TIME 100001
ZADD RECALL:T:动画 $((CURRENT_TIME - 86400)) 100002
ZADD RECALL:T:动画 $((CURRENT_TIME - 172800)) 100005

# 游戏标签的新视频
DEL RECALL:T:游戏
ZADD RECALL:T:游戏 $CURRENT_TIME 100009
ZADD RECALL:T:游戏 $((CURRENT_TIME - 86400)) 100010
ZADD RECALL:T:游戏 $((CURRENT_TIME - 172800)) 100003

# 音乐标签的新视频
DEL RECALL:T:音乐
ZADD RECALL:T:音乐 $CURRENT_TIME 100011
ZADD RECALL:T:音乐 $((CURRENT_TIME - 86400)) 100012

# 知识标签的新视频
DEL RECALL:T:知识
ZADD RECALL:T:知识 $CURRENT_TIME 100015
ZADD RECALL:T:知识 $((CURRENT_TIME - 86400)) 100016
EOF

echo "✅ Redis 推荐系统测试数据初始化完成！"
echo ""
echo "========================================"
echo "数据统计："
echo "========================================"
redis-cli -h $REDIS_HOST -p $REDIS_PORT -a $REDIS_PASS 2>/dev/null << EOF
ECHO "热门视频数量:"
ZCARD RECALL:HOT:INDEX
ECHO "精选视频数量:"
SCARD RECALL:SELECTION:INDEX
ECHO "I2I索引数量:"
KEYS RECALL:I2I:* | wc -l
ECHO "标签索引数量:"
KEYS RECALL:HOT_T:* | wc -l
ECHO "UP主索引数量:"
KEYS RECALL:HOT_UP:* | wc -l
EOF
echo "========================================"

